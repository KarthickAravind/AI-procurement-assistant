<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Phase 3 - Backend Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { background: #0070f3; color: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .actions { margin: 20px 0; }
        .actions button { margin: 5px; padding: 10px 15px; background: #0070f3; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .actions button:hover { background: #0051cc; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; }
        .status-low { color: #d32f2f; font-weight: bold; }
        .status-normal { color: #2e7d32; font-weight: bold; }
        .status-overstock { color: #f57c00; font-weight: bold; }
        .loading { text-align: center; padding: 40px; color: #666; }
        .error { color: #d32f2f; padding: 20px; background: #ffebee; border-radius: 4px; margin: 20px 0; }
        .success { color: #2e7d32; padding: 20px; background: #e8f5e8; border-radius: 4px; margin: 20px 0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéâ Phase 3: Warehouse Management - LIVE TEST</h1>
            <p>Testing real-time CRUD operations with backend database</p>
        </div>

        <div class="actions">
            <button onclick="loadMaterials()">üîÑ Load Materials</button>
            <button onclick="exportMaterials()">üì• Export CSV</button>
            <button onclick="testAddMaterial()">‚ûï Test Add Material</button>
            <button onclick="searchMaterials('aluminum')">üîç Search "Aluminum"</button>
            <button onclick="clearResults()">üóëÔ∏è Clear</button>
        </div>

        <div id="status" class="loading">Ready to test Phase 3 functionality...</div>
        
        <div id="results"></div>
    </div>

    <script>
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'loading';
            statusDiv.innerHTML = message;
        }

        function showResults(html) {
            document.getElementById('results').innerHTML = html;
        }

        function clearResults() {
            showResults('');
            showStatus('Results cleared');
        }

        async function loadMaterials() {
            showStatus('Loading materials from backend...', 'info');
            
            try {
                const response = await fetch('/odata/v4/procurement/Materials');
                const data = await response.json();
                
                if (data.value) {
                    const materials = data.value;
                    showStatus(`‚úÖ Successfully loaded ${materials.length} materials from database`, 'success');
                    
                    let tableHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>Material ID</th>
                                    <th>Name</th>
                                    <th>Supplier</th>
                                    <th>Quantity</th>
                                    <th>Status</th>
                                    <th>Category</th>
                                    <th>Unit Price</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;
                    
                    materials.forEach(material => {
                        const statusClass = material.stockStatus === 'Low Stock' ? 'status-low' : 
                                          material.stockStatus === 'Overstock' ? 'status-overstock' : 'status-normal';
                        
                        tableHTML += `
                            <tr>
                                <td>${material.ID}</td>
                                <td><strong>${material.name}</strong></td>
                                <td>${material.supplier_ID}</td>
                                <td>${material.quantity} ${material.unit || 'pcs'}</td>
                                <td class="${statusClass}">${material.stockStatus || 'Normal'}</td>
                                <td>${material.category || 'N/A'}</td>
                                <td>${material.currency_code || '‚Çπ'}${material.unitPrice || 'N/A'}</td>
                                <td>
                                    <button onclick="deleteMaterial('${material.ID}')" style="background: #d32f2f; padding: 5px 10px; font-size: 12px;">Delete</button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    tableHTML += '</tbody></table>';
                    showResults(tableHTML);
                } else {
                    showStatus('‚ùå No materials found in response', 'error');
                }
            } catch (error) {
                console.error('Error loading materials:', error);
                showStatus(`‚ùå Error loading materials: ${error.message}`, 'error');
            }
        }

        async function exportMaterials() {
            showStatus('Exporting materials to CSV...', 'info');
            
            try {
                const response = await fetch('/odata/v4/procurement/exportMaterialsToCSV', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                
                const data = await response.json();
                
                if (data.csvData) {
                    // Create download link
                    const element = document.createElement('a');
                    element.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(data.csvData));
                    element.setAttribute('download', 'materials_export.csv');
                    element.style.display = 'none';
                    document.body.appendChild(element);
                    element.click();
                    document.body.removeChild(element);
                    
                    showStatus('‚úÖ Materials exported successfully! Download started.', 'success');
                } else {
                    showStatus('‚ùå Export failed - no CSV data received', 'error');
                }
            } catch (error) {
                console.error('Error exporting materials:', error);
                showStatus(`‚ùå Export error: ${error.message}`, 'error');
            }
        }

        async function testAddMaterial() {
            showStatus('Testing add material functionality...', 'info');
            
            const testMaterial = {
                ID: 'TEST' + Date.now(),
                name: 'Test Material ' + Date.now(),
                supplier: '9001', // Using existing supplier
                quantity: 100,
                category: 'Test Category',
                unitPrice: 999.99,
                unit: 'pcs',
                description: 'Test material added via Phase 3 functionality'
            };
            
            try {
                const response = await fetch('/odata/v4/procurement/addMaterial', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testMaterial)
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showStatus(`‚úÖ Test material added successfully! ID: ${testMaterial.ID}`, 'success');
                    // Reload materials to show the new one
                    setTimeout(() => loadMaterials(), 1000);
                } else {
                    showStatus(`‚ùå Add material failed: ${result.error || 'Unknown error'}`, 'error');
                }
            } catch (error) {
                console.error('Error adding test material:', error);
                showStatus(`‚ùå Add material error: ${error.message}`, 'error');
            }
        }

        async function searchMaterials(query) {
            showStatus(`Searching for materials containing "${query}"...`, 'info');
            
            try {
                const searchUrl = `/odata/v4/procurement/Materials?$filter=contains(tolower(name),'${query.toLowerCase()}') or contains(tolower(ID),'${query.toLowerCase()}')`;
                const response = await fetch(searchUrl);
                const data = await response.json();
                
                if (data.value) {
                    const materials = data.value;
                    showStatus(`‚úÖ Search completed: Found ${materials.length} materials matching "${query}"`, 'success');
                    
                    if (materials.length > 0) {
                        let tableHTML = `
                            <h3>Search Results for "${query}":</h3>
                            <table>
                                <thead>
                                    <tr><th>ID</th><th>Name</th><th>Supplier</th><th>Quantity</th><th>Status</th></tr>
                                </thead>
                                <tbody>
                        `;
                        
                        materials.forEach(material => {
                            const statusClass = material.stockStatus === 'Low Stock' ? 'status-low' : 
                                              material.stockStatus === 'Overstock' ? 'status-overstock' : 'status-normal';
                            
                            tableHTML += `
                                <tr>
                                    <td>${material.ID}</td>
                                    <td><strong>${material.name}</strong></td>
                                    <td>${material.supplier_ID}</td>
                                    <td>${material.quantity} ${material.unit || 'pcs'}</td>
                                    <td class="${statusClass}">${material.stockStatus || 'Normal'}</td>
                                </tr>
                            `;
                        });
                        
                        tableHTML += '</tbody></table>';
                        showResults(tableHTML);
                    } else {
                        showResults('<p>No materials found matching your search.</p>');
                    }
                } else {
                    showStatus('‚ùå Search failed - no data received', 'error');
                }
            } catch (error) {
                console.error('Error searching materials:', error);
                showStatus(`‚ùå Search error: ${error.message}`, 'error');
            }
        }

        async function deleteMaterial(materialId) {
            if (!confirm(`Are you sure you want to delete material ${materialId}?`)) {
                return;
            }
            
            showStatus(`Deleting material ${materialId}...`, 'info');
            
            try {
                const response = await fetch(`/odata/v4/procurement/Materials('${materialId}')`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showStatus(`‚úÖ Material ${materialId} deleted successfully!`, 'success');
                    // Reload materials to reflect the deletion
                    setTimeout(() => loadMaterials(), 1000);
                } else {
                    showStatus(`‚ùå Delete failed for material ${materialId}`, 'error');
                }
            } catch (error) {
                console.error('Error deleting material:', error);
                showStatus(`‚ùå Delete error: ${error.message}`, 'error');
            }
        }

        // Auto-load materials when page loads
        window.addEventListener('load', function() {
            setTimeout(() => {
                loadMaterials();
            }, 1000);
        });
    </script>
</body>
</html>
