<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Procurement Assistant</title>
    <script
        id="sap-ui-bootstrap"
        src="https://ui5.sap.com/resources/sap-ui-core.js"
        data-sap-ui-theme="sap_horizon"
        data-sap-ui-libs="sap.m,sap.f"
        data-sap-ui-compatVersion="edge"
        data-sap-ui-async="true">
    </script>
    <link rel="stylesheet" type="text/css" href="css/style.css">
</head>
<body class="sapUiBody">
    <div id="content"></div>
    
    <script>
        sap.ui.getCore().attachInit(function() {
            console.log("UI5 Core initialized successfully");
            
            var oApp; // Declare app variable
            
            // Create Welcome Page
            var oWelcomePage = new sap.m.Page({
                id: "welcomePage",
                title: "AI-Powered Procurement Assistant",
                showNavButton: false,
                content: [
                    new sap.m.VBox({
                        alignItems: "Center",
                        justifyContent: "Center",
                        class: "welcomeContainer",
                        items: [
                            new sap.m.Title({
                                text: "AI-Powered Procurement Assistant",
                                class: "welcomeTitle sapUiMediumMarginBottom"
                            }),
                            new sap.m.Text({
                                text: "I'm here to help",
                                class: "welcomeSubtitle sapUiMediumMarginBottom"
                            }),
                            new sap.m.Text({
                                text: "Your intelligent assistant for procurement and warehouse management",
                                class: "welcomeDescription sapUiLargeMarginBottom"
                            }),
                            new sap.m.Button({
                                text: "Get Started",
                                type: "Emphasized",
                                icon: "sap-icon://forward",
                                class: "sapUiLargeMarginTop",
                                press: function() {
                                    console.log("Get Started button pressed");
                                    oApp.to("mainPage");
                                }
                            })
                        ]
                    })
                ]
            });
            
            // Create Main Page
            var oMainPage = new sap.m.Page({
                id: "mainPage",
                title: "Procurement Assistant",
                showNavButton: true,
                navButtonPress: function() {
                    console.log("Back button pressed");
                    oApp.back();
                },
                content: [
                    new sap.m.SplitContainer({
                        height: "calc(100vh - 120px)",
                        masterPages: [
                            new sap.m.Page({
                                title: "AI Chat Assistant",
                                content: [
                                    new sap.m.VBox({
                                        height: "100%",
                                        class: "sapUiMediumMargin",
                                        items: [
                                            // Quick Action Buttons
                                            new sap.m.Panel({
                                                headerText: "Quick Actions",
                                                class: "sapUiMediumMarginBottom",
                                                content: [
                                                    new sap.m.HBox({
                                                        wrap: "Wrap",
                                                        justifyContent: "End",
                                                        class: "sapUiSmallMargin",
                                                        items: [
                                                            new sap.m.Button({
                                                                text: "Create PO",
                                                                icon: "sap-icon://create-form",
                                                                type: "Emphasized",
                                                                class: "sapUiTinyMarginBegin sapUiTinyMarginTop",
                                                                press: function() {
                                                                    addChatMessage("I'll help you create a Purchase Order. What materials do you need?", "assistant");
                                                                    sap.m.MessageToast.show("PO creation workflow started!");
                                                                }
                                                            }),
                                                            new sap.m.Button({
                                                                text: "Send RFQ",
                                                                icon: "sap-icon://email",
                                                                type: "Emphasized",
                                                                class: "sapUiTinyMarginBegin sapUiTinyMarginTop",
                                                                press: function() {
                                                                    addChatMessage("I'll help you send a Request for Quotation. Which suppliers should I contact?", "assistant");
                                                                    sap.m.MessageToast.show("RFQ workflow started!");
                                                                }
                                                            }),
                                                            new sap.m.Button({
                                                                text: "Find Suppliers",
                                                                icon: "sap-icon://supplier",
                                                                type: "Default",
                                                                class: "sapUiTinyMarginBegin sapUiTinyMarginTop",
                                                                press: function() {
                                                                    addChatMessage("I'll help you find the best suppliers. What type of materials are you looking for?", "assistant");
                                                                }
                                                            }),
                                                            new sap.m.Button({
                                                                text: "Check Inventory",
                                                                icon: "sap-icon://inventory",
                                                                type: "Default",
                                                                class: "sapUiTinyMarginBegin sapUiTinyMarginTop",
                                                                press: function() {
                                                                    addChatMessage("Here's your current inventory status. Which materials would you like to check?", "assistant");
                                                                }
                                                            })
                                                        ]
                                                    })
                                                ]
                                            }),
                                            // Chat Messages Area
                                            new sap.m.ScrollContainer({
                                                id: "chatScrollContainer",
                                                height: "450px",
                                                vertical: true,
                                                class: "sapUiMediumMarginBottom",
                                                content: [
                                                    new sap.m.VBox({
                                                        id: "chatMessagesContainer",
                                                        items: [
                                                            new sap.m.MessageStrip({
                                                                text: "ðŸ‘‹ Hello! I'm your AI procurement assistant. I can help you with suppliers, materials, pricing, and procurement processes.",
                                                                type: "Information",
                                                                class: "sapUiMediumMarginBottom"
                                                            }),
                                                            new sap.m.MessageStrip({
                                                                text: "ðŸ’¡ Try the quick action buttons above or ask me anything!",
                                                                type: "Success",
                                                                class: "sapUiMediumMarginBottom"
                                                            })
                                                        ]
                                                    })
                                                ]
                                            }),
                                            // Chat Input Area
                                            new sap.m.VBox({
                                                items: [
                                                    new sap.m.HBox({
                                                        width: "100%",
                                                        items: [
                                                            new sap.m.TextArea({
                                                                id: "chatInput",
                                                                placeholder: "Type your message here... (e.g., 'Find laptops under â‚¹50K')",
                                                                width: "100%",
                                                                rows: 3,
                                                                maxLength: 1000,
                                                                growing: false,
                                                                growingMaxLines: 5,
                                                                class: "sapUiMediumMarginBottom",
                                                                wrapping: "Soft",
                                                                showExceededText: true,
                                                                valueLiveUpdate: true
                                                            }).addStyleClass("chatInputTextArea"),
                                                            new sap.m.Button({
                                                                text: "Send",
                                                                type: "Emphasized",
                                                                icon: "sap-icon://paper-plane",
                                                                class: "sapUiTinyMarginBegin",
                                                                press: function() {
                                                                    sendChatMessage();
                                                                }
                                                            })
                                                        ]
                                                    }),
                                                    // Suggested Questions
                                                    new sap.m.Panel({
                                                        headerText: "ðŸ’¬ Suggested Questions",
                                                        expandable: true,
                                                        expanded: false,
                                                        class: "sapUiSmallMarginTop",
                                                        content: [
                                                            new sap.m.VBox({
                                                                class: "sapUiSmallMargin",
                                                                items: [
                                                                    new sap.m.Link({
                                                                        text: "â€¢ What suppliers can deliver laptops under â‚¹50K within 10 days?",
                                                                        press: function() {
                                                                            fillChatInput("What suppliers can deliver laptops under â‚¹50K within 10 days?");
                                                                        }
                                                                    }),
                                                                    new sap.m.Link({
                                                                        text: "â€¢ Draft a purchase order for 500 units of office chairs",
                                                                        press: function() {
                                                                            fillChatInput("Draft a purchase order for 500 units of office chairs");
                                                                        }
                                                                    }),
                                                                    new sap.m.Link({
                                                                        text: "â€¢ Are there any compliance issues with supplier contracts?",
                                                                        press: function() {
                                                                            fillChatInput("Are there any compliance issues with supplier contracts?");
                                                                        }
                                                                    }),
                                                                    new sap.m.Link({
                                                                        text: "â€¢ Show me the top 3 suppliers with best ratings",
                                                                        press: function() {
                                                                            fillChatInput("Show me the top 3 suppliers with best ratings");
                                                                        }
                                                                    })
                                                                ]
                                                            })
                                                        ]
                                                    })
                                                ]
                                            })
                                        ]
                                    })
                                ]
                            })
                        ],
                        detailPages: [
                            new sap.m.Page({
                                title: "Warehouse Management",
                                content: [
                                    new sap.m.VBox({
                                        class: "sapUiMediumMargin",
                                        items: [

                                            // Phase 3: Search Bar with Real Functionality
                                            new sap.m.SearchField({
                                                id: "materialSearchField",
                                                placeholder: "Search materials by name, ID, or supplier...",
                                                width: "100%",
                                                class: "sapUiMediumMarginBottom",
                                                search: function(oEvent) {
                                                    var query = oEvent.getParameter("query");
                                                    searchMaterials(query);
                                                }
                                            }),
                                            // Phase 3: Real Materials Table with Backend Data
                                            new sap.m.ScrollContainer({
                                                horizontal: true,
                                                vertical: true,
                                                height: "400px",
                                                width: "100%",
                                                content: [
                                                    new sap.m.Table({
                                                id: "materialsTable",
                                                width: "100%",
                                                fixedLayout: false,
                                                mode: "None",
                                                headerToolbar: new sap.m.Toolbar({
                                                    content: [
                                                        new sap.m.Title({
                                                            text: "Materials Inventory",
                                                            level: "H4"
                                                        }),
                                                        new sap.m.ToolbarSpacer(),
                                                        // Phase 3: Action Buttons
                                                        new sap.m.Button({
                                                            text: "Add Material",
                                                            type: "Emphasized",
                                                            icon: "sap-icon://add",
                                                            press: function() {
                                                                openAddMaterialDialog();
                                                            }
                                                        }),

                                                        new sap.m.Button({
                                                            text: "Export",
                                                            icon: "sap-icon://upload",
                                                            press: function() {
                                                                exportMaterials();
                                                            }
                                                        }),

                                                        new sap.m.Button({
                                                            text: "Refresh",
                                                            icon: "sap-icon://refresh",
                                                            press: function() {
                                                                loadMaterials();
                                                            }
                                                        }),
                                                        new sap.m.Text({
                                                            id: "materialsCount",
                                                            text: "Loading..."
                                                        })
                                                    ]
                                                }),
                                                columns: [
                                                    new sap.m.Column({
                                                        header: new sap.m.Text({text: "Material ID"})
                                                    }),
                                                    new sap.m.Column({
                                                        header: new sap.m.Text({text: "Name"})
                                                    }),
                                                    new sap.m.Column({
                                                        header: new sap.m.Text({text: "Supplier ID"})
                                                    }),
                                                    new sap.m.Column({
                                                        header: new sap.m.Text({text: "Quantity"})
                                                    }),
                                                    new sap.m.Column({
                                                        header: new sap.m.Text({text: "Actions"}),
                                                        minScreenWidth: "Tablet",
                                                        demandPopin: false,
                                                        width: "120px"
                                                    })
                                                ]
                                            })
                                        ]
                                    })
                                ]
                            })
                                ]
                            })
                        ]
                    })
                ]
            });
            
            // Create app
            oApp = new sap.m.App({
                pages: [oWelcomePage, oMainPage]
            });
            
            // Place app in DOM
            oApp.placeAt("content");

            console.log("App created and placed in DOM successfully");

            // Initialize chat session after app is loaded
            setTimeout(function() {
                window.initializeChatSession();

                // Add keyboard event handler for TextArea
                var oInput = sap.ui.getCore().byId("chatInput");
                if (oInput) {
                    oInput.attachBrowserEvent("keydown", function(e) {
                        if (e.key === "Enter" && !e.shiftKey) {
                            e.preventDefault();
                            sendChatMessage();
                        }
                    });
                }
            }, 1000);

            // Phase 4: Real AI Chat functionality with Gemini
            window.chatSessionId = null;

            // Initialize chat session on page load
            window.initializeChatSession = function() {
                console.log("Initializing chat session...");

                fetch('http://localhost:4005/odata/v4/procurement/initChatSession', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    console.log("Chat session initialized:", data);
                    window.chatSessionId = data.sessionId;

                    // Add welcome message
                    if (data.welcomeMessage) {
                        addChatMessage(data.welcomeMessage, "assistant");
                    }
                })
                .catch(error => {
                    console.error("Error initializing chat session:", error);
                    addChatMessage("Welcome! I'm your AI procurement assistant. How can I help you today?", "assistant");
                });
            };

            window.sendChatMessage = function() {
                var oInput = sap.ui.getCore().byId("chatInput");
                var sMessage = oInput.getValue().trim();

                if (!sMessage) {
                    sap.m.MessageToast.show("Please enter a message");
                    return;
                }

                // Add user message
                addChatMessage(sMessage, "user");

                // Clear input
                oInput.setValue("");

                // Show typing indicator
                var typingMessage = addChatMessage("ðŸ¤– Assistant is typing...", "typing");

                // Send message to Gemini AI
                if (!window.chatSessionId) {
                    console.warn("No chat session, initializing...");
                    window.initializeChatSession();
                    setTimeout(() => window.sendMessageToAI(sMessage, typingMessage), 1000);
                } else {
                    window.sendMessageToAI(sMessage, typingMessage);
                }
            };

            window.sendMessageToAI = function(message, typingMessage) {
                fetch('http://localhost:4005/odata/v4/procurement/sendChatMessage', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        sessionId: window.chatSessionId,
                        message: message
                    })
                })
                .then(response => response.json())
                .then(data => {
                    console.log("AI response received:", data);

                    // Remove typing indicator
                    if (typingMessage) {
                        var oContainer = sap.ui.getCore().byId("chatMessagesContainer");
                        oContainer.removeItem(typingMessage);
                    }

                    if (data.success && data.response) {
                        addChatMessage(data.response, "assistant");
                    } else if (data.fallbackResponse) {
                        addChatMessage(data.fallbackResponse, "assistant");
                    } else {
                        addChatMessage("I apologize, but I'm having trouble right now. Please try again.", "assistant");
                    }
                })
                .catch(error => {
                    console.error("Error sending message to AI:", error);

                    // Remove typing indicator
                    if (typingMessage) {
                        var oContainer = sap.ui.getCore().byId("chatMessagesContainer");
                        oContainer.removeItem(typingMessage);
                    }

                    // Fallback to smart response
                    var response = generateSmartResponse(message);
                    addChatMessage(response, "assistant");
                });
            };

            window.fillChatInput = function(text) {
                var oInput = sap.ui.getCore().byId("chatInput");
                oInput.setValue(text);
                oInput.focus();
            };

            window.addChatMessage = function(message, type) {
                var oContainer = sap.ui.getCore().byId("chatMessagesContainer");
                var messageType, messageIcon;

                if (type === "user") {
                    messageType = "Success";
                    messageIcon = "ðŸ‘¤ You: ";
                } else if (type === "typing") {
                    messageType = "None";
                    messageIcon = "";
                } else {
                    messageType = "Information";
                    messageIcon = "ðŸ¤– Assistant: ";
                }

                var oMessage = new sap.m.MessageStrip({
                    text: messageIcon + message,
                    type: messageType,
                    class: "sapUiMediumMarginBottom"
                });

                oContainer.addItem(oMessage);

                // Scroll to bottom
                setTimeout(function() {
                    var oScrollContainer = sap.ui.getCore().byId("chatScrollContainer");
                    if (oScrollContainer) {
                        oScrollContainer.scrollToElement(oMessage);
                    }
                }, 100);

                return oMessage; // Return message for removal if needed
            };

            window.generateSmartResponse = function(userMessage) {
                var message = userMessage.toLowerCase();

                if (message.includes("laptop") || message.includes("computer")) {
                    return "I found 3 suppliers for laptops:\nâ€¢ TechCorp India - â‚¹42,000/unit, 7 days delivery\nâ€¢ Digital Solutions - â‚¹48,500/unit, 5 days delivery\nâ€¢ CompuWorld - â‚¹45,200/unit, 10 days delivery\n\nWould you like me to create a PO or send RFQ?";
                } else if (message.includes("chair") || message.includes("furniture")) {
                    return "For office chairs, I recommend:\nâ€¢ Furniture Plus - â‚¹8,200/unit, 12 days delivery\nâ€¢ Office Comfort - â‚¹7,800/unit, 15 days delivery\nâ€¢ Ergo Solutions - â‚¹9,500/unit, 8 days delivery\n\nShall I draft a purchase order?";
                } else if (message.includes("supplier") || message.includes("vendor")) {
                    return "Here are our top-rated suppliers:\nðŸ† TechCorp India (4.8/5) - Electronics\nðŸ† Furniture Plus (4.6/5) - Office Furniture\nðŸ† Stationery World (4.7/5) - Office Supplies\n\nWhich category interests you?";
                } else if (message.includes("po") || message.includes("purchase order")) {
                    return "I'll help you create a Purchase Order! Please provide:\nâ€¢ Material/Product needed\nâ€¢ Quantity required\nâ€¢ Preferred supplier\nâ€¢ Delivery timeline\n\nOr use the 'Create PO' quick action button above.";
                } else if (message.includes("rfq") || message.includes("quotation")) {
                    return "I'll help you send an RFQ! I need:\nâ€¢ Product specifications\nâ€¢ Required quantity\nâ€¢ Delivery location\nâ€¢ Timeline requirements\n\nShall I prepare the RFQ template?";
                } else {
                    return "I understand you're asking about: '" + userMessage + "'. I can help with:\nâ€¢ Finding suppliers and pricing\nâ€¢ Creating purchase orders\nâ€¢ Sending RFQs\nâ€¢ Checking inventory\nâ€¢ Compliance verification\n\nTry using the quick action buttons above or ask me something specific!";
                }
            };

            // Phase 3: Real Backend Integration Functions
            window.loadMaterials = function() {
                console.log("Loading materials from backend...");

                fetch('http://localhost:4005/odata/v4/procurement/Materials')
                    .then(response => response.json())
                    .then(data => {
                        console.log("Materials loaded:", data);
                        var materials = data.value || [];

                        // Update count
                        var countText = sap.ui.getCore().byId("materialsCount");
                        if (countText) {
                            countText.setText("Total: " + materials.length + " items");
                        }

                        // Update table
                        var table = sap.ui.getCore().byId("materialsTable");
                        if (table) {
                            table.removeAllItems();

                            console.log("Creating table items for", materials.length, "materials");
                            materials.forEach(function(material) {
                                console.log("Creating item for material:", material.ID, material.name);
                                var statusState = material.stockStatus === "Low Stock" ? "Error" :
                                                material.stockStatus === "Overstock" ? "Warning" : "Success";

                                var item = new sap.m.ColumnListItem({
                                    press: function() {
                                        sap.m.MessageToast.show("Selected: " + material.name);
                                    },
                                    cells: [
                                        new sap.m.Text({text: material.ID}),
                                        new sap.m.Text({text: material.name}),
                                        new sap.m.Text({text: material.supplier_ID || material.supplier || "N/A"}),
                                        new sap.m.Text({text: material.quantity + " " + (material.unit || "pcs")}),
                                        new sap.m.HBox({
                                            items: [
                                                new sap.m.Button({
                                                    icon: "sap-icon://delete",
                                                    type: "Transparent",
                                                    press: function() {
                                                        console.log("Delete button clicked for material:", material.ID, material.name);
                                                        if (confirm("Are you sure you want to delete '" + material.name + "'?")) {
                                                            console.log("User confirmed deletion");
                                                            deleteMaterial(material.ID, material.name);
                                                        }
                                                    }
                                                })
                                            ]
                                        })
                                    ]
                                });

                                console.log("Adding item to table for:", material.name);
                                table.addItem(item);
                            });
                            console.log("Finished adding all items to table");
                        }

                        sap.m.MessageToast.show("Materials loaded successfully!");
                    })
                    .catch(error => {
                        console.error("Error loading materials:", error);
                        sap.m.MessageToast.show("Error loading materials from backend");
                    });
            };

            window.exportMaterials = function() {
                fetch('http://localhost:4005/odata/v4/procurement/exportMaterialsToCSV', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.csvData) {
                        var element = document.createElement('a');
                        element.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(data.csvData));
                        element.setAttribute('download', 'materials_export.csv');
                        element.style.display = 'none';
                        document.body.appendChild(element);
                        element.click();
                        document.body.removeChild(element);
                        sap.m.MessageToast.show("Materials exported successfully!");
                    }
                })
                .catch(error => {
                    console.error("Error exporting materials:", error);
                    sap.m.MessageToast.show("Error exporting materials");
                });
            };



            window.searchMaterials = function(query) {
                if (!query || query.trim() === "") {
                    loadMaterials(); // Load all materials if no search query
                    return;
                }

                console.log("Searching materials for:", query);

                fetch('http://localhost:4005/odata/v4/procurement/Materials?$filter=contains(tolower(name),\'' + query.toLowerCase() + '\') or contains(tolower(ID),\'' + query.toLowerCase() + '\') or contains(tolower(supplier_ID),\'' + query.toLowerCase() + '\')')
                    .then(response => response.json())
                    .then(data => {
                        console.log("Search results:", data);
                        var materials = data.value || [];

                        // Update count
                        var countText = sap.ui.getCore().byId("materialsCount");
                        if (countText) {
                            countText.setText("Found: " + materials.length + " items");
                        }

                        // Update table
                        var table = sap.ui.getCore().byId("materialsTable");
                        if (table) {
                            table.removeAllItems();

                            if (materials.length === 0) {
                                var noDataItem = new sap.m.ColumnListItem({
                                    cells: [
                                        new sap.m.Text({text: "No materials found"}),
                                        new sap.m.Text({text: ""}),
                                        new sap.m.Text({text: ""}),
                                        new sap.m.Text({text: ""})
                                    ]
                                });
                                table.addItem(noDataItem);
                            } else {
                                materials.forEach(function(material) {
                                    var statusState = material.stockStatus === "Low Stock" ? "Error" :
                                                    material.stockStatus === "Overstock" ? "Warning" : "Success";

                                    var item = new sap.m.ColumnListItem({
                                        press: function() {
                                            sap.m.MessageToast.show("Selected: " + material.name);
                                        },
                                        cells: [
                                            new sap.m.Text({text: material.ID}),
                                            new sap.m.Text({text: material.name}),
                                            new sap.m.Text({text: material.supplier_ID || material.supplier || "N/A"}),
                                            new sap.m.Text({text: material.quantity + " " + (material.unit || "pcs")}),
                                            new sap.m.HBox({
                                                items: [
                                                    new sap.m.Button({
                                                        icon: "sap-icon://delete",
                                                        type: "Transparent",
                                                        press: function() {
                                                            console.log("Search delete button clicked for material:", material.ID, material.name);
                                                            if (confirm("Are you sure you want to delete '" + material.name + "'?")) {
                                                                console.log("User confirmed deletion from search");
                                                                deleteMaterial(material.ID, material.name);
                                                            }
                                                        }
                                                    })
                                                ]
                                            })
                                        ]
                                    });

                                    table.addItem(item);
                                });
                            }
                        }

                        sap.m.MessageToast.show("Search completed: " + materials.length + " results");
                    })
                    .catch(error => {
                        console.error("Error searching materials:", error);
                        sap.m.MessageToast.show("Error searching materials");
                    });
            };

            // Add Material Dialog - Modern Fiori Design
            function openAddMaterialDialog() {
                // Destroy existing dialog if it exists
                var existingDialog = sap.ui.getCore().byId("addMaterialDialog");
                if (existingDialog) {
                    existingDialog.destroy();
                }

                var dialog = new sap.m.Dialog({
                    id: "addMaterialDialog",
                    title: "Add New Material",
                    contentWidth: "500px",
                    contentHeight: "600px",
                    verticalScrolling: false,
                    horizontalScrolling: false,
                    content: [
                        new sap.ui.layout.form.SimpleForm({
                            editable: true,
                            layout: "ResponsiveGridLayout",
                            labelSpanXL: 4,
                            labelSpanL: 4,
                            labelSpanM: 4,
                            labelSpanS: 12,
                            adjustLabelSpan: false,
                            emptySpanXL: 0,
                            emptySpanL: 0,
                            emptySpanM: 0,
                            emptySpanS: 0,
                            columnsXL: 1,
                            columnsL: 1,
                            columnsM: 1,
                            singleContainerFullSize: false,
                            content: [
                                new sap.m.Label({text: "Material ID", required: true}),
                                new sap.m.Input({
                                    id: "addMaterialId",
                                    placeholder: "e.g., MAT001",
                                    required: true,
                                    valueState: "None"
                                }),

                                new sap.m.Label({text: "Material Name", required: true}),
                                new sap.m.Input({
                                    id: "addMaterialName",
                                    placeholder: "Enter material name",
                                    required: true,
                                    valueState: "None"
                                }),

                                new sap.m.Label({text: "Supplier ID", required: true}),
                                new sap.m.Input({
                                    id: "addMaterialSupplier",
                                    placeholder: "Enter supplier ID (e.g., 9001)",
                                    required: true,
                                    valueState: "None",
                                    type: "Number"
                                }),

                                new sap.m.Label({text: "Quantity", required: true}),
                                new sap.m.Input({
                                    id: "addMaterialQuantity",
                                    placeholder: "Enter quantity",
                                    type: "Number",
                                    required: true,
                                    valueState: "None"
                                }),

                                new sap.m.Label({text: "Unit"}),
                                new sap.m.ComboBox({
                                    id: "addMaterialUnit",
                                    placeholder: "Select unit",
                                    items: [
                                        new sap.ui.core.Item({key: "pcs", text: "Pieces"}),
                                        new sap.ui.core.Item({key: "kg", text: "Kilograms"}),
                                        new sap.ui.core.Item({key: "liters", text: "Liters"}),
                                        new sap.ui.core.Item({key: "meters", text: "Meters"}),
                                        new sap.ui.core.Item({key: "sheets", text: "Sheets"}),
                                        new sap.ui.core.Item({key: "bags", text: "Bags"}),
                                        new sap.ui.core.Item({key: "units", text: "Units"}),
                                        new sap.ui.core.Item({key: "panels", text: "Panels"}),
                                        new sap.ui.core.Item({key: "bars", text: "Bars"}),
                                        new sap.ui.core.Item({key: "sets", text: "Sets"})
                                    ],
                                    selectedKey: "pcs"
                                }),

                                new sap.m.Label({text: "Category"}),
                                new sap.m.ComboBox({
                                    id: "addMaterialCategory",
                                    placeholder: "Select category",
                                    items: [
                                        new sap.ui.core.Item({key: "General", text: "General"}),
                                        new sap.ui.core.Item({key: "Construction", text: "Construction"}),
                                        new sap.ui.core.Item({key: "Manufacturing", text: "Manufacturing"}),
                                        new sap.ui.core.Item({key: "Logistics", text: "Logistics"})
                                    ],
                                    selectedKey: "General"
                                })
                            ]
                        })
                    ],
                    beginButton: new sap.m.Button({
                        text: "Add Material",
                        type: "Emphasized",
                        icon: "sap-icon://add",
                        press: function() {
                            var id = sap.ui.getCore().byId("addMaterialId").getValue();
                            var name = sap.ui.getCore().byId("addMaterialName").getValue();
                            var supplier = sap.ui.getCore().byId("addMaterialSupplier").getValue();
                            var quantity = sap.ui.getCore().byId("addMaterialQuantity").getValue();
                            var unit = sap.ui.getCore().byId("addMaterialUnit").getSelectedKey();
                            var category = sap.ui.getCore().byId("addMaterialCategory").getSelectedKey();

                            if (id && name && supplier && quantity) {
                                addMaterial({
                                    ID: id,
                                    name: name,
                                    supplier: supplier,
                                    quantity: parseInt(quantity),
                                    unit: unit,
                                    category: category
                                });
                                dialog.close();
                                dialog.destroy();
                            } else {
                                sap.m.MessageToast.show("Please fill all required fields");
                            }
                        }
                    }),
                    endButton: new sap.m.Button({
                        text: "Cancel",
                        icon: "sap-icon://decline",
                        press: function() {
                            dialog.close();
                            dialog.destroy();
                        }
                    })
                });
                dialog.open();
            }

            // Edit Material Dialog - Modern Fiori Design
            function openEditMaterialDialog(material) {
                // Destroy existing dialog if it exists
                var existingDialog = sap.ui.getCore().byId("editMaterialDialog");
                if (existingDialog) {
                    existingDialog.destroy();
                }

                var dialog = new sap.m.Dialog({
                    id: "editMaterialDialog",
                    title: "Edit Material: " + material.name,
                    contentWidth: "500px",
                    contentHeight: "600px",
                    verticalScrolling: false,
                    horizontalScrolling: false,
                    content: [
                        new sap.ui.layout.form.SimpleForm({
                            editable: true,
                            layout: "ResponsiveGridLayout",
                            labelSpanXL: 4,
                            labelSpanL: 4,
                            labelSpanM: 4,
                            labelSpanS: 12,
                            adjustLabelSpan: false,
                            emptySpanXL: 0,
                            emptySpanL: 0,
                            emptySpanM: 0,
                            emptySpanS: 0,
                            columnsXL: 1,
                            columnsL: 1,
                            columnsM: 1,
                            singleContainerFullSize: false,
                            content: [
                                new sap.m.Label({text: "Material ID"}),
                                new sap.m.Input({
                                    id: "editMaterialId",
                                    value: material.ID,
                                    editable: false,
                                    valueState: "Information"
                                }),

                                new sap.m.Label({text: "Material Name", required: true}),
                                new sap.m.Input({
                                    id: "editMaterialName",
                                    value: material.name,
                                    required: true,
                                    valueState: "None"
                                }),

                                new sap.m.Label({text: "Supplier ID", required: true}),
                                new sap.m.Input({
                                    id: "editMaterialSupplier",
                                    value: (material.supplier_ID || material.supplier || "9001").toString(),
                                    required: true,
                                    valueState: "None",
                                    type: "Number"
                                }),

                                new sap.m.Label({text: "Quantity", required: true}),
                                new sap.m.Input({
                                    id: "editMaterialQuantity",
                                    value: material.quantity,
                                    type: "Number",
                                    required: true,
                                    valueState: "None"
                                }),

                                new sap.m.Label({text: "Unit"}),
                                new sap.m.ComboBox({
                                    id: "editMaterialUnit",
                                    selectedKey: material.unit || "pcs",
                                    items: [
                                        new sap.ui.core.Item({key: "pcs", text: "Pieces"}),
                                        new sap.ui.core.Item({key: "kg", text: "Kilograms"}),
                                        new sap.ui.core.Item({key: "liters", text: "Liters"}),
                                        new sap.ui.core.Item({key: "meters", text: "Meters"}),
                                        new sap.ui.core.Item({key: "sheets", text: "Sheets"}),
                                        new sap.ui.core.Item({key: "bags", text: "Bags"}),
                                        new sap.ui.core.Item({key: "units", text: "Units"}),
                                        new sap.ui.core.Item({key: "panels", text: "Panels"}),
                                        new sap.ui.core.Item({key: "bars", text: "Bars"}),
                                        new sap.ui.core.Item({key: "sets", text: "Sets"})
                                    ]
                                }),

                                new sap.m.Label({text: "Category"}),
                                new sap.m.ComboBox({
                                    id: "editMaterialCategory",
                                    selectedKey: material.category || "General",
                                    items: [
                                        new sap.ui.core.Item({key: "General", text: "General"}),
                                        new sap.ui.core.Item({key: "Construction", text: "Construction"}),
                                        new sap.ui.core.Item({key: "Manufacturing", text: "Manufacturing"}),
                                        new sap.ui.core.Item({key: "Logistics", text: "Logistics"})
                                    ]
                                })
                            ]
                        })
                    ],
                    beginButton: new sap.m.Button({
                        text: "Save Changes",
                        type: "Emphasized",
                        icon: "sap-icon://save",
                        press: function() {
                            var updatedMaterial = {
                                ID: material.ID,
                                name: sap.ui.getCore().byId("editMaterialName").getValue(),
                                supplier: sap.ui.getCore().byId("editMaterialSupplier").getValue(),
                                quantity: parseInt(sap.ui.getCore().byId("editMaterialQuantity").getValue()),
                                unit: sap.ui.getCore().byId("editMaterialUnit").getSelectedKey(),
                                category: sap.ui.getCore().byId("editMaterialCategory").getSelectedKey()
                            };
                            updateMaterial(updatedMaterial);
                            dialog.close();
                            dialog.destroy();
                        }
                    }),
                    endButton: new sap.m.Button({
                        text: "Delete Material",
                        type: "Reject",
                        icon: "sap-icon://delete",
                        press: function() {
                            sap.m.MessageBox.confirm(
                                "Are you sure you want to delete '" + material.name + "'?\n\nThis action cannot be undone.",
                                {
                                    title: "Confirm Delete",
                                    icon: sap.m.MessageBox.Icon.WARNING,
                                    actions: [sap.m.MessageBox.Action.DELETE, sap.m.MessageBox.Action.CANCEL],
                                    emphasizedAction: sap.m.MessageBox.Action.DELETE,
                                    onClose: function(action) {
                                        if (action === sap.m.MessageBox.Action.DELETE) {
                                            deleteMaterial(material.ID);
                                            dialog.close();
                                            dialog.destroy();
                                        }
                                    }
                                }
                            );
                        }
                    }),
                    buttons: [
                        new sap.m.Button({
                            text: "Cancel",
                            icon: "sap-icon://decline",
                            press: function() {
                                dialog.close();
                                dialog.destroy();
                            }
                        })
                    ]
                });
                dialog.open();
            }

            // Import CSV Dialog - Modern Fiori Design
            function openImportDialog() {
                // Destroy existing dialog if it exists
                var existingDialog = sap.ui.getCore().byId("importCsvDialog");
                if (existingDialog) {
                    existingDialog.destroy();
                }

                var dialog = new sap.m.Dialog({
                    id: "importCsvDialog",
                    title: "Import Materials from CSV",
                    contentWidth: "500px",
                    contentHeight: "400px",
                    content: [
                        new sap.m.VBox({
                            class: "sapUiMediumMargin",
                            items: [
                                new sap.m.MessageStrip({
                                    text: "Upload a CSV file with columns: ID, name, supplier_ID, quantity, category, unit",
                                    type: "Information",
                                    class: "sapUiMediumMarginBottom"
                                }),
                                new sap.m.Label({
                                    text: "Select CSV File:",
                                    class: "sapUiSmallMarginBottom"
                                }),
                                new sap.ui.unified.FileUploader({
                                    id: "csvFileUploader",
                                    placeholder: "Choose CSV file...",
                                    fileType: ["csv"],
                                    maximumFileSize: 10,
                                    width: "100%",
                                    buttonText: "Browse...",
                                    class: "sapUiMediumMarginBottom"
                                }),
                                new sap.m.Text({
                                    text: "Maximum file size: 10 MB",
                                    class: "sapUiTinyText"
                                })
                            ]
                        })
                    ],
                    beginButton: new sap.m.Button({
                        text: "Import Materials",
                        type: "Emphasized",
                        icon: "sap-icon://upload",
                        press: function() {
                            var fileUploader = sap.ui.getCore().byId("csvFileUploader");
                            var file = fileUploader.oFileUpload.files[0];
                            if (file) {
                                importCSVFile(file);
                                dialog.close();
                                dialog.destroy();
                            } else {
                                sap.m.MessageToast.show("Please select a CSV file");
                            }
                        }
                    }),
                    endButton: new sap.m.Button({
                        text: "Cancel",
                        icon: "sap-icon://decline",
                        press: function() {
                            dialog.close();
                            dialog.destroy();
                        }
                    })
                });
                dialog.open();
            }

            // Backend Functions
            function addMaterial(material) {
                console.log('Adding material:', material);

                fetch('http://localhost:4005/odata/v4/procurement/Materials', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        ID: material.ID,
                        name: material.name,
                        supplier_ID: parseInt(material.supplier) || 9001,
                        quantity: parseInt(material.quantity),
                        unit: material.unit || 'pcs',
                        category: material.category || 'General',
                        unitPrice: 0,
                        currency_code: 'USD',
                        description: material.description || '',
                        location: 'Warehouse A',
                        isActive: true
                    })
                })
                .then(response => {
                    console.log('Add response status:', response.status);
                    if (response.ok) {
                        return response.json();
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                })
                .then(data => {
                    console.log('Material added successfully:', data);
                    sap.m.MessageToast.show("Material added successfully!");
                    loadMaterials(); // Refresh the table
                })
                .catch(error => {
                    console.error('Error adding material:', error);
                    sap.m.MessageToast.show("Error adding material: " + error.message);
                });
            }

            function updateMaterial(material) {
                console.log('Updating material:', material);

                fetch(`/odata/v4/procurement/Materials('${material.ID}')`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        name: material.name,
                        supplier_ID: parseInt(material.supplier) || 9001,
                        quantity: parseInt(material.quantity),
                        unit: material.unit || 'pcs',
                        category: material.category || 'General'
                    })
                })
                .then(response => {
                    console.log('Update response status:', response.status);
                    if (response.ok || response.status === 204) {
                        sap.m.MessageToast.show("Material updated successfully!");
                        loadMaterials(); // Refresh the table
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                })
                .catch(error => {
                    console.error('Error updating material:', error);
                    sap.m.MessageToast.show("Error updating material: " + error.message);
                });
            }

            window.deleteMaterial = function(materialId, materialName) {
                console.log('Deleting material:', materialId, materialName);

                fetch(`http://localhost:4005/odata/v4/procurement/Materials('${materialId}')`, {
                    method: 'DELETE',
                    headers: {
                        'Accept': 'application/json'
                    }
                })
                .then(response => {
                    console.log('Delete response status:', response.status);
                    if (response.ok || response.status === 204) {
                        sap.m.MessageToast.show(`Material "${materialName || materialId}" deleted successfully!`);
                        loadMaterials(); // Refresh the table
                    } else {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                })
                .catch(error => {
                    console.error('Error deleting material:', error);
                    sap.m.MessageToast.show("Error deleting material: " + error.message);
                });
            }

            function importCSVFile(file) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    var csv = e.target.result;
                    var lines = csv.split('\n');
                    var headers = lines[0].split(',');

                    for (var i = 1; i < lines.length; i++) {
                        if (lines[i].trim()) {
                            var values = lines[i].split(',');
                            var material = {
                                ID: values[0]?.trim(),
                                name: values[1]?.trim(),
                                supplier: values[2]?.trim(),
                                quantity: parseInt(values[3]?.trim()) || 0
                            };

                            if (material.ID && material.name) {
                                addMaterial(material);
                            }
                        }
                    }
                    sap.m.MessageToast.show("CSV import completed!");
                };
                reader.readAsText(file);
            }

            // Load materials when app starts
            setTimeout(function() {
                loadMaterials();
            }, 2000);
        });
    </script>
</body>
</html>
