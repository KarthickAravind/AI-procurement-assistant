<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Procurement Assistant - Working Modern UI</title>
    
    <!-- UI5 Bootstrap -->
    <script
        id="sap-ui-bootstrap"
        src="https://ui5.sap.com/resources/sap-ui-core.js"
        data-sap-ui-theme="sap_horizon"
        data-sap-ui-libs="sap.m,sap.f,sap.ui.table"
        data-sap-ui-compatVersion="edge"
        data-sap-ui-async="true"
        data-sap-ui-frameOptions="trusted">
    </script>
    
    <style>
        .modernKpiTile {
            background: linear-gradient(135deg, #0070f3, #00d4ff);
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .modernKpiTile:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* Fiori Launchpad style tile spacing */
        .sapMGenericTile {
            margin: 16px !important;
        }

        /* Specific spacing for dashboard tiles */
        .sapMDynamicPageHeader .sapMHBox .sapMGenericTile {
            margin: 16px !important;
        }

        /* HBox container spacing */
        .sapMHBox {
            gap: 16px;
        }

        /* Ensure tiles have proper spacing in header */
        .sapMDynamicPageHeader .sapMHBox {
            padding: 16px;
        }

        /* Rating color classes */
        .ratingGreen {
            color: #2E7D32 !important; /* Green: 4.50-5.00 */
            font-weight: bold;
        }

        .ratingLightGreen {
            color: #4CAF50 !important; /* Light Green: 4.00-4.49 */
            font-weight: bold;
        }

        .ratingYellow {
            color: #F57C00 !important; /* Yellow: 3.50-3.99 */
            font-weight: bold;
        }

        .ratingOrange {
            color: #FF9800 !important; /* Orange: 3.00-3.49 */
            font-weight: bold;
        }

        .ratingDarkOrange {
            color: #FF5722 !important; /* Dark Orange: 2.50-2.99 */
            font-weight: bold;
        }

        .ratingRed {
            color: #D32F2F !important; /* Red: Below 2.49 */
            font-weight: bold;
        }

        /* WhatsApp-style Chat Interface */
        .chatContainer {
            background: #e5ddd5;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Ccircle cx='30' cy='30' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            padding: 16px;
            padding-bottom: 80px;
            min-height: 400px;
            overflow-y: auto;
        }

        .messageRow {
            display: flex;
            flex-direction: column;
            margin: 15px 20px;
            clear: both;
        }

        .messageRow.user {
            align-items: flex-end;
            margin-right: 25px;
        }

        .messageRow.assistant {
            align-items: flex-start;
            margin-left: 25px;
        }

        .messageLabel {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 5px;
            padding: 0 5px;
            color: #65676b;
        }

        .messageBubble {
            max-width: 75%;
            position: relative;
            padding: 15px 18px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            word-wrap: break-word;
            animation: fadeIn 0.3s ease-out;
            font-size: 15px;
            line-height: 1.4;
        }

        .messageBubble.user {
            background: linear-gradient(135deg, #25d366, #128c7e);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .messageBubble.user::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: -10px;
            width: 0;
            height: 0;
            border: 10px solid transparent;
            border-left: 15px solid #128c7e;
            border-right: 0;
            border-bottom: 0;
        }

        .messageBubble.assistant {
            background: linear-gradient(135deg, #0084ff, #0066cc);
            color: white;
            border-bottom-left-radius: 5px;
        }

        .messageBubble.assistant::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: -10px;
            width: 0;
            height: 0;
            border: 10px solid transparent;
            border-right: 15px solid #0066cc;
            border-left: 0;
            border-bottom: 0;
        }

        .messageTime {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 6px;
            text-align: right;
            font-weight: 400;
        }

        .messageBubble.assistant .messageTime {
            text-align: left;
        }

        .typingIndicator {
            background: linear-gradient(135deg, #f0f2f5, #e4e6ea);
            color: #65676b;
            border-radius: 20px;
            padding: 15px 18px;
            max-width: 70%;
            animation: pulse 1.5s infinite;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            border-bottom-left-radius: 5px;
            position: relative;
        }

        .typingIndicator::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: -10px;
            width: 0;
            height: 0;
            border: 10px solid transparent;
            border-right: 15px solid #e4e6ea;
            border-left: 0;
            border-bottom: 0;
        }

        /* Chat footer styling - Larger and more comfortable */
        .sapMPage .sapMPageFooter .sapMToolbar {
            background: #f8f9fa !important;
            border-top: 1px solid #e1e5e9 !important;
            padding: 12px 16px !important;
            min-height: 80px !important;
            align-items: flex-end !important;
        }

        /* Chat text area in footer - Larger and more comfortable */
        .sapMPage .sapMPageFooter .sapMTextArea {
            border-radius: 20px !important;
            border: 2px solid #e1e5e9 !important;
            font-size: 16px !important;
            line-height: 1.4 !important;
            padding: 12px 16px !important;
        }

        .sapMPage .sapMPageFooter .sapMTextArea:focus-within {
            border-color: #0070f3 !important;
            box-shadow: 0 0 0 3px rgba(0, 112, 243, 0.1) !important;
        }

        /* Send button styling in footer */
        .sapMPage .sapMPageFooter .sapMBtn {
            border-radius: 50% !important;
            box-shadow: 0 4px 12px rgba(0, 112, 243, 0.3) !important;
        }

        .sapMPage .sapMPageFooter .sapMBtn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 16px rgba(0, 112, 243, 0.4) !important;
        }



        /* Adjust chat container to account for fixed input */
        .chatContainer {
            padding-bottom: 70px !important;
            margin-bottom: 0 !important;
        }

        /* Reduce empty space in chat area */
        .sapMScrollCont {
            padding-bottom: 5px !important;
            margin-bottom: 0 !important;
        }

        /* Remove extra spacing from dialog content */
        .sapMDialogScrollCont {
            padding-bottom: 0 !important;
        }

        /* Ensure dialog content uses full height */
        .sapMDialog .sapMDialogSection {
            height: 100% !important;
            display: flex !important;
            flex-direction: column !important;
        }

        /* Make VBox containers flexible */
        .sapMVBox {
            height: 100% !important;
            display: flex !important;
            flex-direction: column !important;
        }

        /* Make scroll container flexible */
        .sapMScrollCont {
            flex: 1 !important;
            height: auto !important;
        }

        .quickActionBtn {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            border: none;
            border-radius: 20px;
            color: white;
            padding: 8px 16px;
            margin: 4px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(116, 185, 255, 0.3);
        }

        .quickActionBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(116, 185, 255, 0.4);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .chatMessage {
            border-radius: 8px;
            margin: 4px 0;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>

<body class="sapUiBody">
    <div id="content"></div>
    
    <script>
        var oApp, oModel, oChatModel;
        
        sap.ui.getCore().attachInit(function() {
            console.log("Working Modern UI5 initialized");
            
            try {
                // Initialize models
                initializeModels();
                
                // Create the main application
                createMainApplication();
                
                // Load initial data
                loadInitialData();
                
                console.log("Working Modern UI loaded successfully");
                
            } catch (error) {
                console.error("Error initializing app:", error);
                showError("Initialization Error: " + error.message);
            }
        });
        
        function initializeModels() {
            // Main data model
            oModel = new sap.ui.model.json.JSONModel({
                materials: [],
                suppliers: [],
                materialsCount: 0,
                suppliersCount: 3000, // Default to 3000, will update with actual count
                loading: false
            });
            
            // Chat model
            oChatModel = new sap.ui.model.json.JSONModel({
                sessionId: null,
                isConnected: false,
                messages: []
            });
            
            sap.ui.getCore().setModel(oModel);
            sap.ui.getCore().setModel(oChatModel, "chat");
        }
        
        function createMainApplication() {
            // Create KPI Tiles
            var oMaterialsTile = new sap.m.GenericTile({
                header: "Total Materials",
                subheader: "Inventory Overview",
                frameType: "OneByOne",
                class: "modernKpiTile",
                press: openMaterialsDialog,
                tileContent: [
                    new sap.m.TileContent({
                        content: new sap.m.NumericContent({
                            value: "{/materialsCount}",
                            indicator: "Up",
                            size: "M",
                            valueColor: "Good"
                        })
                    })
                ]
            });
            
            var oSuppliersTile = new sap.m.GenericTile({
                header: "Active Suppliers",
                subheader: "Network Status",
                frameType: "OneByOne",
                class: "modernKpiTile",
                press: openSuppliersDialog,
                tileContent: [
                    new sap.m.TileContent({
                        content: new sap.m.NumericContent({
                            value: "{/suppliersCount}",
                            indicator: "Up",
                            size: "M",
                            valueColor: "Good"
                        })
                    })
                ]
            });
            
            var oAITile = new sap.m.GenericTile({
                header: "My Dear Assistant",
                subheader: "Smart Recommendations",
                frameType: "OneByOne",
                class: "modernKpiTile",
                press: openAIAssistantDialog,
                tileContent: [
                    new sap.m.TileContent({
                        content: new sap.m.ImageContent({
                            src: "sap-icon://ai",
                            size: "L"
                        })
                    })
                ]
            });
            
            // Create Chat Panel
            var oChatInput = new sap.m.TextArea("chatInput", {
                placeholder: "Type your message here... (e.g., 'Find laptops under â‚¹50K')",
                growing: true,
                growingMaxLines: 3,
                width: "100%"
            });
            
            var oChatContainer = new sap.m.VBox("chatContainer", {
                class: "sapUiMediumMargin"
            });
            
            var oChatPanel = new sap.m.Panel({
                headerText: "AI Chat Assistant",
                expandable: false,
                height: "500px",
                content: [
                    new sap.m.VBox({
                        height: "100%",
                        items: [
                            // Quick Actions
                            new sap.m.Panel({
                                headerText: "Quick Actions",
                                expandable: false,
                                class: "sapUiMediumMarginBottom",
                                content: [
                                    new sap.m.HBox({
                                        wrap: "Wrap",
                                        class: "sapUiSmallMargin",
                                        items: [
                                            new sap.m.Button({
                                                text: "Create PO",
                                                icon: "sap-icon://create-form",
                                                type: "Emphasized",
                                                class: "sapUiTinyMarginEnd sapUiTinyMarginBottom",
                                                press: function() {
                                                    addChatMessage("I'll help you create a Purchase Order. What materials do you need?", "assistant");
                                                }
                                            }),
                                            new sap.m.Button({
                                                text: "Find Suppliers",
                                                icon: "sap-icon://supplier",
                                                type: "Default",
                                                class: "sapUiTinyMarginEnd sapUiTinyMarginBottom",
                                                press: function() {
                                                    addChatMessage("I'll help you find the best suppliers. What type of materials are you looking for?", "assistant");
                                                }
                                            }),
                                            new sap.m.Button({
                                                text: "Check Inventory",
                                                icon: "sap-icon://inventory",
                                                type: "Default",
                                                class: "sapUiTinyMarginEnd sapUiTinyMarginBottom",
                                                press: function() {
                                                    addChatMessage("Here's your current inventory status. Which materials would you like to check?", "assistant");
                                                }
                                            })
                                        ]
                                    })
                                ]
                            }),
                            
                            // Chat Messages
                            new sap.m.ScrollContainer({
                                height: "300px",
                                vertical: true,
                                class: "sapUiMediumMarginBottom",
                                content: [oChatContainer]
                            }),
                            
                            // Chat Input
                            new sap.m.HBox({
                                width: "100%",
                                alignItems: "End",
                                items: [
                                    oChatInput,
                                    new sap.m.Button({
                                        text: "Send",
                                        type: "Emphasized",
                                        icon: "sap-icon://paper-plane",
                                        class: "sapUiTinyMarginBegin",
                                        press: sendChatMessage
                                    })
                                ]
                            })
                        ]
                    })
                ]
            });
            
            // Create Materials Table
            var oMaterialsTable = new sap.m.Table("materialsTable", {
                headerToolbar: new sap.m.Toolbar({
                    content: [
                        new sap.m.Title({text: "Materials Inventory"}),
                        new sap.m.ToolbarSpacer(),
                        new sap.m.Button({
                            text: "Add Material",
                            type: "Emphasized",
                            icon: "sap-icon://add",
                            press: function() {
                                sap.m.MessageToast.show("Add Material functionality");
                            }
                        }),
                        new sap.m.Button({
                            text: "Refresh",
                            icon: "sap-icon://refresh",
                            press: loadMaterials
                        })
                    ]
                }),
                columns: [
                    new sap.m.Column({header: new sap.m.Text({text: "ID"})}),
                    new sap.m.Column({header: new sap.m.Text({text: "Name"})}),
                    new sap.m.Column({header: new sap.m.Text({text: "Supplier"})}),
                    new sap.m.Column({header: new sap.m.Text({text: "Quantity"})}),
                    new sap.m.Column({header: new sap.m.Text({text: "Category"})}),
                    new sap.m.Column({header: new sap.m.Text({text: "Actions"})})
                ]
            });
            
            oMaterialsTable.bindItems({
                path: "/materials",
                template: new sap.m.ColumnListItem({
                    cells: [
                        new sap.m.Text({text: "{ID}"}),
                        new sap.m.Text({text: "{name}"}),
                        new sap.m.Text({text: "{supplier_ID}"}),
                        new sap.m.Text({text: "{quantity} {unit}"}),
                        new sap.m.Text({text: "{category}"}),
                        new sap.m.HBox({
                            items: [
                                new sap.m.Button({
                                    icon: "sap-icon://edit",
                                    type: "Transparent",
                                    press: function(oEvent) {
                                        var oContext = oEvent.getSource().getBindingContext();
                                        var oMaterial = oContext.getObject();
                                        sap.m.MessageToast.show("Edit: " + oMaterial.name);
                                    }
                                }),
                                new sap.m.Button({
                                    icon: "sap-icon://delete",
                                    type: "Transparent",
                                    press: function(oEvent) {
                                        var oContext = oEvent.getSource().getBindingContext();
                                        var oMaterial = oContext.getObject();
                                        sap.m.MessageBox.confirm("Delete " + oMaterial.name + "?", {
                                            onClose: function(sAction) {
                                                if (sAction === sap.m.MessageBox.Action.OK) {
                                                    deleteMaterial(oMaterial.ID);
                                                }
                                            }
                                        });
                                    }
                                })
                            ]
                        })
                    ]
                })
            });
            
            // Create main layout using FlexibleColumnLayout
            var oFCL = new sap.f.FlexibleColumnLayout({
                layout: "TwoColumnsBeginExpanded",
                backgroundDesign: "Solid",
                beginColumnPages: [
                    new sap.m.Page({
                        title: "AI Assistant",
                        content: [oChatPanel]
                    })
                ],
                midColumnPages: [
                    new sap.m.Page({
                        title: "Warehouse Management",
                        content: [
                            new sap.m.Panel({
                                headerText: "Search & Filters",
                                expandable: true,
                                expanded: false,
                                class: "sapUiMediumMarginBottom",
                                content: [
                                    new sap.m.SearchField({
                                        placeholder: "Search materials...",
                                        width: "100%",
                                        class: "sapUiMediumMargin",
                                        search: function(oEvent) {
                                            var sQuery = oEvent.getParameter("query");
                                            filterMaterials(sQuery);
                                        }
                                    })
                                ]
                            }),
                            oMaterialsTable
                        ]
                    })
                ]
            });
            
            // Create Dynamic Page
            var oDynamicPage = new sap.f.DynamicPage({
                title: new sap.f.DynamicPageTitle({
                    heading: new sap.m.HBox({
                        alignItems: "Center",
                        items: [
                            new sap.m.Image({
                                src: "https://sapui5.hana.ondemand.com/resources/sap/ushell/themes/base/img/SAPLogo.svg",
                                alt: "SAP Logo",
                                width: "4rem",
                                height: "4rem",
                                class: "sapUiMediumMarginEnd"
                            }),
                            new sap.m.Title({
                                text: "AI-Powered Procurement Assistant",
                                level: "H1"
                            })
                        ]
                    }),
                    actions: [
                        new sap.m.Button({
                            text: "Settings",
                            icon: "sap-icon://action-settings"
                        }),
                        new sap.m.Button({
                            text: "Help",
                            icon: "sap-icon://sys-help"
                        })
                    ]
                }),
                header: new sap.f.DynamicPageHeader({
                    pinnable: true,
                    content: [
                        new sap.m.HBox({
                            wrap: "Wrap",
                            class: "sapUiMediumMargin",
                            justifyContent: "Start",
                            renderType: "Bare",
                            items: [
                                oMaterialsTile,
                                oSuppliersTile,
                                oAITile
                            ]
                        })
                    ]
                }),
                content: [oFCL]
            });
            
            // Set models
            oDynamicPage.setModel(oModel);
            oDynamicPage.setModel(oChatModel, "chat");
            
            // Place in DOM
            oDynamicPage.placeAt("content");
            
            // Add welcome messages
            addChatMessage("ðŸ‘‹ Hello! I'm your AI procurement assistant. I can help you with suppliers, materials, pricing, and procurement processes.", "assistant");
            addChatMessage("ðŸ’¡ Try the quick action buttons above or ask me anything!", "assistant");
        }
        
        function loadInitialData() {
            loadMaterials();
            loadSuppliers();
            initializeChatSession();
        }

        // Dialog Management
        var oMaterialsDialog = null;
        var oAddMaterialDialog = null;
        var oEditMaterialDialog = null;
        var oSuppliersDialog = null;
        var oAIAssistantDialog = null;
        var oCurrentMaterial = null;

        function openMaterialsDialog() {
            if (!oMaterialsDialog) {
                createMaterialsDialog();
            }
            oMaterialsDialog.open();
        }

        function createMaterialsDialog() {
            // Create Materials Table for Dialog
            var oDialogMaterialsTable = new sap.m.Table("dialogMaterialsTable", {
                growing: true,
                growingThreshold: 20,
                mode: "None",
                columns: [
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Material ID"}),
                        minScreenWidth: "Tablet",
                        demandPopin: true
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Name"}),
                        minScreenWidth: "Tablet",
                        demandPopin: true
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Supplier ID"}),
                        minScreenWidth: "Desktop",
                        demandPopin: true
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Quantity"}),
                        minScreenWidth: "Tablet",
                        demandPopin: true
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Category"}),
                        minScreenWidth: "Desktop",
                        demandPopin: true
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Actions"}),
                        minScreenWidth: "Tablet",
                        demandPopin: false
                    })
                ]
            });

            // Bind items to the dialog table
            oDialogMaterialsTable.bindItems({
                path: "/materials",
                template: new sap.m.ColumnListItem({
                    cells: [
                        new sap.m.Text({text: "{ID}"}),
                        new sap.m.Text({text: "{name}"}),
                        new sap.m.Text({text: "{supplier_ID}"}),
                        new sap.m.Text({text: "{quantity} {unit}"}),
                        new sap.m.Text({text: "{category}"}),
                        new sap.m.Button({
                            icon: "sap-icon://delete",
                            type: "Reject",
                            tooltip: "Delete Material",
                            press: function(oEvent) {
                                var oContext = oEvent.getSource().getBindingContext();
                                var oMaterial = oContext.getObject();
                                confirmDeleteMaterial(oMaterial);
                            }
                        })
                    ]
                })
            });

            // Create the main Materials Dialog
            oMaterialsDialog = new sap.m.Dialog("materialsDialog", {
                title: "Inventory Overview",
                contentWidth: "80%",
                contentHeight: "70%",
                verticalScrolling: true,
                horizontalScrolling: false,
                content: [
                    new sap.m.VBox({
                        items: [
                            // Search and Filter Bar
                            new sap.m.Bar({
                                contentLeft: [
                                    new sap.m.SearchField("dialogSearchField", {
                                        placeholder: "Search materials...",
                                        width: "300px",
                                        search: function(oEvent) {
                                            var sQuery = oEvent.getParameter("query");
                                            filterDialogMaterials(sQuery);
                                        }
                                    })
                                ],
                                contentRight: [
                                    new sap.m.Button({
                                        text: "Add Material",
                                        type: "Emphasized",
                                        icon: "sap-icon://add",
                                        class: "sapUiTinyMarginEnd",
                                        press: openAddMaterialDialog
                                    }),
                                    new sap.m.Button({
                                        text: "Export CSV",
                                        icon: "sap-icon://download",
                                        class: "sapUiTinyMarginEnd",
                                        press: exportMaterialsToCSV
                                    }),
                                    new sap.m.Button({
                                        text: "Refresh",
                                        icon: "sap-icon://refresh",
                                        press: function() {
                                            loadMaterials();
                                            sap.m.MessageToast.show("Materials refreshed");
                                        }
                                    })
                                ]
                            }),

                            // Materials Table in ScrollContainer
                            new sap.m.ScrollContainer({
                                height: "400px",
                                vertical: true,
                                horizontal: false,
                                content: [oDialogMaterialsTable]
                            })
                        ]
                    })
                ],
                beginButton: new sap.m.Button({
                    text: "Close",
                    press: function() {
                        oMaterialsDialog.close();
                    }
                })
            });

            // Set model to dialog
            oMaterialsDialog.setModel(oModel);
        }

        function openAddMaterialDialog() {
            if (!oAddMaterialDialog) {
                createAddMaterialDialog();
            }
            clearAddMaterialForm();
            oAddMaterialDialog.open();
        }

        function createAddMaterialDialog() {
            oAddMaterialDialog = new sap.m.Dialog("addMaterialDialog", {
                title: "Add New Material",
                contentWidth: "500px",
                contentHeight: "600px",
                verticalScrolling: false,
                content: [
                    new sap.m.VBox({
                        class: "sapUiMediumMargin",
                        items: [
                            // Material ID
                            new sap.m.Label({text: "Material ID *", class: "sapUiTinyMarginTop"}),
                            new sap.m.Input("addMaterialId", {
                                placeholder: "e.g., MAT001",
                                required: true,
                                maxLength: 20
                            }),

                            // Material Name
                            new sap.m.Label({text: "Material Name *", class: "sapUiTinyMarginTop"}),
                            new sap.m.Input("addMaterialName", {
                                placeholder: "Enter material name",
                                required: true,
                                maxLength: 255
                            }),

                            // Supplier ID
                            new sap.m.Label({text: "Supplier ID *", class: "sapUiTinyMarginTop"}),
                            new sap.m.Input("addMaterialSupplier", {
                                placeholder: "Enter supplier ID (e.g., 9001)",
                                required: true,
                                type: "Number"
                            }),

                            // Quantity
                            new sap.m.Label({text: "Quantity *", class: "sapUiTinyMarginTop"}),
                            new sap.m.Input("addMaterialQuantity", {
                                placeholder: "Enter quantity",
                                required: true,
                                type: "Number"
                            }),

                            // Unit
                            new sap.m.Label({text: "Unit", class: "sapUiTinyMarginTop"}),
                            new sap.m.ComboBox("addMaterialUnit", {
                                placeholder: "Select unit",
                                selectedKey: "pcs",
                                items: [
                                    new sap.ui.core.Item({key: "pcs", text: "Pieces"}),
                                    new sap.ui.core.Item({key: "kg", text: "Kilograms"}),
                                    new sap.ui.core.Item({key: "liters", text: "Liters"}),
                                    new sap.ui.core.Item({key: "meters", text: "Meters"}),
                                    new sap.ui.core.Item({key: "sheets", text: "Sheets"}),
                                    new sap.ui.core.Item({key: "bags", text: "Bags"}),
                                    new sap.ui.core.Item({key: "units", text: "Units"})
                                ]
                            }),

                            // Category
                            new sap.m.Label({text: "Category", class: "sapUiTinyMarginTop"}),
                            new sap.m.ComboBox("addMaterialCategory", {
                                placeholder: "Select category",
                                selectedKey: "General",
                                items: [
                                    new sap.ui.core.Item({key: "General", text: "General"}),
                                    new sap.ui.core.Item({key: "Construction", text: "Construction"}),
                                    new sap.ui.core.Item({key: "Manufacturing", text: "Manufacturing"}),
                                    new sap.ui.core.Item({key: "Logistics", text: "Logistics"})
                                ]
                            })
                        ]
                    })
                ],
                beginButton: new sap.m.Button({
                    text: "Add Material",
                    type: "Emphasized",
                    icon: "sap-icon://add",
                    press: saveNewMaterial
                }),
                endButton: new sap.m.Button({
                    text: "Cancel",
                    press: function() {
                        oAddMaterialDialog.close();
                    }
                })
            });
        }

        function clearAddMaterialForm() {
            sap.ui.getCore().byId("addMaterialId").setValue("");
            sap.ui.getCore().byId("addMaterialName").setValue("");
            sap.ui.getCore().byId("addMaterialSupplier").setValue("");
            sap.ui.getCore().byId("addMaterialQuantity").setValue("");
            sap.ui.getCore().byId("addMaterialUnit").setSelectedKey("pcs");
            sap.ui.getCore().byId("addMaterialCategory").setSelectedKey("General");
        }

        function saveNewMaterial() {
            var sId = sap.ui.getCore().byId("addMaterialId").getValue();
            var sName = sap.ui.getCore().byId("addMaterialName").getValue();
            var sSupplier = sap.ui.getCore().byId("addMaterialSupplier").getValue();
            var iQuantity = parseInt(sap.ui.getCore().byId("addMaterialQuantity").getValue());
            var sUnit = sap.ui.getCore().byId("addMaterialUnit").getSelectedKey();
            var sCategory = sap.ui.getCore().byId("addMaterialCategory").getSelectedKey();

            if (!sId || !sName || !sSupplier || !iQuantity) {
                sap.m.MessageToast.show("Please fill all required fields");
                return;
            }

            // Call backend service
            fetch('/odata/v4/procurement/addMaterial', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ID: sId,
                    name: sName,
                    supplier: sSupplier,
                    quantity: iQuantity,
                    category: sCategory || "General",
                    unit: sUnit || "pcs"
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    sap.m.MessageToast.show(data.message);
                    loadMaterials(); // Refresh materials and update tile count
                    oAddMaterialDialog.close();
                } else {
                    sap.m.MessageToast.show("Error: " + data.message);
                }
            })
            .catch(error => {
                console.error("Error adding material:", error);
                sap.m.MessageToast.show("Error adding material");
            });
        }

        function openEditMaterialDialog(oMaterial) {
            oCurrentMaterial = oMaterial;
            if (!oEditMaterialDialog) {
                createEditMaterialDialog();
            }
            populateEditMaterialForm(oMaterial);
            oEditMaterialDialog.open();
        }

        function createEditMaterialDialog() {
            oEditMaterialDialog = new sap.m.Dialog("editMaterialDialog", {
                title: "Edit Material",
                contentWidth: "500px",
                contentHeight: "600px",
                verticalScrolling: false,
                content: [
                    new sap.m.VBox({
                        class: "sapUiMediumMargin",
                        items: [
                            // Material ID (Read-only)
                            new sap.m.Label({text: "Material ID", class: "sapUiTinyMarginTop"}),
                            new sap.m.Input("editMaterialId", {
                                editable: false
                            }),

                            // Material Name
                            new sap.m.Label({text: "Material Name *", class: "sapUiTinyMarginTop"}),
                            new sap.m.Input("editMaterialName", {
                                placeholder: "Enter material name",
                                required: true,
                                maxLength: 255
                            }),

                            // Supplier ID
                            new sap.m.Label({text: "Supplier ID *", class: "sapUiTinyMarginTop"}),
                            new sap.m.Input("editMaterialSupplier", {
                                placeholder: "Enter supplier ID",
                                required: true
                            }),

                            // Quantity
                            new sap.m.Label({text: "Quantity *", class: "sapUiTinyMarginTop"}),
                            new sap.m.Input("editMaterialQuantity", {
                                placeholder: "Enter quantity",
                                required: true,
                                type: "Number"
                            }),

                            // Unit
                            new sap.m.Label({text: "Unit", class: "sapUiTinyMarginTop"}),
                            new sap.m.ComboBox("editMaterialUnit", {
                                placeholder: "Select unit",
                                items: [
                                    new sap.ui.core.Item({key: "pcs", text: "Pieces"}),
                                    new sap.ui.core.Item({key: "kg", text: "Kilograms"}),
                                    new sap.ui.core.Item({key: "liters", text: "Liters"}),
                                    new sap.ui.core.Item({key: "meters", text: "Meters"}),
                                    new sap.ui.core.Item({key: "sheets", text: "Sheets"}),
                                    new sap.ui.core.Item({key: "bags", text: "Bags"}),
                                    new sap.ui.core.Item({key: "units", text: "Units"})
                                ]
                            }),

                            // Category
                            new sap.m.Label({text: "Category", class: "sapUiTinyMarginTop"}),
                            new sap.m.ComboBox("editMaterialCategory", {
                                placeholder: "Select category",
                                items: [
                                    new sap.ui.core.Item({key: "General", text: "General"}),
                                    new sap.ui.core.Item({key: "Construction", text: "Construction"}),
                                    new sap.ui.core.Item({key: "Manufacturing", text: "Manufacturing"}),
                                    new sap.ui.core.Item({key: "Logistics", text: "Logistics"})
                                ]
                            }),

                            // Unit Price
                            new sap.m.Label({text: "Unit Price (USD)", class: "sapUiTinyMarginTop"}),
                            new sap.m.Input("editMaterialPrice", {
                                placeholder: "0.00",
                                type: "Number"
                            })
                        ]
                    })
                ],
                beginButton: new sap.m.Button({
                    text: "Save Changes",
                    type: "Emphasized",
                    icon: "sap-icon://save",
                    press: saveEditMaterial
                }),
                endButton: new sap.m.HBox({
                    items: [
                        new sap.m.Button({
                            text: "Delete",
                            type: "Reject",
                            icon: "sap-icon://delete",
                            press: function() {
                                confirmDeleteMaterial(oCurrentMaterial);
                                oEditMaterialDialog.close();
                            }
                        }),
                        new sap.m.Button({
                            text: "Cancel",
                            press: function() {
                                oEditMaterialDialog.close();
                            }
                        })
                    ]
                })
            });
        }

        function populateEditMaterialForm(oMaterial) {
            sap.ui.getCore().byId("editMaterialId").setValue(oMaterial.ID);
            sap.ui.getCore().byId("editMaterialName").setValue(oMaterial.name);
            sap.ui.getCore().byId("editMaterialSupplier").setValue(oMaterial.supplier_ID || "");
            sap.ui.getCore().byId("editMaterialQuantity").setValue(oMaterial.quantity);
            sap.ui.getCore().byId("editMaterialUnit").setSelectedKey(oMaterial.unit || "pcs");
            sap.ui.getCore().byId("editMaterialCategory").setSelectedKey(oMaterial.category || "General");
            sap.ui.getCore().byId("editMaterialPrice").setValue(oMaterial.unitPrice || "");
        }

        function saveEditMaterial() {
            var sName = sap.ui.getCore().byId("editMaterialName").getValue();
            var sSupplier = sap.ui.getCore().byId("editMaterialSupplier").getValue();
            var iQuantity = parseInt(sap.ui.getCore().byId("editMaterialQuantity").getValue());
            var sUnit = sap.ui.getCore().byId("editMaterialUnit").getSelectedKey();
            var sCategory = sap.ui.getCore().byId("editMaterialCategory").getSelectedKey();
            var fPrice = parseFloat(sap.ui.getCore().byId("editMaterialPrice").getValue()) || 0;

            if (!sName || !sSupplier || !iQuantity) {
                sap.m.MessageToast.show("Please fill all required fields");
                return;
            }

            // Call backend service
            fetch('/odata/v4/procurement/Materials(\'' + oCurrentMaterial.ID + '\')', {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: sName,
                    supplier_ID: sSupplier,
                    quantity: iQuantity,
                    category: sCategory,
                    unitPrice: fPrice,
                    unit: sUnit
                })
            })
            .then(() => {
                sap.m.MessageToast.show("Material updated successfully");
                loadMaterials(); // Refresh materials and update tile count
                oEditMaterialDialog.close();
            })
            .catch(error => {
                console.error("Error updating material:", error);
                sap.m.MessageToast.show("Error updating material");
            });
        }

        function confirmDeleteMaterial(oMaterial) {
            // Use simple confirm dialog like test-backend.html
            if (confirm(`Are you sure you want to delete material ${oMaterial.ID} (${oMaterial.name})?`)) {
                deleteMaterialFromBackend(oMaterial.ID);
            }
        }

        async function deleteMaterialFromBackend(sMaterialId) {
            sap.m.MessageToast.show(`Deleting material ${sMaterialId}...`);

            try {
                const response = await fetch(`/odata/v4/procurement/Materials('${sMaterialId}')`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    sap.m.MessageToast.show(`âœ… Material ${sMaterialId} deleted successfully!`);
                    // Reload materials to reflect the deletion
                    setTimeout(() => {
                        loadMaterials();
                        if (oMaterialsDialog && oMaterialsDialog.isOpen()) {
                            loadMaterialsForDialog();
                        }
                    }, 1000);
                } else {
                    sap.m.MessageToast.show(`âŒ Delete failed for material ${sMaterialId}`);
                }
            } catch (error) {
                console.error('Error deleting material:', error);
                sap.m.MessageToast.show(`âŒ Delete error: ${error.message}`);
            }
        }

        function filterDialogMaterials(sQuery) {
            if (!sQuery || !sQuery.trim()) {
                // If no query, reload all materials
                loadMaterialsForDialog();
                return;
            }

            // Use OData filtering like in test-backend.html
            var sQueryLower = sQuery.toLowerCase();
            var sFilterUrl = `/odata/v4/procurement/Materials?$filter=contains(tolower(name),'${sQueryLower}') or contains(tolower(ID),'${sQueryLower}') or contains(tolower(supplier_ID),'${sQueryLower}') or contains(tolower(category),'${sQueryLower}')`;

            fetch(sFilterUrl)
                .then(response => response.json())
                .then(data => {
                    var materials = data.value || [];
                    oModel.setProperty("/materials", materials);
                    console.log(`Search found ${materials.length} materials for query: ${sQuery}`);
                })
                .catch(error => {
                    console.error("Error searching materials:", error);
                    sap.m.MessageToast.show("Error searching materials");
                });
        }

        function loadMaterialsForDialog() {
            // Reload all materials for the dialog
            fetch('/odata/v4/procurement/Materials')
                .then(response => response.json())
                .then(data => {
                    var materials = data.value || [];
                    oModel.setProperty("/materials", materials);
                })
                .catch(error => {
                    console.error("Error loading materials:", error);
                });
        }

        function exportMaterialsToCSV() {
            fetch('/odata/v4/procurement/exportMaterialsToCSV', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.csvData) {
                    var element = document.createElement('a');
                    element.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(data.csvData));
                    element.setAttribute('download', 'materials_export.csv');
                    element.style.display = 'none';
                    document.body.appendChild(element);
                    element.click();
                    document.body.removeChild(element);
                    sap.m.MessageToast.show("Materials exported successfully!");
                } else {
                    sap.m.MessageToast.show("No data to export");
                }
            })
            .catch(error => {
                console.error("Error exporting materials:", error);
                sap.m.MessageToast.show("Error exporting materials");
            });
        }
        
        function loadMaterials() {
            oModel.setProperty("/loading", true);
            
            fetch('/odata/v4/procurement/Materials')
                .then(response => response.json())
                .then(data => {
                    var materials = data.value || [];
                    oModel.setProperty("/materials", materials);
                    oModel.setProperty("/materialsCount", materials.length);
                    oModel.setProperty("/loading", false);
                    sap.m.MessageToast.show("Materials loaded successfully!");
                })
                .catch(error => {
                    console.error("Error loading materials:", error);
                    oModel.setProperty("/loading", false);
                    sap.m.MessageToast.show("Error loading materials");
                });
        }
        
        function loadSuppliers() {
            // Use $top=5000 to ensure we get all suppliers (3000+)
            fetch('/odata/v4/procurement/Suppliers?$top=5000')
                .then(response => response.json())
                .then(data => {
                    var suppliers = data.value || [];
                    oModel.setProperty("/suppliersCount", suppliers.length);
                    console.log(`Loaded ${suppliers.length} suppliers for tile count`);

                    // Ensure we have the expected 3000+ suppliers
                    if (suppliers.length < 3000) {
                        console.warn(`Expected 3000+ suppliers, but got ${suppliers.length}`);
                    }
                })
                .catch(error => {
                    console.error("Error loading suppliers:", error);
                    // Keep default count of 3000 if loading fails
                });
        }
        
        function initializeChatSession() {
            fetch('/odata/v4/procurement/initChatSession', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                oChatModel.setProperty("/sessionId", data.sessionId);
                oChatModel.setProperty("/isConnected", true);
            })
            .catch(error => {
                console.error("Error initializing chat:", error);
            });
        }
        
        function sendChatMessage() {
            var oInput = sap.ui.getCore().byId("chatInput");
            var sMessage = oInput.getValue().trim();
            
            if (!sMessage) {
                sap.m.MessageToast.show("Please enter a message");
                return;
            }
            
            addChatMessage(sMessage, "user");
            oInput.setValue("");
            
            var oTypingMessage = addChatMessage("ðŸ¤– Assistant is typing...", "typing");
            
            var sSessionId = oChatModel.getProperty("/sessionId");
            
            fetch('/odata/v4/procurement/sendChatMessage', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    sessionId: sSessionId,
                    message: sMessage
                })
            })
            .then(response => response.json())
            .then(data => {
                // Remove typing indicator
                var oChatContainer = sap.ui.getCore().byId("chatContainer");
                oChatContainer.removeItem(oTypingMessage);
                
                if (data.success && data.response) {
                    addChatMessage(data.response, "assistant");
                } else {
                    addChatMessage(generateSmartResponse(sMessage), "assistant");
                }
            })
            .catch(error => {
                console.error("Error sending message:", error);
                var oChatContainer = sap.ui.getCore().byId("chatContainer");
                oChatContainer.removeItem(oTypingMessage);
                addChatMessage(generateSmartResponse(sMessage), "assistant");
            });
        }
        
        function addChatMessage(sMessage, sType) {
            var sMessageType = sType === "user" ? "Success" : "Information";
            var sIcon = sType === "user" ? "ðŸ‘¤ You: " : (sType === "typing" ? "" : "ðŸ¤– Assistant: ");
            
            var oMessage = new sap.m.MessageStrip({
                text: sIcon + sMessage,
                type: sMessageType,
                class: "chatMessage sapUiMediumMarginBottom"
            });
            
            var oChatContainer = sap.ui.getCore().byId("chatContainer");
            oChatContainer.addItem(oMessage);
            
            return oMessage;
        }
        
        function generateSmartResponse(sUserMessage) {
            var sMessage = sUserMessage.toLowerCase();
            
            if (sMessage.includes("laptop") || sMessage.includes("computer")) {
                return "I found 3 suppliers for laptops:\nâ€¢ TechCorp India - â‚¹42,000/unit, 7 days delivery\nâ€¢ Digital Solutions - â‚¹48,500/unit, 5 days delivery\nâ€¢ CompuWorld - â‚¹45,200/unit, 10 days delivery\n\nWould you like me to create a PO or send RFQ?";
            } else if (sMessage.includes("supplier")) {
                return "Here are our top-rated suppliers:\nðŸ† TechCorp India (4.8/5) - Electronics\nðŸ† Furniture Plus (4.6/5) - Office Furniture\nðŸ† Stationery World (4.7/5) - Office Supplies\n\nWhich category interests you?";
            } else {
                return "I understand you're asking about: '" + sUserMessage + "'. I can help with:\nâ€¢ Finding suppliers and pricing\nâ€¢ Creating purchase orders\nâ€¢ Sending RFQs\nâ€¢ Checking inventory\nâ€¢ Compliance verification\n\nTry using the quick action buttons above or ask me something specific!";
            }
        }
        
        function filterMaterials(sQuery) {
            var oTable = sap.ui.getCore().byId("materialsTable");
            var oBinding = oTable.getBinding("items");
            
            if (sQuery) {
                var oFilter = new sap.ui.model.Filter([
                    new sap.ui.model.Filter("name", sap.ui.model.FilterOperator.Contains, sQuery),
                    new sap.ui.model.Filter("ID", sap.ui.model.FilterOperator.Contains, sQuery)
                ], false);
                oBinding.filter([oFilter]);
            } else {
                oBinding.filter([]);
            }
        }
        
        function deleteMaterial(sMaterialId) {
            fetch('/odata/v4/procurement/Materials(\'' + sMaterialId + '\')', {
                method: 'DELETE'
            })
            .then(() => {
                sap.m.MessageToast.show("Material deleted successfully");
                loadMaterials();
            })
            .catch(error => {
                console.error("Error deleting material:", error);
                sap.m.MessageToast.show("Error deleting material");
            });
        }
        
        function openSuppliersDialog() {
            if (!oSuppliersDialog) {
                createSuppliersDialog();
            }
            loadSuppliersForDialog();
            oSuppliersDialog.open();
        }

        function createSuppliersDialog() {
            // Create Suppliers Table for Dialog
            var oDialogSuppliersTable = new sap.m.Table("dialogSuppliersTable", {
                growing: true,
                growingThreshold: 100,
                growingScrollToLoad: false,
                growingTriggerText: "Load More Suppliers ({0})",
                mode: "None",
                columns: [
                    new sap.m.Column({
                        header: new sap.m.Text({text: "ID"}),
                        minScreenWidth: "Tablet",
                        demandPopin: true
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Category"}),
                        minScreenWidth: "Desktop",
                        demandPopin: true
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Company Name"}),
                        minScreenWidth: "Tablet",
                        demandPopin: true
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Material"}),
                        minScreenWidth: "Desktop",
                        demandPopin: true
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Region"}),
                        minScreenWidth: "Desktop",
                        demandPopin: true
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Lead Time"}),
                        minScreenWidth: "Desktop",
                        demandPopin: true
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Contact Email"}),
                        minScreenWidth: "Desktop",
                        demandPopin: true
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Rating"}),
                        minScreenWidth: "Desktop",
                        demandPopin: true
                    })
                ]
            });

            // Bind items to the dialog table
            oDialogSuppliersTable.bindItems({
                path: "/suppliers",
                template: new sap.m.ColumnListItem({
                    cells: [
                        new sap.m.Text({text: "{ID}"}),
                        new sap.m.Text({text: "{category}"}),
                        new sap.m.Text({text: "{name}"}),
                        new sap.m.Text({text: "{material}"}),
                        new sap.m.Text({text: "{region}"}),
                        new sap.m.Text({text: "{leadTime} days"}),
                        new sap.m.Text({text: "{contactEmail}"}),
                        new sap.m.Text({
                            text: "{rating}",
                            class: {
                                path: "rating",
                                formatter: function(rating) {
                                    var numRating = parseFloat(rating);
                                    if (numRating >= 4.50) return "ratingGreen";      // Green: 4.50-5.00
                                    if (numRating >= 4.00) return "ratingLightGreen"; // Light Green: 4.00-4.49
                                    if (numRating >= 3.50) return "ratingYellow";     // Yellow: 3.50-3.99
                                    if (numRating >= 3.00) return "ratingOrange";     // Orange: 3.00-3.49
                                    if (numRating >= 2.50) return "ratingDarkOrange"; // Dark Orange: 2.50-2.99
                                    return "ratingRed";                               // Red: Below 2.49
                                }
                            }
                        })
                    ]
                })
            });

            // Create the main Suppliers Dialog
            oSuppliersDialog = new sap.m.Dialog("suppliersDialog", {
                title: "Active Suppliers Directory",
                contentWidth: "90%",
                contentHeight: "80%",
                verticalScrolling: true,
                horizontalScrolling: false,
                content: [
                    new sap.m.VBox({
                        items: [
                            // Search and Filter Bar
                            new sap.m.Bar({
                                contentLeft: [
                                    new sap.m.SearchField("dialogSuppliersSearchField", {
                                        placeholder: "Search suppliers by company name, category, region, material...",
                                        width: "400px",
                                        search: function(oEvent) {
                                            var sQuery = oEvent.getParameter("query");
                                            filterDialogSuppliers(sQuery);
                                        }
                                    })
                                ],
                                contentRight: [
                                    new sap.m.Button({
                                        text: "Refresh",
                                        icon: "sap-icon://refresh",
                                        press: function() {
                                            loadSuppliersForDialog();
                                            sap.m.MessageToast.show("Suppliers refreshed");
                                        }
                                    })
                                ]
                            }),

                            // Suppliers Table in ScrollContainer
                            new sap.m.ScrollContainer({
                                height: "500px",
                                vertical: true,
                                horizontal: false,
                                content: [oDialogSuppliersTable]
                            })
                        ]
                    })
                ],
                beginButton: new sap.m.Button({
                    text: "Close",
                    press: function() {
                        oSuppliersDialog.close();
                    }
                })
            });

            // Set model to dialog
            oSuppliersDialog.setModel(oModel);
        }

        function loadSuppliersForDialog() {
            // Use $top=5000 to ensure we get all suppliers (3000+)
            fetch('/odata/v4/procurement/Suppliers?$top=5000')
                .then(response => response.json())
                .then(data => {
                    var suppliers = data.value || [];

                    console.log(`Fetched ${suppliers.length} suppliers from backend`);

                    // Randomize the suppliers array to show random data instead of sorted by ID
                    suppliers = shuffleArray(suppliers);

                    oModel.setProperty("/suppliers", suppliers);
                    console.log(`Loaded ${suppliers.length} suppliers for dialog`);
                    sap.m.MessageToast.show(` Loaded ${suppliers.length} suppliers`);

                    // Ensure we have the expected 3000+ suppliers
                    if (suppliers.length < 3000) {
                        console.warn(`Expected 3000+ suppliers, but got ${suppliers.length}`);
                        sap.m.MessageToast.show(`âš ï¸ Warning: Only ${suppliers.length} suppliers loaded (expected 3000+)`);
                    }
                })
                .catch(error => {
                    console.error("Error loading suppliers:", error);
                    sap.m.MessageToast.show(" Error loading suppliers");
                });
        }

        // Function to shuffle array randomly
        function shuffleArray(array) {
            var shuffled = [...array]; // Create a copy
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function filterDialogSuppliers(sQuery) {
            if (!sQuery || !sQuery.trim()) {
                // If no query, reload all suppliers
                loadSuppliersForDialog();
                return;
            }

            // Use OData filtering for suppliers with correct field names
            var sQueryLower = sQuery.toLowerCase();
            var sFilterUrl = `/odata/v4/procurement/Suppliers?$filter=contains(tolower(name),'${sQueryLower}') or contains(tolower(category),'${sQueryLower}') or contains(tolower(region),'${sQueryLower}') or contains(tolower(material),'${sQueryLower}') or contains(tolower(contactEmail),'${sQueryLower}')`;

            fetch(sFilterUrl)
                .then(response => response.json())
                .then(data => {
                    var suppliers = data.value || [];
                    oModel.setProperty("/suppliers", suppliers);
                    console.log(`Search found ${suppliers.length} suppliers for query: ${sQuery}`);
                    if (suppliers.length === 0) {
                        sap.m.MessageToast.show(`No suppliers found for "${sQuery}"`);
                    }
                })
                .catch(error => {
                    console.error("Error searching suppliers:", error);
                    sap.m.MessageToast.show("Error searching suppliers");
                });
        }

        function openAIAssistantDialog() {
            if (!oAIAssistantDialog) {
                createAIAssistantDialog();
            }
            oAIAssistantDialog.open();
        }

        function createAIAssistantDialog() {
            // Chat Messages Container with WhatsApp styling
            var oChatContainer = new sap.m.VBox("aiChatContainer", {
                class: "chatContainer"
            });

            // Simple Chat Input
            var oChatInput = new sap.m.TextArea("aiChatInput", {
                placeholder: "Type a message...",
                growing: true,
                growingMaxLines: 3,
                width: "100%",
                showExceededText: false,
                valueLiveUpdate: true
            });

            // Create the AI Assistant Dialog
            oAIAssistantDialog = new sap.m.Dialog("aiAssistantDialog", {
                contentWidth: "85%",
                contentHeight: "90%",
                verticalScrolling: false,
                horizontalScrolling: false,
                customHeader: new sap.m.Bar({
                    contentLeft: [
                        new sap.ui.core.Icon({
                            src: "sap-icon://ai",
                            size: "1.5rem",
                            color: "#0070f3",
                            class: "sapUiTinyMarginEnd"
                        }),
                        new sap.m.Title({
                            text: "My Dear Assistant - AI Procurement Chat",
                            level: "H4"
                        })
                    ],
                    contentRight: [
                        new sap.m.Button({
                            icon: "sap-icon://information",
                            type: "Transparent",
                            tooltip: "AI Status",
                            press: toggleStatusCard
                        }),

                        new sap.m.MenuButton({
                            icon: "sap-icon://sys-help",
                            type: "Transparent",
                            tooltip: "Help",
                            menu: new sap.m.Menu({
                                items: [
                                    new sap.m.MenuItem({
                                        text: "Extract Chat",
                                        icon: "sap-icon://download",
                                        press: extractChatHistory
                                    }),
                                    new sap.m.MenuItem({
                                        text: "Support",
                                        icon: "sap-icon://customer-and-contacts",
                                        press: function() {
                                            sap.m.MessageToast.show("Sorry, not available for now");
                                        }
                                    })
                                ]
                            })
                        }),
                        new sap.m.Button({
                            icon: "sap-icon://decline",
                            type: "Transparent",
                            tooltip: "Close",
                            press: function() {
                                oAIAssistantDialog.close();
                            }
                        })
                    ]
                }),
                content: [
                    new sap.m.Page({
                        showHeader: false,
                        content: [
                            // Status Card (initially hidden)
                            new sap.m.Panel("statusCard", {
                                visible: false,
                                class: "sapUiTinyMarginBottom",
                                content: [
                                    new sap.m.VBox({
                                        class: "sapUiSmallMargin",
                                        items: [
                                            new sap.m.ObjectStatus({
                                                text: "Gemini 1.5 Flash Connected",
                                                state: "Success",
                                                icon: "sap-icon://connected"
                                            }),
                                            new sap.m.ObjectStatus({
                                                text: "Procurement Knowledge Base Active",
                                                state: "Information",
                                                icon: "sap-icon://database"
                                            }),
                                            new sap.m.ObjectStatus({
                                                text: "Real-time Data Access Enabled",
                                                state: "Warning",
                                                icon: "sap-icon://refresh"
                                            })
                                        ]
                                    })
                                ]
                            }),

                            // Quick Actions with SAP icons
                            new sap.m.Panel({
                                headerText: "Quick Actions",
                                expandable: true,
                                expanded: true,
                                class: "sapUiMediumMarginBottom",
                                content: [
                                    new sap.m.FlexBox({
                                        wrap: "Wrap",
                                        justifyContent: "SpaceAround",
                                        class: "sapUiMediumMargin",
                                        items: [
                                            new sap.m.Button({
                                                text: "Create PO",
                                                icon: "sap-icon://create-form",
                                                type: "Emphasized",
                                                class: "quickActionBtn sapUiTinyMargin",
                                                press: function() {
                                                    addAIChatMessage("Create Purchase Order", "user");
                                                    sendToGemini("I need help creating a Purchase Order. What materials do you need?");
                                                }
                                            }),
                                            new sap.m.Button({
                                                text: "Send RFQ",
                                                icon: "sap-icon://email",
                                                type: "Accept",
                                                class: "quickActionBtn sapUiTinyMargin",
                                                press: function() {
                                                    addAIChatMessage("Send RFQ", "user");
                                                    sendToGemini("I need to send a Request for Quotation. Which suppliers should I contact?");
                                                }
                                            }),
                                            new sap.m.Button({
                                                text: "Find Suppliers",
                                                icon: "sap-icon://supplier",
                                                type: "Accept",
                                                class: "quickActionBtn sapUiTinyMargin",
                                                press: function() {
                                                    addAIChatMessage("Find Suppliers", "user");
                                                    sendToGemini("I need to find suppliers. What type of materials are you looking for?");
                                                }
                                            }),
                                            new sap.m.Button({
                                                text: "Check Inventory",
                                                icon: "sap-icon://inventory",
                                                type: "Neutral",
                                                class: "quickActionBtn sapUiTinyMargin",
                                                press: function() {
                                                    addAIChatMessage("Check Inventory", "user");
                                                    sendToGemini("Please check my current inventory status");
                                                }
                                            }),
                                            new sap.m.Button({
                                                text: "Smart Search",
                                                icon: "sap-icon://search",
                                                type: "Ghost",
                                                class: "quickActionBtn sapUiTinyMargin",
                                                press: function() {
                                                    addAIChatMessage("Smart Search", "user");
                                                    sendToGemini("Help me search for specific materials or suppliers");
                                                }
                                            }),
                                            new sap.m.Button({
                                                text: "Market Insights",
                                                icon: "sap-icon://trend-up",
                                                type: "Transparent",
                                                class: "quickActionBtn sapUiTinyMargin",
                                                press: function() {
                                                    addAIChatMessage("Market Insights", "user");
                                                    sendToGemini("Show me current market insights and procurement trends");
                                                }
                                            })
                                        ]
                                    })
                                ]
                            }),

                            // Chat Messages Area - Full height scrollable
                            new sap.m.ScrollContainer({
                                height: "100%",
                                vertical: true,
                                content: [oChatContainer]
                            })
                        ],
                        footer: new sap.m.Toolbar({
                            height: "80px",
                            content: [
                                new sap.m.TextArea("chatTextArea", {
                                    placeholder: "Type your message here... (e.g., 'Find laptops under â‚¹50K')",
                                    growing: false,
                                    rows: 1,
                                    width: "100%",
                                    class: "sapUiTinyMarginEnd",
                                    liveChange: function(oEvent) {
                                        var sValue = oEvent.getParameter("value");
                                        var oSendBtn = sap.ui.getCore().byId("chatSendBtn");
                                        if (oSendBtn) {
                                            oSendBtn.setEnabled(sValue.trim().length > 0);
                                        }
                                    }
                                }),
                                new sap.m.Button("chatSendBtn", {
                                    icon: "sap-icon://paper-plane",
                                    type: "Emphasized",
                                    enabled: false,
                                    height: "60px",
                                    width: "100px",
                                    press: function() {
                                        var oTextArea = sap.ui.getCore().byId("chatTextArea");
                                        var sMessage = oTextArea.getValue().trim();
                                        if (sMessage) {
                                            addAIChatMessage(sMessage, "user");
                                            sendToGemini(sMessage);
                                            oTextArea.setValue("");
                                            this.setEnabled(false);
                                        }
                                    }
                                })
                            ]
                        })
                    })
                ]
            });

            // Initialize chat with welcome messages
            setTimeout(() => {
                initializeAIChat();
                // Check Gemini connection status every 30 seconds
                setInterval(checkGeminiConnection, 30000);
            }, 500);
        }

        function toggleStatusCard() {
            var oStatusCard = sap.ui.getCore().byId("statusCard");
            if (oStatusCard) {
                oStatusCard.setVisible(!oStatusCard.getVisible());
            }
        }



        function extractChatHistory() {
            var oChatContainer = sap.ui.getCore().byId("aiChatContainer");
            if (!oChatContainer || oChatContainer.getItems().length === 0) {
                sap.m.MessageToast.show("No chat history to extract");
                return;
            }

            var sChatContent = "# AI Procurement Chat History\n\n";
            sChatContent += "**Date:** " + new Date().toLocaleString() + "\n\n";

            oChatContainer.getItems().forEach(function(oItem) {
                if (oItem.hasStyleClass && oItem.hasStyleClass("userMessage")) {
                    sChatContent += "**User:** ";
                    var oText = oItem.getItems()[0];
                    if (oText && oText.getHtmlText) {
                        sChatContent += oText.getHtmlText().replace(/<[^>]*>/g, '') + "\n\n";
                    }
                } else if (oItem.hasStyleClass && oItem.hasStyleClass("assistantMessage")) {
                    sChatContent += "**AI Assistant:** ";
                    var oText = oItem.getItems()[1];
                    if (oText && oText.getHtmlText) {
                        sChatContent += oText.getHtmlText().replace(/<[^>]*>/g, '') + "\n\n";
                    }
                }
            });

            // Create download
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(sChatContent));
            element.setAttribute('download', 'chat_history_' + new Date().toISOString().slice(0,10) + '.md');
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);

            sap.m.MessageToast.show("Chat history downloaded as .md file");
        }

        function sendAIChatMessage() {
            var oInput = sap.ui.getCore().byId("aiChatInput");
            if (oInput) {
                var sMessage = oInput.getValue().trim();

                if (!sMessage) {
                    sap.m.MessageToast.show("ðŸ’¬ Please enter a message");
                    return;
                }

                addAIChatMessage(sMessage, "user");
                oInput.setValue("");

                // Send to Gemini AI
                sendToGemini(sMessage);
            }
        }



        function addAIChatMessage(sMessage, sType) {
            var oChatContainer = sap.ui.getCore().byId("aiChatContainer");

            if (sType === "user") {
                // User message - right aligned with label and tail
                var oUserBubble = new sap.ui.core.HTML({
                    content: `
                        <div class="messageRow user">
                            <div class="messageLabel">You</div>
                            <div class="messageBubble user">
                                <div style="margin-bottom: 4px;">${sMessage}</div>
                                <div class="messageTime">${new Date().toLocaleTimeString()}</div>
                            </div>
                        </div>
                    `
                });
                oChatContainer.addItem(oUserBubble);

            } else if (sType === "assistant") {
                // Assistant message - left aligned with label and tail
                var oAssistantBubble = new sap.ui.core.HTML({
                    content: `
                        <div class="messageRow assistant">
                            <div class="messageLabel">AI Assistant</div>
                            <div class="messageBubble assistant">
                                <div style="margin-bottom: 4px;">${sMessage}</div>
                                <div class="messageTime">${new Date().toLocaleTimeString()}</div>
                            </div>
                        </div>
                    `
                });
                oChatContainer.addItem(oAssistantBubble);

            } else if (sType === "typing") {
                // Typing indicator with label
                var oTypingBubble = new sap.ui.core.HTML({
                    content: `
                        <div class="messageRow assistant">
                            <div class="messageLabel">AI Assistant</div>
                            <div class="typingIndicator">
                                <div style="display: flex; align-items: center;">
                                    <span style="margin-right: 8px;">ðŸ¤–</span>
                                    <span>AI is thinking...</span>
                                </div>
                            </div>
                        </div>
                    `
                });
                oChatContainer.addItem(oTypingBubble);
                return oTypingBubble;
            }

            // Auto-scroll to bottom
            setTimeout(() => {
                scrollChatToBottom();
            }, 100);
        }

        function scrollChatToBottom() {
            var oChatContainer = sap.ui.getCore().byId("aiChatContainer");
            if (oChatContainer) {
                var oScrollContainer = oChatContainer.getParent();
                if (oScrollContainer && oScrollContainer.scrollTo) {
                    oScrollContainer.scrollTo(0, oScrollContainer.getScrollHeight());
                }
            }
        }

        function clearChatHistory() {
            var oChatContainer = sap.ui.getCore().byId("aiChatContainer");
            if (oChatContainer) {
                oChatContainer.removeAllItems();
                sap.m.MessageToast.show("ðŸ—‘ï¸ Chat history cleared");
            }
        }

        function initializeAIChat() {
            // Initialize chat session with Gemini
            initializeChatSession();
        }

        // Initialize chat session
        window.chatSessionId = null;
        window.geminiConnected = false;

        function initializeChatSession() {
            console.log("Initializing chat session...");

            fetch('/odata/v4/procurement/initChatSession', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log("Chat session initialized:", data);
                window.chatSessionId = data.sessionId;
                window.geminiConnected = true;
                updateGeminiStatus(true);

                // Add welcome message
                if (data.welcomeMessage) {
                    addAIChatMessage(data.welcomeMessage, "assistant");
                }
            })
            .catch(error => {
                console.error("Error initializing chat session:", error);
                window.geminiConnected = false;
                updateGeminiStatus(false);
                addAIChatMessage("Welcome! I'm your AI procurement assistant. How can I help you today?", "assistant");
            });
        }

        function updateGeminiStatus(isConnected) {
            var oStatusCard = sap.ui.getCore().byId("statusCard");
            if (oStatusCard) {
                var aItems = oStatusCard.getContent()[0].getItems();
                if (aItems && aItems.length > 0) {
                    var oGeminiStatus = aItems[0];
                    if (isConnected) {
                        oGeminiStatus.setText("Gemini 1.5 Flash Connected");
                        oGeminiStatus.setState("Success");
                        oGeminiStatus.setIcon("sap-icon://connected");
                    } else {
                        oGeminiStatus.setText("Gemini 1.5 Flash Not Connected");
                        oGeminiStatus.setState("Error");
                        oGeminiStatus.setIcon("sap-icon://disconnected");
                    }
                }
            }
        }

        function checkGeminiConnection() {
            fetch('/odata/v4/procurement/initChatSession', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    window.geminiConnected = true;
                    updateGeminiStatus(true);
                } else {
                    window.geminiConnected = false;
                    updateGeminiStatus(false);
                }
            })
            .catch(error => {
                window.geminiConnected = false;
                updateGeminiStatus(false);
            });
        }

        function sendToGemini(sUserMessage) {
            // Show typing indicator
            var oTypingMessage = addAIChatMessage("", "typing");

            // Send message to Gemini AI
            if (!window.chatSessionId) {
                console.warn("No chat session, initializing...");
                initializeChatSession();
                setTimeout(() => sendMessageToAI(sUserMessage, oTypingMessage), 1000);
            } else {
                sendMessageToAI(sUserMessage, oTypingMessage);
            }
        }

        function sendMessageToAI(message, typingMessage) {
            fetch('/odata/v4/procurement/sendChatMessage', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    sessionId: window.chatSessionId,
                    message: message
                })
            })
            .then(response => {
                if (response.ok) {
                    window.geminiConnected = true;
                    updateGeminiStatus(true);
                    return response.json();
                } else {
                    window.geminiConnected = false;
                    updateGeminiStatus(false);
                    throw new Error('Network response was not ok');
                }
            })
            .then(data => {
                console.log("AI response received:", data);

                // Remove typing indicator
                if (typingMessage) {
                    var oChatContainer = sap.ui.getCore().byId("aiChatContainer");
                    oChatContainer.removeItem(typingMessage);
                }

                if (data.success && data.response) {
                    addAIChatMessage(data.response, "assistant");
                } else if (data.fallbackResponse) {
                    addAIChatMessage(data.fallbackResponse, "assistant");
                } else {
                    addAIChatMessage("I apologize, but I'm having trouble right now. Please try again.", "assistant");
                }
            })
            .catch(error => {
                console.error("Error sending message to AI:", error);
                window.geminiConnected = false;
                updateGeminiStatus(false);

                // Remove typing indicator
                if (typingMessage) {
                    var oChatContainer = sap.ui.getCore().byId("aiChatContainer");
                    oChatContainer.removeItem(typingMessage);
                }

                // Fallback to smart response
                var response = generateLocalResponse(message);
                addAIChatMessage(response, "assistant");
            });
        }

        async function getProcurementContext() {
            try {
                // Get current materials count
                const materialsResponse = await fetch('/odata/v4/procurement/Materials?$top=5');
                const materialsData = await materialsResponse.json();

                // Get current suppliers count
                const suppliersResponse = await fetch('/odata/v4/procurement/Suppliers?$top=5');
                const suppliersData = await suppliersResponse.json();

                return {
                    materialsCount: oModel.getProperty("/materialsCount") || 0,
                    suppliersCount: oModel.getProperty("/suppliersCount") || 0,
                    recentMaterials: materialsData.value || [],
                    topSuppliers: suppliersData.value || []
                };
            } catch (error) {
                console.error('Error getting context:', error);
                return {
                    materialsCount: 0,
                    suppliersCount: 0,
                    recentMaterials: [],
                    topSuppliers: []
                };
            }
        }

        function generateLocalResponse(sUserMessage) {
            var sMessage = sUserMessage.toLowerCase();

            if (sMessage.includes("laptop") || sMessage.includes("computer")) {
                return "<strong>Laptop Suppliers Found:</strong><br/><br/><strong>TechCorp India</strong><br/>â€¢ Price: â‚¹42,000/unit<br/>â€¢ Delivery: 7 days<br/>â€¢ Rating: 4.8/5<br/><br/><strong>Digital Solutions</strong><br/>â€¢ Price: â‚¹48,500/unit<br/>â€¢ Delivery: 5 days<br/>â€¢ Rating: 4.6/5<br/><br/><strong>CompuWorld</strong><br/>â€¢ Price: â‚¹45,200/unit<br/>â€¢ Delivery: 10 days<br/>â€¢ Rating: 4.5/5<br/><br/>Would you like me to create a PO or send an RFQ?";
            } else if (sMessage.includes("supplier")) {
                return "<strong>Top-Rated Suppliers:</strong><br/><br/><strong>TechCorp India</strong> (4.8/5)<br/>Electronics & Technology<br/><br/><strong>Furniture Plus</strong> (4.6/5)<br/>Office Furniture & Equipment<br/><br/><strong>Stationery World</strong> (4.7/5)<br/>Office Supplies & Materials<br/><br/>Which category interests you? I can provide detailed supplier information.";
            } else if (sMessage.includes("price") || sMessage.includes("cost")) {
                return "<strong>Market Price Analysis:</strong><br/><br/><strong>Current Trends:</strong><br/>â€¢ Electronics: +5% this quarter<br/>â€¢ Construction: Stable pricing<br/>â€¢ Office supplies: -2% decrease<br/>â€¢ Manufacturing: +3% increase<br/><br/><strong>Recommendations:</strong><br/>â€¢ Best time to buy office supplies<br/>â€¢ Electronics prices expected to stabilize<br/>â€¢ Consider bulk orders for construction materials<br/><br/>Which specific materials need pricing analysis?";
            } else if (sMessage.includes("inventory") || sMessage.includes("stock")) {
                return "<strong>Current Inventory Status:</strong><br/><br/><strong>Overview:</strong><br/>â€¢ Total materials: 15 items<br/>â€¢ Active suppliers: 3000+<br/>â€¢ Categories covered: 4<br/><br/><strong>Alerts:</strong><br/>â€¢ 3 items with low stock<br/>â€¢ 2 items need reordering<br/>â€¢ 12 items well-stocked<br/><br/>Would you like details on specific categories or materials? I can help you manage your inventory efficiently.";
            } else {
                return `<strong>I understand you're asking about:</strong> "${sUserMessage}"<br/><br/><strong>I can help you with:</strong><br/>â€¢ Finding suppliers and pricing<br/>â€¢ Creating purchase orders<br/>â€¢ Sending RFQs<br/>â€¢ Checking inventory<br/>â€¢ Compliance verification<br/>â€¢ Market analysis<br/>â€¢ Cost optimization<br/><br/>Try using the quick action buttons above or ask me something specific about procurement!`;
            }
        }

        function showError(sMessage) {
            document.getElementById("content").innerHTML =
                "<div style='padding: 20px; text-align: center;'>" +
                "<h2>Error Loading Application</h2>" +
                "<p>" + sMessage + "</p>" +
                "<button onclick='location.reload()'>Reload Page</button>" +
                "</div>";
        }
        
        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
        });
    </script>
</body>
</html>
