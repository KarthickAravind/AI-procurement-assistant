<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered Procurement Assistant - Working Modern UI</title>
    
    <!-- UI5 Bootstrap -->
    <script
        id="sap-ui-bootstrap"
        src="https://ui5.sap.com/resources/sap-ui-core.js"
        data-sap-ui-theme="sap_horizon"
        data-sap-ui-libs="sap.m,sap.f,sap.ui.table"
        data-sap-ui-compatVersion="edge"
        data-sap-ui-async="true"
        data-sap-ui-frameOptions="trusted">
    </script>
    
    <style>
        .modernKpiTile {
            background: linear-gradient(135deg, #0070f3, #00d4ff);
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }
        
        .modernKpiTile:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* Fiori Launchpad style tile spacing */
        .sapMGenericTile {
            margin: 16px !important;
        }

        /* Specific spacing for dashboard tiles */
        .sapMDynamicPageHeader .sapMHBox .sapMGenericTile {
            margin: 16px !important;
        }

        /* HBox container spacing */
        .sapMHBox {
            gap: 16px;
        }

        /* Ensure tiles have proper spacing in header */
        .sapMDynamicPageHeader .sapMHBox {
            padding: 16px;
        }

        /* Rating color classes */
        .ratingGreen {
            color: #2E7D32 !important; /* Green: 4.50-5.00 */
            font-weight: bold;
        }

        .ratingLightGreen {
            color: #4CAF50 !important; /* Light Green: 4.00-4.49 */
            font-weight: bold;
        }

        .ratingYellow {
            color: #F57C00 !important; /* Yellow: 3.50-3.99 */
            font-weight: bold;
        }

        .ratingOrange {
            color: #FF9800 !important; /* Orange: 3.00-3.49 */
            font-weight: bold;
        }

        .ratingDarkOrange {
            color: #FF5722 !important; /* Dark Orange: 2.50-2.99 */
            font-weight: bold;
        }

        .ratingRed {
            color: #D32F2F !important; /* Red: Below 2.49 */
            font-weight: bold;
        }

        /* WhatsApp-style Chat Interface */
        .chatContainer {
            background: #e5ddd5;
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.1'%3E%3Ccircle cx='30' cy='30' r='2'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
            padding: 16px;
            padding-bottom: 80px;
            min-height: 400px;
            overflow-y: auto;
        }

        .messageRow {
            display: flex;
            flex-direction: column;
            margin: 15px 20px;
            clear: both;
        }

        .messageRow.user {
            align-items: flex-end;
            margin-right: 25px;
        }

        .messageRow.assistant {
            align-items: flex-start;
            margin-left: 25px;
        }

        .messageLabel {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 5px;
            padding: 0 5px;
            color: #65676b;
        }

        .messageBubble {
            max-width: 75%;
            position: relative;
            padding: 15px 18px;
            border-radius: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            word-wrap: break-word;
            animation: fadeIn 0.3s ease-out;
            font-size: 15px;
            line-height: 1.4;
        }

        .messageBubble.user {
            background: linear-gradient(135deg, #25d366, #128c7e);
            color: white;
            border-bottom-right-radius: 5px;
        }

        .messageBubble.user::after {
            content: '';
            position: absolute;
            bottom: 0;
            right: -10px;
            width: 0;
            height: 0;
            border: 10px solid transparent;
            border-left: 15px solid #128c7e;
            border-right: 0;
            border-bottom: 0;
        }

        .messageBubble.assistant {
            background: linear-gradient(135deg, #0084ff, #0066cc);
            color: white;
            border-bottom-left-radius: 5px;
        }

        .messageBubble.assistant::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: -10px;
            width: 0;
            height: 0;
            border: 10px solid transparent;
            border-right: 15px solid #0066cc;
            border-left: 0;
            border-bottom: 0;
        }

        .messageTime {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 6px;
            text-align: right;
            font-weight: 400;
        }

        .messageBubble.assistant .messageTime {
            text-align: left;
        }

        .typingIndicator {
            background: linear-gradient(135deg, #f0f2f5, #e4e6ea);
            color: #65676b;
            border-radius: 20px;
            padding: 15px 18px;
            max-width: 70%;
            animation: pulse 1.5s infinite;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            border-bottom-left-radius: 5px;
            position: relative;
        }

        .typingIndicator::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: -10px;
            width: 0;
            height: 0;
            border: 10px solid transparent;
            border-right: 15px solid #e4e6ea;
            border-left: 0;
            border-bottom: 0;
        }

        /* Chat footer styling - Larger and more comfortable */
        .sapMPage .sapMPageFooter .sapMToolbar {
            background: #f8f9fa !important;
            border-top: 1px solid #e1e5e9 !important;
            padding: 12px 16px !important;
            min-height: 80px !important;
            align-items: flex-end !important;
        }

        /* Chat text area in footer - Larger and more comfortable */
        .sapMPage .sapMPageFooter .sapMTextArea {
            border-radius: 20px !important;
            border: 2px solid #e1e5e9 !important;
            font-size: 16px !important;
            line-height: 1.4 !important;
            padding: 12px 16px !important;
        }

        .sapMPage .sapMPageFooter .sapMTextArea:focus-within {
            border-color: #0070f3 !important;
            box-shadow: 0 0 0 3px rgba(0, 112, 243, 0.1) !important;
        }

        /* Send button styling in footer */
        .sapMPage .sapMPageFooter .sapMBtn {
            border-radius: 50% !important;
            box-shadow: 0 4px 12px rgba(0, 112, 243, 0.3) !important;
        }

        .sapMPage .sapMPageFooter .sapMBtn:hover {
            transform: translateY(-2px) !important;
            box-shadow: 0 6px 16px rgba(0, 112, 243, 0.4) !important;
        }



        /* Adjust chat container to account for fixed input */
        .chatContainer {
            padding-bottom: 70px !important;
            margin-bottom: 0 !important;
        }

        /* Reduce empty space in chat area */
        .sapMScrollCont {
            padding-bottom: 5px !important;
            margin-bottom: 0 !important;
        }

        /* Remove extra spacing from dialog content */
        .sapMDialogScrollCont {
            padding-bottom: 0 !important;
        }

        /* Ensure dialog content uses full height */
        .sapMDialog .sapMDialogSection {
            height: 100% !important;
            display: flex !important;
            flex-direction: column !important;
        }

        /* Make VBox containers flexible */
        .sapMVBox {
            height: 100% !important;
            display: flex !important;
            flex-direction: column !important;
        }

        /* Make scroll container flexible */
        .sapMScrollCont {
            flex: 1 !important;
            height: auto !important;
        }

        .quickActionBtn {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            border: none;
            border-radius: 20px;
            color: white;
            padding: 8px 16px;
            margin: 4px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(116, 185, 255, 0.3);
        }

        .quickActionBtn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(116, 185, 255, 0.4);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .chatMessage {
            border-radius: 8px;
            margin: 4px 0;
            animation: slideIn 0.3s ease-out;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>

<body class="sapUiBody">
    <div id="content"></div>
    
    <script>
        var oApp, oModel, oChatModel;
        
        sap.ui.getCore().attachInit(function() {
            console.log("Working Modern UI5 initialized");
            
            try {
                // Initialize models
                initializeModels();
                
                // Create the main application
                createMainApplication();
                
                // Load initial data
                loadInitialData();
                
                console.log("Working Modern UI loaded successfully");
                
            } catch (error) {
                console.error("Error initializing app:", error);
                showError("Initialization Error: " + error.message);
            }
        });
        
        function initializeModels() {
            // Main data model
            oModel = new sap.ui.model.json.JSONModel({
                materials: [],
                suppliers: [],
                materialsCount: 0,
                suppliersCount: 3000, // Default to 3000, will update with actual count
                loading: false
            });
            
            // Chat model
            oChatModel = new sap.ui.model.json.JSONModel({
                sessionId: null,
                isConnected: false,
                messages: []
            });
            
            sap.ui.getCore().setModel(oModel);
            sap.ui.getCore().setModel(oChatModel, "chat");
        }
        
        function createMainApplication() {
            // Create KPI Tiles
            var oMaterialsTile = new sap.m.GenericTile({
                header: "Total Materials",
                subheader: "Inventory Overview",
                frameType: "OneByOne",
                class: "modernKpiTile",
                press: openMaterialsDialog,
                tileContent: [
                    new sap.m.TileContent({
                        content: new sap.m.NumericContent({
                            value: "{/materialsCount}",
                            indicator: "Up",
                            size: "M",
                            valueColor: "Good"
                        })
                    })
                ]
            });
            
            var oSuppliersTile = new sap.m.GenericTile({
                header: "Active Suppliers",
                subheader: "Network Status",
                frameType: "OneByOne",
                class: "modernKpiTile",
                press: openSuppliersDialog,
                tileContent: [
                    new sap.m.TileContent({
                        content: new sap.m.NumericContent({
                            value: "{/suppliersCount}",
                            indicator: "Up",
                            size: "M",
                            valueColor: "Good"
                        })
                    })
                ]
            });
            
            var oAITile = new sap.m.GenericTile({
                header: "My Dear Assistant",
                subheader: "Smart Recommendations",
                frameType: "OneByOne",
                class: "modernKpiTile",
                press: openAIAssistantDialog,
                tileContent: [
                    new sap.m.TileContent({
                        content: new sap.m.ImageContent({
                            src: "sap-icon://ai",
                            size: "L"
                        })
                    })
                ]
            });

            var oOrderManuallyTile = new sap.m.GenericTile({
                header: "Order Manually",
                subheader: "Manual Procurement",
                frameType: "OneByOne",
                class: "modernKpiTile",
                press: openOrderManuallyPage,
                tileContent: [
                    new sap.m.TileContent({
                        content: new sap.m.ImageContent({
                            src: "sap-icon://create-form",
                            size: "L"
                        })
                    })
                ]
            });
            
            // Create Chat Panel
            var oChatInput = new sap.m.TextArea("chatInput", {
                placeholder: "Type your message here... (e.g., 'Find laptops under ‚Çπ50K')",
                growing: true,
                growingMaxLines: 3,
                width: "100%"
            });
            
            var oChatContainer = new sap.m.VBox("chatContainer", {
                class: "sapUiMediumMargin"
            });
            
            var oChatPanel = new sap.m.Panel({
                headerText: "AI Chat Assistant",
                expandable: false,
                height: "500px",
                content: [
                    new sap.m.VBox({
                        height: "100%",
                        items: [
                            // Quick Actions
                            new sap.m.Panel({
                                headerText: "Quick Actions",
                                expandable: false,
                                class: "sapUiMediumMarginBottom",
                                content: [
                                    new sap.m.HBox({
                                        wrap: "Wrap",
                                        class: "sapUiSmallMargin",
                                        items: [
                                            new sap.m.Button({
                                                text: "Create PO",
                                                icon: "sap-icon://create-form",
                                                type: "Emphasized",
                                                class: "sapUiTinyMarginEnd sapUiTinyMarginBottom",
                                                press: function() {
                                                    addChatMessage("I'll help you create a Purchase Order. What materials do you need?", "assistant");
                                                }
                                            }),
                                            new sap.m.Button({
                                                text: "Find Suppliers",
                                                icon: "sap-icon://supplier",
                                                type: "Default",
                                                class: "sapUiTinyMarginEnd sapUiTinyMarginBottom",
                                                press: function() {
                                                    addChatMessage("I'll help you find the best suppliers. What type of materials are you looking for?", "assistant");
                                                }
                                            }),
                                            new sap.m.Button({
                                                text: "Check Inventory",
                                                icon: "sap-icon://inventory",
                                                type: "Default",
                                                class: "sapUiTinyMarginEnd sapUiTinyMarginBottom",
                                                press: function() {
                                                    addChatMessage("Here's your current inventory status. Which materials would you like to check?", "assistant");
                                                }
                                            })
                                        ]
                                    })
                                ]
                            }),
                            
                            // Chat Messages
                            new sap.m.ScrollContainer({
                                height: "300px",
                                vertical: true,
                                class: "sapUiMediumMarginBottom",
                                content: [oChatContainer]
                            }),
                            
                            // Chat Input
                            new sap.m.HBox({
                                width: "100%",
                                alignItems: "End",
                                items: [
                                    oChatInput,
                                    new sap.m.Button({
                                        text: "Send",
                                        type: "Emphasized",
                                        icon: "sap-icon://paper-plane",
                                        class: "sapUiTinyMarginBegin",
                                        press: sendChatMessage
                                    })
                                ]
                            })
                        ]
                    })
                ]
            });
            
            // Create Materials Table
            var oMaterialsTable = new sap.m.Table("materialsTable", {
                headerToolbar: new sap.m.Toolbar({
                    content: [
                        new sap.m.Title({text: "Materials Inventory"}),
                        new sap.m.ToolbarSpacer(),
                        new sap.m.Button({
                            text: "Add Material",
                            type: "Emphasized",
                            icon: "sap-icon://add",
                            press: function() {
                                sap.m.MessageToast.show("Add Material functionality");
                            }
                        }),
                        new sap.m.Button({
                            text: "Refresh",
                            icon: "sap-icon://refresh",
                            press: loadMaterials
                        })
                    ]
                }),
                columns: [
                    new sap.m.Column({header: new sap.m.Text({text: "ID"})}),
                    new sap.m.Column({header: new sap.m.Text({text: "Name"})}),
                    new sap.m.Column({header: new sap.m.Text({text: "Supplier"})}),
                    new sap.m.Column({header: new sap.m.Text({text: "Quantity"})}),
                    new sap.m.Column({header: new sap.m.Text({text: "Category"})}),
                    new sap.m.Column({header: new sap.m.Text({text: "Actions"})})
                ]
            });
            
            oMaterialsTable.bindItems({
                path: "/materials",
                template: new sap.m.ColumnListItem({
                    cells: [
                        new sap.m.Text({text: "{ID}"}),
                        new sap.m.Text({text: "{name}"}),
                        new sap.m.Text({text: "{supplierName}"}),
                        new sap.m.Text({text: "{quantity} {unit}"}),
                        new sap.m.Text({text: "{category}"}),
                        new sap.m.HBox({
                            items: [
                                new sap.m.Button({
                                    icon: "sap-icon://edit",
                                    type: "Transparent",
                                    press: function(oEvent) {
                                        var oContext = oEvent.getSource().getBindingContext();
                                        var oMaterial = oContext.getObject();
                                        sap.m.MessageToast.show("Edit: " + oMaterial.name);
                                    }
                                }),
                                new sap.m.Button({
                                    icon: "sap-icon://delete",
                                    type: "Transparent",
                                    press: function(oEvent) {
                                        var oContext = oEvent.getSource().getBindingContext();
                                        var oMaterial = oContext.getObject();
                                        sap.m.MessageBox.confirm("Delete " + oMaterial.name + "?", {
                                            onClose: function(sAction) {
                                                if (sAction === sap.m.MessageBox.Action.OK) {
                                                    deleteMaterial(oMaterial.ID);
                                                }
                                            }
                                        });
                                    }
                                })
                            ]
                        })
                    ]
                })
            });
            
            // Create main layout using FlexibleColumnLayout
            var oFCL = new sap.f.FlexibleColumnLayout({
                layout: "TwoColumnsBeginExpanded",
                backgroundDesign: "Solid",
                beginColumnPages: [
                    new sap.m.Page({
                        title: "AI Assistant",
                        content: [oChatPanel]
                    })
                ],
                midColumnPages: [
                    new sap.m.Page({
                        title: "Warehouse Management",
                        content: [
                            new sap.m.Panel({
                                headerText: "Search & Filters",
                                expandable: true,
                                expanded: false,
                                class: "sapUiMediumMarginBottom",
                                content: [
                                    new sap.m.SearchField({
                                        placeholder: "Search materials...",
                                        width: "100%",
                                        class: "sapUiMediumMargin",
                                        search: function(oEvent) {
                                            var sQuery = oEvent.getParameter("query");
                                            filterMaterials(sQuery);
                                        }
                                    })
                                ]
                            }),
                            oMaterialsTable
                        ]
                    })
                ]
            });
            
            // Create Dynamic Page
            var oDynamicPage = new sap.f.DynamicPage({
                title: new sap.f.DynamicPageTitle({
                    heading: new sap.m.HBox({
                        alignItems: "Center",
                        items: [
                            new sap.m.Image({
                                src: "https://sapui5.hana.ondemand.com/resources/sap/ushell/themes/base/img/SAPLogo.svg",
                                alt: "SAP Logo",
                                width: "4rem",
                                height: "4rem",
                                class: "sapUiMediumMarginEnd"
                            }),
                            new sap.m.Title({
                                text: "AI-Powered Procurement Assistant",
                                level: "H1"
                            })
                        ]
                    }),
                    actions: [
                        new sap.m.Button({
                            text: "Settings",
                            icon: "sap-icon://action-settings"
                        }),
                        new sap.m.Button({
                            text: "Help",
                            icon: "sap-icon://sys-help"
                        })
                    ]
                }),
                header: new sap.f.DynamicPageHeader({
                    pinnable: true,
                    content: [
                        new sap.m.HBox({
                            wrap: "Wrap",
                            class: "sapUiMediumMargin",
                            justifyContent: "Start",
                            renderType: "Bare",
                            items: [
                                oAITile,
                                oSuppliersTile,
                                oMaterialsTile,
                                oOrderManuallyTile
                            ]
                        })
                    ]
                }),
                content: [oFCL]
            });
            
            // Set models
            oDynamicPage.setModel(oModel);
            oDynamicPage.setModel(oChatModel, "chat");
            
            // Place in DOM
            oDynamicPage.placeAt("content");
            
            // Add welcome messages
            addChatMessage("üëã Hello! I'm your AI procurement assistant. I can help you with suppliers, materials, pricing, and procurement processes.", "assistant");
            addChatMessage("üí° Try the quick action buttons above or ask me anything!", "assistant");
        }
        
        function loadInitialData() {
            loadMaterials();
            loadSuppliers();
            initializeChatSession();
        }

        // Dialog Management
        var oMaterialsDialog = null;
        var oAddMaterialDialog = null;
        var oEditMaterialDialog = null;
        var oSuppliersDialog = null;
        var oAIAssistantDialog = null;
        var oOrderManuallyDialog = null;
        var oSupplierDetailsDialog = null;
        var oRFQDialog = null;
        var oCurrentMaterial = null;
        var oCurrentSupplier = null;

        function openMaterialsDialog() {
            if (!oMaterialsDialog) {
                createMaterialsDialog();
            }
            oMaterialsDialog.open();
        }

        function createMaterialsDialog() {
            // Create Materials Table for Dialog
            var oDialogMaterialsTable = new sap.m.Table("dialogMaterialsTable", {
                growing: true,
                growingThreshold: 20,
                mode: "None",
                columns: [
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Material ID"}),
                        minScreenWidth: "Tablet",
                        demandPopin: true
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Name"}),
                        minScreenWidth: "Tablet",
                        demandPopin: true
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Supplier"}),
                        minScreenWidth: "Desktop",
                        demandPopin: true
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Quantity"}),
                        minScreenWidth: "Tablet",
                        demandPopin: true
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Category"}),
                        minScreenWidth: "Desktop",
                        demandPopin: true
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Delivery Period"}),
                        minScreenWidth: "Desktop",
                        demandPopin: true
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Actions"}),
                        minScreenWidth: "Tablet",
                        demandPopin: false
                    })
                ]
            });

            // Bind items to the dialog table
            oDialogMaterialsTable.bindItems({
                path: "/materials",
                template: new sap.m.ColumnListItem({
                    cells: [
                        new sap.m.Text({text: "{ID}"}),
                        new sap.m.Text({text: "{name}"}),
                        new sap.m.Text({text: "{supplierName}"}),
                        new sap.m.Text({text: "{quantity} {unit}"}),
                        new sap.m.Text({text: "{category}"}),
                        new sap.m.Text({text: "{deliveryPeriod}"}),
                        new sap.m.Button({
                            icon: "sap-icon://delete",
                            type: "Reject",
                            tooltip: "Delete Material",
                            press: function(oEvent) {
                                var oContext = oEvent.getSource().getBindingContext();
                                var oMaterial = oContext.getObject();
                                confirmDeleteMaterial(oMaterial);
                            }
                        })
                    ]
                })
            });

            // Create the main Materials Dialog
            oMaterialsDialog = new sap.m.Dialog("materialsDialog", {
                title: "Inventory Overview",
                contentWidth: "80%",
                contentHeight: "70%",
                verticalScrolling: true,
                horizontalScrolling: false,
                content: [
                    new sap.m.VBox({
                        items: [
                            // Search and Filter Bar
                            new sap.m.Bar({
                                contentLeft: [
                                    new sap.m.SearchField("dialogSearchField", {
                                        placeholder: "Search materials...",
                                        width: "300px",
                                        search: function(oEvent) {
                                            var sQuery = oEvent.getParameter("query");
                                            filterDialogMaterials(sQuery);
                                        }
                                    })
                                ],
                                contentRight: [
                                    new sap.m.Button({
                                        text: "Add Material",
                                        type: "Emphasized",
                                        icon: "sap-icon://add",
                                        class: "sapUiTinyMarginEnd",
                                        press: openAddMaterialDialog
                                    }),
                                    new sap.m.Button({
                                        text: "Export CSV",
                                        icon: "sap-icon://download",
                                        class: "sapUiTinyMarginEnd",
                                        press: exportMaterialsToCSV
                                    }),
                                    new sap.m.Button({
                                        text: "Refresh",
                                        icon: "sap-icon://refresh",
                                        press: function() {
                                            loadMaterials();
                                            sap.m.MessageToast.show("Materials refreshed");
                                        }
                                    })
                                ]
                            }),

                            // Materials Table in ScrollContainer
                            new sap.m.ScrollContainer({
                                height: "400px",
                                vertical: true,
                                horizontal: false,
                                content: [oDialogMaterialsTable]
                            })
                        ]
                    })
                ],
                beginButton: new sap.m.Button({
                    text: "Close",
                    press: function() {
                        oMaterialsDialog.close();
                    }
                })
            });

            // Set model to dialog
            oMaterialsDialog.setModel(oModel);
        }

        function openAddMaterialDialog() {
            if (!oAddMaterialDialog) {
                createAddMaterialDialog();
            }
            clearAddMaterialForm();
            oAddMaterialDialog.open();
        }

        function createAddMaterialDialog() {
            oAddMaterialDialog = new sap.m.Dialog("addMaterialDialog", {
                title: "Add New Material",
                contentWidth: "500px",
                contentHeight: "600px",
                verticalScrolling: false,
                content: [
                    new sap.m.VBox({
                        class: "sapUiMediumMargin",
                        items: [
                            // Material ID
                            new sap.m.Label({text: "Material ID *", class: "sapUiTinyMarginTop"}),
                            new sap.m.Input("addMaterialId", {
                                placeholder: "e.g., MAT001",
                                required: true,
                                maxLength: 20
                            }),

                            // Material Name
                            new sap.m.Label({text: "Material Name *", class: "sapUiTinyMarginTop"}),
                            new sap.m.Input("addMaterialName", {
                                placeholder: "Enter material name",
                                required: true,
                                maxLength: 255
                            }),

                            // Supplier ID
                            new sap.m.Label({text: "Supplier ID *", class: "sapUiTinyMarginTop"}),
                            new sap.m.Input("addMaterialSupplier", {
                                placeholder: "Enter supplier ID (e.g., 9001)",
                                required: true,
                                type: "Number"
                            }),

                            // Quantity
                            new sap.m.Label({text: "Quantity *", class: "sapUiTinyMarginTop"}),
                            new sap.m.Input("addMaterialQuantity", {
                                placeholder: "Enter quantity",
                                required: true,
                                type: "Number"
                            }),

                            // Unit
                            new sap.m.Label({text: "Unit", class: "sapUiTinyMarginTop"}),
                            new sap.m.ComboBox("addMaterialUnit", {
                                placeholder: "Select unit",
                                selectedKey: "pcs",
                                items: [
                                    new sap.ui.core.Item({key: "pcs", text: "Pieces"}),
                                    new sap.ui.core.Item({key: "kg", text: "Kilograms"}),
                                    new sap.ui.core.Item({key: "liters", text: "Liters"}),
                                    new sap.ui.core.Item({key: "meters", text: "Meters"}),
                                    new sap.ui.core.Item({key: "sheets", text: "Sheets"}),
                                    new sap.ui.core.Item({key: "bags", text: "Bags"}),
                                    new sap.ui.core.Item({key: "units", text: "Units"})
                                ]
                            }),

                            // Category
                            new sap.m.Label({text: "Category", class: "sapUiTinyMarginTop"}),
                            new sap.m.ComboBox("addMaterialCategory", {
                                placeholder: "Select category",
                                selectedKey: "General",
                                items: [
                                    new sap.ui.core.Item({key: "General", text: "General"}),
                                    new sap.ui.core.Item({key: "Construction", text: "Construction"}),
                                    new sap.ui.core.Item({key: "Manufacturing", text: "Manufacturing"}),
                                    new sap.ui.core.Item({key: "Logistics", text: "Logistics"})
                                ]
                            })
                        ]
                    })
                ],
                beginButton: new sap.m.Button({
                    text: "Add Material",
                    type: "Emphasized",
                    icon: "sap-icon://add",
                    press: saveNewMaterial
                }),
                endButton: new sap.m.Button({
                    text: "Cancel",
                    press: function() {
                        oAddMaterialDialog.close();
                    }
                })
            });
        }

        function clearAddMaterialForm() {
            sap.ui.getCore().byId("addMaterialId").setValue("");
            sap.ui.getCore().byId("addMaterialName").setValue("");
            sap.ui.getCore().byId("addMaterialSupplier").setValue("");
            sap.ui.getCore().byId("addMaterialQuantity").setValue("");
            sap.ui.getCore().byId("addMaterialUnit").setSelectedKey("pcs");
            sap.ui.getCore().byId("addMaterialCategory").setSelectedKey("General");
        }

        function saveNewMaterial() {
            var sId = sap.ui.getCore().byId("addMaterialId").getValue();
            var sName = sap.ui.getCore().byId("addMaterialName").getValue();
            var sSupplier = sap.ui.getCore().byId("addMaterialSupplier").getValue();
            var iQuantity = parseInt(sap.ui.getCore().byId("addMaterialQuantity").getValue());
            var sUnit = sap.ui.getCore().byId("addMaterialUnit").getSelectedKey();
            var sCategory = sap.ui.getCore().byId("addMaterialCategory").getSelectedKey();

            if (!sId || !sName || !sSupplier || !iQuantity) {
                sap.m.MessageToast.show("Please fill all required fields");
                return;
            }

            // Call backend service
            fetch('/odata/v4/procurement/addMaterial', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    ID: sId,
                    name: sName,
                    supplier: sSupplier,
                    quantity: iQuantity,
                    category: sCategory || "General",
                    unit: sUnit || "pcs"
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    sap.m.MessageToast.show(data.message);
                    loadMaterials(); // Refresh materials and update tile count
                    oAddMaterialDialog.close();
                } else {
                    sap.m.MessageToast.show("Error: " + data.message);
                }
            })
            .catch(error => {
                console.error("Error adding material:", error);
                sap.m.MessageToast.show("Error adding material");
            });
        }

        function openEditMaterialDialog(oMaterial) {
            oCurrentMaterial = oMaterial;
            if (!oEditMaterialDialog) {
                createEditMaterialDialog();
            }
            populateEditMaterialForm(oMaterial);
            oEditMaterialDialog.open();
        }

        function createEditMaterialDialog() {
            oEditMaterialDialog = new sap.m.Dialog("editMaterialDialog", {
                title: "Edit Material",
                contentWidth: "500px",
                contentHeight: "600px",
                verticalScrolling: false,
                content: [
                    new sap.m.VBox({
                        class: "sapUiMediumMargin",
                        items: [
                            // Material ID (Read-only)
                            new sap.m.Label({text: "Material ID", class: "sapUiTinyMarginTop"}),
                            new sap.m.Input("editMaterialId", {
                                editable: false
                            }),

                            // Material Name
                            new sap.m.Label({text: "Material Name *", class: "sapUiTinyMarginTop"}),
                            new sap.m.Input("editMaterialName", {
                                placeholder: "Enter material name",
                                required: true,
                                maxLength: 255
                            }),

                            // Supplier ID
                            new sap.m.Label({text: "Supplier ID *", class: "sapUiTinyMarginTop"}),
                            new sap.m.Input("editMaterialSupplier", {
                                placeholder: "Enter supplier ID",
                                required: true
                            }),

                            // Quantity
                            new sap.m.Label({text: "Quantity *", class: "sapUiTinyMarginTop"}),
                            new sap.m.Input("editMaterialQuantity", {
                                placeholder: "Enter quantity",
                                required: true,
                                type: "Number"
                            }),

                            // Unit
                            new sap.m.Label({text: "Unit", class: "sapUiTinyMarginTop"}),
                            new sap.m.ComboBox("editMaterialUnit", {
                                placeholder: "Select unit",
                                items: [
                                    new sap.ui.core.Item({key: "pcs", text: "Pieces"}),
                                    new sap.ui.core.Item({key: "kg", text: "Kilograms"}),
                                    new sap.ui.core.Item({key: "liters", text: "Liters"}),
                                    new sap.ui.core.Item({key: "meters", text: "Meters"}),
                                    new sap.ui.core.Item({key: "sheets", text: "Sheets"}),
                                    new sap.ui.core.Item({key: "bags", text: "Bags"}),
                                    new sap.ui.core.Item({key: "units", text: "Units"})
                                ]
                            }),

                            // Category
                            new sap.m.Label({text: "Category", class: "sapUiTinyMarginTop"}),
                            new sap.m.ComboBox("editMaterialCategory", {
                                placeholder: "Select category",
                                items: [
                                    new sap.ui.core.Item({key: "General", text: "General"}),
                                    new sap.ui.core.Item({key: "Construction", text: "Construction"}),
                                    new sap.ui.core.Item({key: "Manufacturing", text: "Manufacturing"}),
                                    new sap.ui.core.Item({key: "Logistics", text: "Logistics"})
                                ]
                            }),

                            // Unit Price
                            new sap.m.Label({text: "Unit Price (USD)", class: "sapUiTinyMarginTop"}),
                            new sap.m.Input("editMaterialPrice", {
                                placeholder: "0.00",
                                type: "Number"
                            })
                        ]
                    })
                ],
                beginButton: new sap.m.Button({
                    text: "Save Changes",
                    type: "Emphasized",
                    icon: "sap-icon://save",
                    press: saveEditMaterial
                }),
                endButton: new sap.m.HBox({
                    items: [
                        new sap.m.Button({
                            text: "Delete",
                            type: "Reject",
                            icon: "sap-icon://delete",
                            press: function() {
                                confirmDeleteMaterial(oCurrentMaterial);
                                oEditMaterialDialog.close();
                            }
                        }),
                        new sap.m.Button({
                            text: "Cancel",
                            press: function() {
                                oEditMaterialDialog.close();
                            }
                        })
                    ]
                })
            });
        }

        function populateEditMaterialForm(oMaterial) {
            sap.ui.getCore().byId("editMaterialId").setValue(oMaterial.ID);
            sap.ui.getCore().byId("editMaterialName").setValue(oMaterial.name);
            sap.ui.getCore().byId("editMaterialSupplier").setValue(oMaterial.supplier_ID || "");
            sap.ui.getCore().byId("editMaterialQuantity").setValue(oMaterial.quantity);
            sap.ui.getCore().byId("editMaterialUnit").setSelectedKey(oMaterial.unit || "pcs");
            sap.ui.getCore().byId("editMaterialCategory").setSelectedKey(oMaterial.category || "General");
            sap.ui.getCore().byId("editMaterialPrice").setValue(oMaterial.unitPrice || "");
        }

        function saveEditMaterial() {
            var sName = sap.ui.getCore().byId("editMaterialName").getValue();
            var sSupplier = sap.ui.getCore().byId("editMaterialSupplier").getValue();
            var iQuantity = parseInt(sap.ui.getCore().byId("editMaterialQuantity").getValue());
            var sUnit = sap.ui.getCore().byId("editMaterialUnit").getSelectedKey();
            var sCategory = sap.ui.getCore().byId("editMaterialCategory").getSelectedKey();
            var fPrice = parseFloat(sap.ui.getCore().byId("editMaterialPrice").getValue()) || 0;

            if (!sName || !sSupplier || !iQuantity) {
                sap.m.MessageToast.show("Please fill all required fields");
                return;
            }

            // Call backend service
            fetch('/odata/v4/procurement/Materials(\'' + oCurrentMaterial.ID + '\')', {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    name: sName,
                    supplier_ID: sSupplier,
                    quantity: iQuantity,
                    category: sCategory,
                    unitPrice: fPrice,
                    unit: sUnit
                })
            })
            .then(() => {
                sap.m.MessageToast.show("Material updated successfully");
                loadMaterials(); // Refresh materials and update tile count
                oEditMaterialDialog.close();
            })
            .catch(error => {
                console.error("Error updating material:", error);
                sap.m.MessageToast.show("Error updating material");
            });
        }

        function confirmDeleteMaterial(oMaterial) {
            // Use simple confirm dialog like test-backend.html
            if (confirm(`Are you sure you want to delete material ${oMaterial.ID} (${oMaterial.name})?`)) {
                deleteMaterialFromBackend(oMaterial.ID);
            }
        }

        async function deleteMaterialFromBackend(sMaterialId) {
            sap.m.MessageToast.show(`Deleting material ${sMaterialId}...`);

            try {
                const response = await fetch(`/odata/v4/procurement/Materials('${sMaterialId}')`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    sap.m.MessageToast.show(`‚úÖ Material ${sMaterialId} deleted successfully!`);
                    // Reload materials to reflect the deletion
                    setTimeout(() => {
                        loadMaterials();
                        if (oMaterialsDialog && oMaterialsDialog.isOpen()) {
                            loadMaterialsForDialog();
                        }
                    }, 1000);
                } else {
                    sap.m.MessageToast.show(`‚ùå Delete failed for material ${sMaterialId}`);
                }
            } catch (error) {
                console.error('Error deleting material:', error);
                sap.m.MessageToast.show(`‚ùå Delete error: ${error.message}`);
            }
        }

        function filterDialogMaterials(sQuery) {
            if (!sQuery || !sQuery.trim()) {
                // If no query, reload all materials
                loadMaterialsForDialog();
                return;
            }

            // Use OData filtering like in test-backend.html
            var sQueryLower = sQuery.toLowerCase();
            var sFilterUrl = `/odata/v4/procurement/Materials?$filter=contains(tolower(name),'${sQueryLower}') or contains(tolower(ID),'${sQueryLower}') or contains(tolower(supplier_ID),'${sQueryLower}') or contains(tolower(category),'${sQueryLower}')`;

            fetch(sFilterUrl)
                .then(response => response.json())
                .then(data => {
                    var materials = data.value || [];
                    oModel.setProperty("/materials", materials);
                    console.log(`Search found ${materials.length} materials for query: ${sQuery}`);
                })
                .catch(error => {
                    console.error("Error searching materials:", error);
                    sap.m.MessageToast.show("Error searching materials");
                });
        }

        function loadMaterialsForDialog() {
            // Reload all materials for the dialog
            fetch('/odata/v4/procurement/Materials')
                .then(response => response.json())
                .then(data => {
                    var materials = data.value || [];
                    oModel.setProperty("/materials", materials);
                })
                .catch(error => {
                    console.error("Error loading materials:", error);
                });
        }

        function exportMaterialsToCSV() {
            fetch('/odata/v4/procurement/exportMaterialsToCSV', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.csvData) {
                    var element = document.createElement('a');
                    element.setAttribute('href', 'data:text/csv;charset=utf-8,' + encodeURIComponent(data.csvData));
                    element.setAttribute('download', 'materials_export.csv');
                    element.style.display = 'none';
                    document.body.appendChild(element);
                    element.click();
                    document.body.removeChild(element);
                    sap.m.MessageToast.show("Materials exported successfully!");
                } else {
                    sap.m.MessageToast.show("No data to export");
                }
            })
            .catch(error => {
                console.error("Error exporting materials:", error);
                sap.m.MessageToast.show("Error exporting materials");
            });
        }
        
        function loadMaterials() {
            oModel.setProperty("/loading", true);
            
            fetch('/odata/v4/procurement/Materials')
                .then(response => response.json())
                .then(data => {
                    var materials = data.value || [];
                    oModel.setProperty("/materials", materials);
                    oModel.setProperty("/materialsCount", materials.length);
                    oModel.setProperty("/loading", false);
                    sap.m.MessageToast.show("Materials loaded successfully!");
                })
                .catch(error => {
                    console.error("Error loading materials:", error);
                    oModel.setProperty("/loading", false);
                    sap.m.MessageToast.show("Error loading materials");
                });
        }
        
        function loadSuppliers() {
            // Use $top=5000 to ensure we get all suppliers (3000+)
            fetch('/odata/v4/procurement/Suppliers?$top=5000')
                .then(response => response.json())
                .then(data => {
                    var suppliers = data.value || [];
                    oModel.setProperty("/suppliersCount", suppliers.length);
                    console.log(`Loaded ${suppliers.length} suppliers for tile count`);

                    // Ensure we have the expected 3000+ suppliers
                    if (suppliers.length < 3000) {
                        console.warn(`Expected 3000+ suppliers, but got ${suppliers.length}`);
                    }
                })
                .catch(error => {
                    console.error("Error loading suppliers:", error);
                    // Keep default count of 3000 if loading fails
                });
        }
        
        function initializeChatSession() {
            fetch('/odata/v4/procurement/initChatSession', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'}
            })
            .then(response => response.json())
            .then(data => {
                oChatModel.setProperty("/sessionId", data.sessionId);
                oChatModel.setProperty("/isConnected", true);
            })
            .catch(error => {
                console.error("Error initializing chat:", error);
            });
        }
        
        function sendChatMessage() {
            var oInput = sap.ui.getCore().byId("chatInput");
            var sMessage = oInput.getValue().trim();
            
            if (!sMessage) {
                sap.m.MessageToast.show("Please enter a message");
                return;
            }
            
            addChatMessage(sMessage, "user");
            oInput.setValue("");
            
            var oTypingMessage = addChatMessage("ü§ñ Assistant is typing...", "typing");
            
            var sSessionId = oChatModel.getProperty("/sessionId");
            
            fetch('/odata/v4/procurement/sendChatMessage', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    sessionId: sSessionId,
                    message: sMessage
                })
            })
            .then(response => response.json())
            .then(data => {
                // Remove typing indicator
                var oChatContainer = sap.ui.getCore().byId("chatContainer");
                oChatContainer.removeItem(oTypingMessage);
                
                if (data.success && data.response) {
                    addChatMessage(data.response, "assistant");
                } else {
                    addChatMessage(generateSmartResponse(sMessage), "assistant");
                }
            })
            .catch(error => {
                console.error("Error sending message:", error);
                var oChatContainer = sap.ui.getCore().byId("chatContainer");
                oChatContainer.removeItem(oTypingMessage);
                addChatMessage(generateSmartResponse(sMessage), "assistant");
            });
        }
        
        function addChatMessage(sMessage, sType) {
            var sMessageType = sType === "user" ? "Success" : "Information";
            var sIcon = sType === "user" ? "üë§ You: " : (sType === "typing" ? "" : "ü§ñ Assistant: ");
            
            var oMessage = new sap.m.MessageStrip({
                text: sIcon + sMessage,
                type: sMessageType,
                class: "chatMessage sapUiMediumMarginBottom"
            });
            
            var oChatContainer = sap.ui.getCore().byId("chatContainer");
            oChatContainer.addItem(oMessage);
            
            return oMessage;
        }
        
        function generateSmartResponse(sUserMessage) {
            var sMessage = sUserMessage.toLowerCase();
            
            if (sMessage.includes("laptop") || sMessage.includes("computer")) {
                return "I found 3 suppliers for laptops:\n‚Ä¢ TechCorp India - ‚Çπ42,000/unit, 7 days delivery\n‚Ä¢ Digital Solutions - ‚Çπ48,500/unit, 5 days delivery\n‚Ä¢ CompuWorld - ‚Çπ45,200/unit, 10 days delivery\n\nWould you like me to create a PO or send RFQ?";
            } else if (sMessage.includes("supplier")) {
                return "Here are our top-rated suppliers:\nüèÜ TechCorp India (4.8/5) - Electronics\nüèÜ Furniture Plus (4.6/5) - Office Furniture\nüèÜ Stationery World (4.7/5) - Office Supplies\n\nWhich category interests you?";
            } else {
                return "I understand you're asking about: '" + sUserMessage + "'. I can help with:\n‚Ä¢ Finding suppliers and pricing\n‚Ä¢ Creating purchase orders\n‚Ä¢ Sending RFQs\n‚Ä¢ Checking inventory\n‚Ä¢ Compliance verification\n\nTry using the quick action buttons above or ask me something specific!";
            }
        }
        
        function filterMaterials(sQuery) {
            var oTable = sap.ui.getCore().byId("materialsTable");
            var oBinding = oTable.getBinding("items");
            
            if (sQuery) {
                var oFilter = new sap.ui.model.Filter([
                    new sap.ui.model.Filter("name", sap.ui.model.FilterOperator.Contains, sQuery),
                    new sap.ui.model.Filter("ID", sap.ui.model.FilterOperator.Contains, sQuery)
                ], false);
                oBinding.filter([oFilter]);
            } else {
                oBinding.filter([]);
            }
        }
        
        function deleteMaterial(sMaterialId) {
            fetch('/odata/v4/procurement/Materials(\'' + sMaterialId + '\')', {
                method: 'DELETE'
            })
            .then(() => {
                sap.m.MessageToast.show("Material deleted successfully");
                loadMaterials();
            })
            .catch(error => {
                console.error("Error deleting material:", error);
                sap.m.MessageToast.show("Error deleting material");
            });
        }
        
        function openSuppliersDialog() {
            if (!oSuppliersDialog) {
                createSuppliersDialog();
            }
            loadSuppliersForDialog();
            oSuppliersDialog.open();
        }

        function createSuppliersDialog() {
            // Create Suppliers Table for Dialog
            var oDialogSuppliersTable = new sap.m.Table("dialogSuppliersTable", {
                growing: true,
                growingThreshold: 100,
                growingScrollToLoad: false,
                growingTriggerText: "Load More Suppliers ({0})",
                mode: "None",
                columns: [
                    new sap.m.Column({
                        header: new sap.m.Text({text: "ID"}),
                        minScreenWidth: "Tablet",
                        demandPopin: true
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Category"}),
                        minScreenWidth: "Desktop",
                        demandPopin: true
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Company Name"}),
                        minScreenWidth: "Tablet",
                        demandPopin: true
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Material"}),
                        minScreenWidth: "Desktop",
                        demandPopin: true
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Region"}),
                        minScreenWidth: "Desktop",
                        demandPopin: true
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Lead Time"}),
                        minScreenWidth: "Desktop",
                        demandPopin: true
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Contact Email"}),
                        minScreenWidth: "Desktop",
                        demandPopin: true
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({text: "Rating"}),
                        minScreenWidth: "Desktop",
                        demandPopin: true
                    })
                ]
            });

            // Bind items to the dialog table
            oDialogSuppliersTable.bindItems({
                path: "/suppliers",
                template: new sap.m.ColumnListItem({
                    cells: [
                        new sap.m.Text({text: "{ID}"}),
                        new sap.m.Text({text: "{category}"}),
                        new sap.m.Text({text: "{name}"}),
                        new sap.m.Text({text: "{material}"}),
                        new sap.m.Text({text: "{region}"}),
                        new sap.m.Text({text: "{leadTime} days"}),
                        new sap.m.Text({text: "{contactEmail}"}),
                        new sap.m.Text({
                            text: "{rating}",
                            class: {
                                path: "rating",
                                formatter: function(rating) {
                                    var numRating = parseFloat(rating);
                                    if (numRating >= 4.50) return "ratingGreen";      // Green: 4.50-5.00
                                    if (numRating >= 4.00) return "ratingLightGreen"; // Light Green: 4.00-4.49
                                    if (numRating >= 3.50) return "ratingYellow";     // Yellow: 3.50-3.99
                                    if (numRating >= 3.00) return "ratingOrange";     // Orange: 3.00-3.49
                                    if (numRating >= 2.50) return "ratingDarkOrange"; // Dark Orange: 2.50-2.99
                                    return "ratingRed";                               // Red: Below 2.49
                                }
                            }
                        })
                    ]
                })
            });

            // Create the main Suppliers Dialog
            oSuppliersDialog = new sap.m.Dialog("suppliersDialog", {
                title: "Active Suppliers Directory",
                contentWidth: "90%",
                contentHeight: "80%",
                verticalScrolling: true,
                horizontalScrolling: false,
                content: [
                    new sap.m.VBox({
                        items: [
                            // Search and Filter Bar
                            new sap.m.Bar({
                                contentLeft: [
                                    new sap.m.SearchField("dialogSuppliersSearchField", {
                                        placeholder: "Search suppliers by company name, category, region, material...",
                                        width: "400px",
                                        search: function(oEvent) {
                                            var sQuery = oEvent.getParameter("query");
                                            filterDialogSuppliers(sQuery);
                                        }
                                    })
                                ],
                                contentRight: [
                                    new sap.m.Button({
                                        text: "Refresh",
                                        icon: "sap-icon://refresh",
                                        press: function() {
                                            loadSuppliersForDialog();
                                            sap.m.MessageToast.show("Suppliers refreshed");
                                        }
                                    })
                                ]
                            }),

                            // Suppliers Table in ScrollContainer
                            new sap.m.ScrollContainer({
                                height: "500px",
                                vertical: true,
                                horizontal: false,
                                content: [oDialogSuppliersTable]
                            })
                        ]
                    })
                ],
                beginButton: new sap.m.Button({
                    text: "Close",
                    press: function() {
                        oSuppliersDialog.close();
                    }
                })
            });

            // Set model to dialog
            oSuppliersDialog.setModel(oModel);
        }

        function loadSuppliersForDialog() {
            // Use $top=5000 to ensure we get all suppliers (3000+)
            fetch('/odata/v4/procurement/Suppliers?$top=5000')
                .then(response => response.json())
                .then(data => {
                    var suppliers = data.value || [];

                    console.log(`Fetched ${suppliers.length} suppliers from backend`);

                    // Randomize the suppliers array to show random data instead of sorted by ID
                    suppliers = shuffleArray(suppliers);

                    oModel.setProperty("/suppliers", suppliers);
                    console.log(`Loaded ${suppliers.length} suppliers for dialog`);
                    sap.m.MessageToast.show(` Loaded ${suppliers.length} suppliers`);

                    // Ensure we have the expected 3000+ suppliers
                    if (suppliers.length < 3000) {
                        console.warn(`Expected 3000+ suppliers, but got ${suppliers.length}`);
                        sap.m.MessageToast.show(`‚ö†Ô∏è Warning: Only ${suppliers.length} suppliers loaded (expected 3000+)`);
                    }
                })
                .catch(error => {
                    console.error("Error loading suppliers:", error);
                    sap.m.MessageToast.show(" Error loading suppliers");
                });
        }

        // Function to shuffle array randomly
        function shuffleArray(array) {
            var shuffled = [...array]; // Create a copy
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function filterDialogSuppliers(sQuery) {
            if (!sQuery || !sQuery.trim()) {
                // If no query, reload all suppliers
                loadSuppliersForDialog();
                return;
            }

            // Use OData filtering for suppliers with correct field names
            var sQueryLower = sQuery.toLowerCase();
            var sFilterUrl = `/odata/v4/procurement/Suppliers?$filter=contains(tolower(name),'${sQueryLower}') or contains(tolower(category),'${sQueryLower}') or contains(tolower(region),'${sQueryLower}') or contains(tolower(material),'${sQueryLower}') or contains(tolower(contactEmail),'${sQueryLower}')`;

            fetch(sFilterUrl)
                .then(response => response.json())
                .then(data => {
                    var suppliers = data.value || [];
                    oModel.setProperty("/suppliers", suppliers);
                    console.log(`Search found ${suppliers.length} suppliers for query: ${sQuery}`);
                    if (suppliers.length === 0) {
                        sap.m.MessageToast.show(`No suppliers found for "${sQuery}"`);
                    }
                })
                .catch(error => {
                    console.error("Error searching suppliers:", error);
                    sap.m.MessageToast.show("Error searching suppliers");
                });
        }

        function openAIAssistantDialog() {
            if (!oAIAssistantDialog) {
                createAIAssistantDialog();
            }
            oAIAssistantDialog.open();
        }

        function openOrderManuallyPage() {
            if (!oOrderManuallyDialog) {
                createOrderManuallyDialog();
            }
            oOrderManuallyDialog.open();
            loadSuppliersForOrdering();
        }

        function createAIAssistantDialog() {
            // Chat Messages Container with WhatsApp styling
            var oChatContainer = new sap.m.VBox("aiChatContainer", {
                class: "chatContainer"
            });

            // Simple Chat Input
            var oChatInput = new sap.m.TextArea("aiChatInput", {
                placeholder: "Type a message...",
                growing: true,
                growingMaxLines: 3,
                width: "100%",
                showExceededText: false,
                valueLiveUpdate: true
            });

            // Create the AI Assistant Dialog
            oAIAssistantDialog = new sap.m.Dialog("aiAssistantDialog", {
                contentWidth: "85%",
                contentHeight: "90%",
                verticalScrolling: false,
                horizontalScrolling: false,
                customHeader: new sap.m.Bar({
                    contentLeft: [
                        new sap.ui.core.Icon({
                            src: "sap-icon://ai",
                            size: "1.5rem",
                            color: "#0070f3",
                            class: "sapUiTinyMarginEnd"
                        }),
                        new sap.m.Title({
                            text: "My Dear Assistant - AI Procurement Chat",
                            level: "H4"
                        })
                    ],
                    contentRight: [
                        new sap.m.Button({
                            icon: "sap-icon://information",
                            type: "Transparent",
                            tooltip: "AI Status",
                            press: toggleStatusCard
                        }),

                        new sap.m.MenuButton({
                            icon: "sap-icon://sys-help",
                            type: "Transparent",
                            tooltip: "Help",
                            menu: new sap.m.Menu({
                                items: [
                                    new sap.m.MenuItem({
                                        text: "Extract Chat",
                                        icon: "sap-icon://download",
                                        press: extractChatHistory
                                    }),
                                    new sap.m.MenuItem({
                                        text: "Support",
                                        icon: "sap-icon://customer-and-contacts",
                                        press: function() {
                                            sap.m.MessageToast.show("Sorry, not available for now");
                                        }
                                    })
                                ]
                            })
                        }),
                        new sap.m.Button({
                            icon: "sap-icon://decline",
                            type: "Transparent",
                            tooltip: "Close",
                            press: function() {
                                oAIAssistantDialog.close();
                            }
                        })
                    ]
                }),
                content: [
                    new sap.m.Page({
                        showHeader: false,
                        content: [
                            // Status Card (initially hidden)
                            new sap.m.Panel("statusCard", {
                                visible: false,
                                class: "sapUiTinyMarginBottom",
                                content: [
                                    new sap.m.VBox({
                                        class: "sapUiSmallMargin",
                                        items: [
                                            new sap.m.ObjectStatus({
                                                text: "Gemini 1.5 Flash Connected",
                                                state: "Success",
                                                icon: "sap-icon://connected"
                                            }),
                                            new sap.m.ObjectStatus({
                                                text: "Procurement Knowledge Base Active",
                                                state: "Information",
                                                icon: "sap-icon://database"
                                            }),
                                            new sap.m.ObjectStatus({
                                                text: "Real-time Data Access Enabled",
                                                state: "Warning",
                                                icon: "sap-icon://refresh"
                                            })
                                        ]
                                    })
                                ]
                            }),

                            // Quick Actions with SAP icons
                            new sap.m.Panel({
                                headerText: "Quick Actions",
                                expandable: true,
                                expanded: true,
                                class: "sapUiMediumMarginBottom",
                                content: [
                                    new sap.m.FlexBox({
                                        wrap: "Wrap",
                                        justifyContent: "SpaceAround",
                                        class: "sapUiMediumMargin",
                                        items: [
                                            new sap.m.Button({
                                                text: "Create PO",
                                                icon: "sap-icon://create-form",
                                                type: "Emphasized",
                                                class: "quickActionBtn sapUiTinyMargin",
                                                press: function() {
                                                    addAIChatMessage("Create Purchase Order", "user");
                                                    sendToGemini("I need help creating a Purchase Order. What materials do you need?");
                                                }
                                            }),
                                            new sap.m.Button({
                                                text: "Send RFQ",
                                                icon: "sap-icon://email",
                                                type: "Accept",
                                                class: "quickActionBtn sapUiTinyMargin",
                                                press: function() {
                                                    addAIChatMessage("Send RFQ", "user");
                                                    sendToGemini("I need to send a Request for Quotation. Which suppliers should I contact?");
                                                }
                                            }),
                                            new sap.m.Button({
                                                text: "Find Suppliers",
                                                icon: "sap-icon://supplier",
                                                type: "Accept",
                                                class: "quickActionBtn sapUiTinyMargin",
                                                press: function() {
                                                    addAIChatMessage("Find Suppliers", "user");
                                                    sendToGemini("I need to find suppliers. What type of materials are you looking for?");
                                                }
                                            }),
                                            new sap.m.Button({
                                                text: "Check Inventory",
                                                icon: "sap-icon://inventory",
                                                type: "Neutral",
                                                class: "quickActionBtn sapUiTinyMargin",
                                                press: function() {
                                                    addAIChatMessage("Check Inventory", "user");
                                                    sendToGemini("Please check my current inventory status");
                                                }
                                            }),
                                            new sap.m.Button({
                                                text: "Smart Search",
                                                icon: "sap-icon://search",
                                                type: "Ghost",
                                                class: "quickActionBtn sapUiTinyMargin",
                                                press: function() {
                                                    addAIChatMessage("Smart Search", "user");
                                                    sendToGemini("Help me search for specific materials or suppliers");
                                                }
                                            }),
                                            new sap.m.Button({
                                                text: "Market Insights",
                                                icon: "sap-icon://trend-up",
                                                type: "Transparent",
                                                class: "quickActionBtn sapUiTinyMargin",
                                                press: function() {
                                                    addAIChatMessage("Market Insights", "user");
                                                    sendToGemini("Show me current market insights and procurement trends");
                                                }
                                            })
                                        ]
                                    })
                                ]
                            }),

                            // Chat Messages Area - Full height scrollable
                            new sap.m.ScrollContainer({
                                height: "100%",
                                vertical: true,
                                content: [oChatContainer]
                            })
                        ],
                        footer: new sap.m.Toolbar({
                            height: "80px",
                            content: [
                                new sap.m.TextArea("chatTextArea", {
                                    placeholder: "Type your message here... (e.g., 'Find laptops under ‚Çπ50K')",
                                    growing: false,
                                    rows: 1,
                                    width: "100%",
                                    class: "sapUiTinyMarginEnd",
                                    liveChange: function(oEvent) {
                                        var sValue = oEvent.getParameter("value");
                                        var oSendBtn = sap.ui.getCore().byId("chatSendBtn");
                                        if (oSendBtn) {
                                            oSendBtn.setEnabled(sValue.trim().length > 0);
                                        }
                                    }
                                }),
                                new sap.m.Button("chatSendBtn", {
                                    icon: "sap-icon://paper-plane",
                                    type: "Emphasized",
                                    enabled: false,
                                    height: "60px",
                                    width: "100px",
                                    press: function() {
                                        var oTextArea = sap.ui.getCore().byId("chatTextArea");
                                        var sMessage = oTextArea.getValue().trim();
                                        if (sMessage) {
                                            addAIChatMessage(sMessage, "user");
                                            sendToGemini(sMessage);
                                            oTextArea.setValue("");
                                            this.setEnabled(false);
                                        }
                                    }
                                })
                            ]
                        })
                    })
                ]
            });

            // Initialize chat with welcome messages
            setTimeout(() => {
                initializeAIChat();
                // Check Gemini connection status every 30 seconds
                setInterval(checkGeminiConnection, 30000);
            }, 500);
        }

        function toggleStatusCard() {
            var oStatusCard = sap.ui.getCore().byId("statusCard");
            if (oStatusCard) {
                oStatusCard.setVisible(!oStatusCard.getVisible());
            }
        }

        function createOrderManuallyDialog() {
            // Create suppliers table for ordering - matching Active Suppliers structure
            var oOrderSuppliersTable = new sap.m.Table("orderSuppliersTable", {
                growing: true,
                growingThreshold: 20,
                growingScrollToLoad: true,
                columns: [
                    new sap.m.Column({
                        header: new sap.m.Text({ text: "Category" }),
                        width: "15%"
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({ text: "Company Name" }),
                        width: "20%"
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({ text: "Material" }),
                        width: "15%"
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({ text: "Region" }),
                        width: "15%"
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({ text: "Lead Time" }),
                        width: "10%"
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({ text: "Rating" }),
                        width: "10%"
                    }),
                    new sap.m.Column({
                        header: new sap.m.Text({ text: "Actions" }),
                        width: "15%"
                    })
                ]
            });

            // Create search field for suppliers
            var oOrderSupplierSearchField = new sap.m.SearchField("orderSupplierSearch", {
                placeholder: "Search suppliers by name, category, material, or region...",
                width: "100%",
                search: function(oEvent) {
                    var sQuery = oEvent.getParameter("query");
                    searchOrderSuppliers(sQuery);
                }
            });

            // Create filter bar
            var oOrderFilterBar = new sap.m.HBox({
                wrap: "Wrap",
                class: "sapUiMediumMarginBottom",
                items: [
                    new sap.m.ComboBox("orderCategoryFilter", {
                        placeholder: "Filter by Category",
                        width: "200px",
                        class: "sapUiTinyMarginEnd",
                        items: [
                            new sap.ui.core.Item({ key: "", text: "All Categories" }),
                            new sap.ui.core.Item({ key: "Manufacturing", text: "Manufacturing" }),
                            new sap.ui.core.Item({ key: "Construction", text: "Construction" }),
                            new sap.ui.core.Item({ key: "Logistics", text: "Logistics" }),
                            new sap.ui.core.Item({ key: "Electronics", text: "Electronics" })
                        ],
                        selectionChange: function() {
                            filterOrderSuppliersByCategory();
                        }
                    }),
                    new sap.m.ComboBox("orderRegionFilter", {
                        placeholder: "Filter by Region",
                        width: "200px",
                        class: "sapUiTinyMarginEnd",
                        items: [
                            new sap.ui.core.Item({ key: "", text: "All Regions" }),
                            new sap.ui.core.Item({ key: "Africa", text: "Africa" }),
                            new sap.ui.core.Item({ key: "Asia", text: "Asia" }),
                            new sap.ui.core.Item({ key: "Americas", text: "Americas" }),
                            new sap.ui.core.Item({ key: "Europe", text: "Europe" }),
                            new sap.ui.core.Item({ key: "Oceania", text: "Oceania" })
                        ],
                        selectionChange: function() {
                            filterOrderSuppliersByCategory();
                        }
                    }),
                    new sap.m.Button({
                        text: "Clear Filters",
                        type: "Transparent",
                        press: function() {
                            clearOrderFilters();
                        }
                    })
                ]
            });

            oOrderManuallyDialog = new sap.m.Dialog("orderManuallyDialog", {
                title: "Order Manually - Select Supplier",
                contentWidth: "95%",
                contentHeight: "85%",
                verticalScrolling: false,
                content: [
                    new sap.m.Page({
                        showHeader: false,
                        content: [
                            new sap.m.Panel({
                                headerText: "Search & Filter Suppliers",
                                expandable: true,
                                expanded: true,
                                class: "sapUiMediumMarginBottom",
                                content: [
                                    new sap.m.VBox({
                                        class: "sapUiMediumMargin",
                                        items: [
                                            oOrderSupplierSearchField,
                                            oOrderFilterBar
                                        ]
                                    })
                                ]
                            }),

                            // Suppliers Table in ScrollContainer
                            new sap.m.ScrollContainer({
                                height: "100%",
                                vertical: true,
                                horizontal: false,
                                content: [oOrderSuppliersTable]
                            })
                        ]
                    })
                ],
                beginButton: new sap.m.Button({
                    text: "Close",
                    press: function() {
                        oOrderManuallyDialog.close();
                    }
                })
            });
        }

        function openSupplierDetailsDialog(oSupplier) {
            oCurrentSupplier = oSupplier;
            if (!oSupplierDetailsDialog) {
                createSupplierDetailsDialog();
            }

            // Populate supplier details
            populateSupplierDetails(oSupplier);
            oSupplierDetailsDialog.open();
        }

        function createSupplierDetailsDialog() {
            oSupplierDetailsDialog = new sap.m.Dialog("supplierDetailsDialog", {
                title: "Supplier Details",
                contentWidth: "70%",
                contentHeight: "70%",
                content: [
                    new sap.m.Page({
                        showHeader: false,
                        content: [
                            new sap.m.ObjectHeader("supplierObjectHeader", {
                                title: "{name}",
                                number: "{rating}",
                                numberUnit: "‚òÖ",
                                attributes: [
                                    new sap.m.ObjectAttribute({
                                        title: "Category",
                                        text: "{category}"
                                    }),
                                    new sap.m.ObjectAttribute({
                                        title: "Location",
                                        text: "{location}"
                                    }),
                                    new sap.m.ObjectAttribute({
                                        title: "Contact",
                                        text: "{contact}"
                                    })
                                ]
                            }),

                            new sap.m.Panel({
                                headerText: "Available Products",
                                class: "sapUiMediumMarginTop",
                                content: [
                                    new sap.m.List("supplierProductsList", {
                                        items: {
                                            path: "/products",
                                            template: new sap.m.StandardListItem({
                                                title: "{name}",
                                                description: "{description}",
                                                info: "‚Çπ{price}",
                                                infoState: "Success"
                                            })
                                        }
                                    })
                                ]
                            })
                        ]
                    })
                ],
                beginButton: new sap.m.Button({
                    text: "Send RFQ",
                    type: "Emphasized",
                    icon: "sap-icon://email",
                    press: function() {
                        openRFQDialog(oCurrentSupplier);
                    }
                }),
                endButton: new sap.m.Button({
                    text: "Close",
                    press: function() {
                        oSupplierDetailsDialog.close();
                    }
                }),
                afterClose: function() {
                    oSupplierDetailsDialog.close();
                }
            });
        }

        function openRFQDialog(oSupplier) {
            console.log('üîµ openRFQDialog called with supplier:', oSupplier);
            if (!oRFQDialog) {
                console.log('üîß Creating RFQ dialog...');
                createRFQDialog();
            }

            // Generate RFQ details
            console.log('üìã Generating RFQ details...');
            generateRFQDetails(oSupplier);
            console.log('üöÄ Opening RFQ dialog...');
            oRFQDialog.open();
        }

        function createRFQDialog() {
            oRFQDialog = new sap.m.Dialog("rfqDialog", {
                title: "Request for Quotation (RFQ)",
                contentWidth: "85%",
                contentHeight: "80%",
                content: [
                    new sap.m.Page({
                        showHeader: false,
                        content: [
                            new sap.m.Panel({
                                headerText: "RFQ Details",
                                content: [
                                    new sap.m.VBox({
                                        class: "sapUiMediumMargin",
                                        items: [
                                            new sap.m.Label({
                                                text: "RFQ Number:",
                                                class: "sapUiTinyMarginBottom"
                                            }),
                                            new sap.m.Text("rfqNumber", {
                                                class: "sapUiMediumMarginBottom"
                                            }),

                                            // Supplier Details Section
                                            new sap.m.Panel({
                                                headerText: "Supplier Information",
                                                class: "sapUiMediumMarginTop",
                                                content: [
                                                    new sap.m.VBox("rfqSupplierDetails", {
                                                        class: "sapUiMediumMargin"
                                                    })
                                                ]
                                            }),

                                            // Products Selection Section
                                            new sap.m.Panel({
                                                headerText: "Products",
                                                class: "sapUiMediumMarginTop",
                                                content: [
                                                    new sap.m.VBox({
                                                        class: "sapUiMediumMargin",
                                                        items: [
                                                            new sap.m.Table("rfqProductsTable", {
                                                                columns: [
                                                                    new sap.m.Column({
                                                                        header: new sap.m.Text({text: "Select"})
                                                                    }),
                                                                    new sap.m.Column({
                                                                        header: new sap.m.Text({text: "Product"})
                                                                    }),
                                                                    new sap.m.Column({
                                                                        header: new sap.m.Text({text: "Units"})
                                                                    }),
                                                                    new sap.m.Column({
                                                                        header: new sap.m.Text({text: "Unit Price"})
                                                                    }),
                                                                    new sap.m.Column({
                                                                        header: new sap.m.Text({text: "Total"})
                                                                    })
                                                                ]
                                                            })
                                                        ]
                                                    })
                                                ]
                                            }),

                                            new sap.m.Panel({
                                                headerText: "Estimated Pricing",
                                                class: "sapUiMediumMarginTop",
                                                content: [
                                                    new sap.m.VBox("rfqPricing", {
                                                        class: "sapUiMediumMargin"
                                                    })
                                                ]
                                            })
                                        ]
                                    })
                                ]
                            })
                        ]
                    })
                ],
                beginButton: new sap.m.Button({
                    text: "Place Order",
                    type: "Accept",
                    icon: "sap-icon://create-form",
                    press: function() {
                        console.log('üî¥ PLACE ORDER BUTTON CLICKED!');
                        alert('Place Order button clicked!'); // Immediate visual feedback
                        try {
                            placeOrderFromRFQ();
                        } catch (error) {
                            console.error('üí• Error in placeOrderFromRFQ:', error);
                            alert('Error: ' + error.message);
                        }
                    }
                }),
                endButton: new sap.m.Button({
                    text: "Cancel",
                    press: function() {
                        oRFQDialog.close();
                    }
                })
            });
        }

        function loadSuppliersForOrdering() {
            fetch('/odata/v4/procurement/Suppliers')
                .then(response => response.json())
                .then(data => {
                    var oModel = new sap.ui.model.json.JSONModel(data.value);
                    var oTable = sap.ui.getCore().byId("orderSuppliersTable");
                    if (oTable) {
                        oTable.setModel(oModel);
                        oTable.bindItems({
                            path: "/",
                            template: new sap.m.ColumnListItem({
                                cells: [
                                    new sap.m.Text({ text: "{category}" }),
                                    new sap.m.Text({ text: "{name}" }),
                                    new sap.m.Text({ text: "{material}" }),
                                    new sap.m.Text({ text: "{region}" }),
                                    new sap.m.Text({ text: "{leadTime}" }),
                                    new sap.m.Text({ text: "{rating}" }),
                                    new sap.m.Button({
                                        text: "View Details",
                                        type: "Emphasized",
                                        icon: "sap-icon://detail-view",
                                        press: function(oEvent) {
                                            var oContext = oEvent.getSource().getBindingContext();
                                            var oSupplier = oContext.getObject();
                                            openSupplierDetailsDialog(oSupplier);
                                        }
                                    })
                                ]
                            })
                        });

                        // Update count display
                        updateOrderSuppliersCount(data.value.length);
                    }
                })
                .catch(error => {
                    console.error("Error loading suppliers:", error);
                    sap.m.MessageToast.show("Error loading suppliers");
                });
        }

        function searchOrderSuppliers(sQuery) {
            var oTable = sap.ui.getCore().byId("orderSuppliersTable");
            var oBinding = oTable.getBinding("items");

            if (sQuery && sQuery.length > 0) {
                var oFilter = new sap.ui.model.Filter([
                    new sap.ui.model.Filter("name", sap.ui.model.FilterOperator.Contains, sQuery),
                    new sap.ui.model.Filter("category", sap.ui.model.FilterOperator.Contains, sQuery),
                    new sap.ui.model.Filter("material", sap.ui.model.FilterOperator.Contains, sQuery),
                    new sap.ui.model.Filter("region", sap.ui.model.FilterOperator.Contains, sQuery)
                ], false);
                oBinding.filter([oFilter]);
            } else {
                oBinding.filter([]);
            }

            // Update count after search
            setTimeout(() => {
                var iFilteredCount = oBinding.getLength();
                updateOrderSuppliersCount(iFilteredCount);
            }, 100);
        }

        function filterOrderSuppliersByCategory() {
            var oCategoryFilter = sap.ui.getCore().byId("orderCategoryFilter");
            var oRegionFilter = sap.ui.getCore().byId("orderRegionFilter");
            var oTable = sap.ui.getCore().byId("orderSuppliersTable");
            var oBinding = oTable.getBinding("items");

            var aFilters = [];

            if (oCategoryFilter && oCategoryFilter.getSelectedKey()) {
                aFilters.push(new sap.ui.model.Filter("category", sap.ui.model.FilterOperator.EQ, oCategoryFilter.getSelectedKey()));
            }

            if (oRegionFilter && oRegionFilter.getSelectedKey()) {
                aFilters.push(new sap.ui.model.Filter("region", sap.ui.model.FilterOperator.Contains, oRegionFilter.getSelectedKey()));
            }

            oBinding.filter(aFilters);

            // Update count after filter
            setTimeout(() => {
                var iFilteredCount = oBinding.getLength();
                updateOrderSuppliersCount(iFilteredCount);
            }, 100);
        }

        function clearOrderFilters() {
            var oCategoryFilter = sap.ui.getCore().byId("orderCategoryFilter");
            var oRegionFilter = sap.ui.getCore().byId("orderRegionFilter");
            var oSearchField = sap.ui.getCore().byId("orderSupplierSearch");
            var oTable = sap.ui.getCore().byId("orderSuppliersTable");

            if (oCategoryFilter) oCategoryFilter.setSelectedKey("");
            if (oRegionFilter) oRegionFilter.setSelectedKey("");
            if (oSearchField) oSearchField.setValue("");

            if (oTable) {
                var oBinding = oTable.getBinding("items");
                oBinding.filter([]);

                // Update count after clearing filters
                setTimeout(() => {
                    var iTotalCount = oBinding.getLength();
                    updateOrderSuppliersCount(iTotalCount);
                }, 100);
            }
        }

        function updateOrderSuppliersCount(iCount) {
            var oDialog = sap.ui.getCore().byId("orderManuallyDialog");
            if (oDialog) {
                oDialog.setTitle("Order Manually - Select Supplier (" + iCount + " suppliers)");
            }
        }

        function populateSupplierDetails(oSupplier) {
            // Fetch products for this supplier from the backend
            fetch(`/odata/v4/procurement/SupplierProducts?$filter=supplier_ID eq ${oSupplier.ID}`)
                .then(response => response.json())
                .then(data => {
                    var oSupplierModel = new sap.ui.model.json.JSONModel({
                        ...oSupplier,
                        products: data.value || []
                    });

                    var oHeader = sap.ui.getCore().byId("supplierObjectHeader");
                    if (oHeader) {
                        oHeader.setModel(oSupplierModel);
                        oHeader.bindElement("/");
                    }

                    var oList = sap.ui.getCore().byId("supplierProductsList");
                    if (oList) {
                        oList.setModel(oSupplierModel);
                    }
                })
                .catch(error => {
                    console.error("Error loading supplier products:", error);
                    // Fallback to supplier data without products
                    var oSupplierModel = new sap.ui.model.json.JSONModel({
                        ...oSupplier,
                        products: []
                    });

                    var oHeader = sap.ui.getCore().byId("supplierObjectHeader");
                    if (oHeader) {
                        oHeader.setModel(oSupplierModel);
                        oHeader.bindElement("/");
                    }
                });
        }

        // Global variables for RFQ
        var oCurrentRFQSupplier = null;
        var aSelectedProducts = [];
        var sCurrentRFQNumber = "";

        // Test function for debugging (can be called from browser console)
        window.testRFQFlow = function() {
            console.log('üß™ Testing RFQ Flow from browser...');
            console.log('üìã Current RFQ Number:', sCurrentRFQNumber);
            console.log('üè≠ Current RFQ Supplier:', oCurrentRFQSupplier);
            console.log('üì¶ Selected Products:', aSelectedProducts);

            if (!oCurrentRFQSupplier) {
                console.log('‚ùå No supplier selected. Simulating supplier...');
                oCurrentRFQSupplier = {
                    ID: 1001,
                    name: "Test Supplier",
                    category: "Manufacturing",
                    material: "Test Material",
                    leadTime: "7-10 days",
                    contact: "test@supplier.com",
                    location: "Test Location"
                };
            }

            if (!sCurrentRFQNumber) {
                sCurrentRFQNumber = "RFQ-" + Date.now();
                console.log('üìã Generated RFQ Number:', sCurrentRFQNumber);
            }

            if (aSelectedProducts.length === 0) {
                console.log('üì¶ No products selected. Simulating products...');
                aSelectedProducts = [
                    {ID: "P1", name: "Test Product 1", description: "Test Description 1", price: "100", index: 0},
                    {ID: "P2", name: "Test Product 2", description: "Test Description 2", price: "150", index: 1}
                ];
            }

            console.log('üöÄ Calling processOrderPlacement...');
            processOrderPlacement();
        };

        // Test function to check if placeOrderFromRFQ is accessible
        window.testPlaceOrder = function() {
            console.log('üß™ Testing Place Order function...');
            try {
                placeOrderFromRFQ();
            } catch (error) {
                console.error('üí• Error calling placeOrderFromRFQ:', error);
            }
        };

        // Make placeOrderFromRFQ globally accessible for debugging
        window.placeOrderFromRFQ = placeOrderFromRFQ;

        // Simple test to check if the button works
        window.testRFQButton = function() {
            console.log('üß™ Testing RFQ Button...');

            // Check if RFQ dialog exists
            var rfqDialog = sap.ui.getCore().byId("rfqDialog");
            console.log('üìã RFQ Dialog exists:', !!rfqDialog);

            if (rfqDialog) {
                var beginButton = rfqDialog.getBeginButton();
                console.log('üîò Begin button exists:', !!beginButton);
                if (beginButton) {
                    console.log('üîò Button text:', beginButton.getText());
                    console.log('üîò Button enabled:', beginButton.getEnabled());

                    // Simulate button press
                    console.log('üîò Simulating button press...');
                    beginButton.firePress();
                }
            } else {
                console.log('‚ùå RFQ Dialog not found. Creating it...');
                createRFQDialog();
                setTimeout(function() {
                    window.testRFQButton();
                }, 100);
            }
        };

        // Complete RFQ flow test
        window.testCompleteRFQFlow = function() {
            console.log('üöÄ Testing Complete RFQ Flow...');

            // Step 1: Set up test supplier
            oCurrentRFQSupplier = {
                ID: 1001,
                name: "Test Supplier Co",
                category: "Manufacturing",
                material: "Test Materials",
                leadTime: "5-7 days",
                contact: "test@supplier.com",
                location: "Test City"
            };

            // Step 2: Set up RFQ number
            sCurrentRFQNumber = "RFQ-TEST-" + Date.now();

            // Step 3: Set up selected products
            aSelectedProducts = [
                {
                    ID: "P1",
                    name: "Test Product 1",
                    description: "Test Description 1",
                    price: "100",
                    index: 0
                },
                {
                    ID: "P2",
                    name: "Test Product 2",
                    description: "Test Description 2",
                    price: "200",
                    index: 1
                }
            ];

            console.log('‚úÖ Test data set up:');
            console.log('üìã RFQ Number:', sCurrentRFQNumber);
            console.log('üè≠ Supplier:', oCurrentRFQSupplier.name);
            console.log('üì¶ Products:', aSelectedProducts.length);

            // Step 4: Test the place order function
            console.log('üöÄ Calling placeOrderFromRFQ...');
            placeOrderFromRFQ();
        };

        // Test function to compare data formats
        window.testDataFormats = function() {
            console.log('üîç Testing Data Formats...');

            // Format 1: Manual working format (from our test script)
            var manualFormat = {
                ID: "RFQ-MANUAL-" + Date.now(),
                name: "Manual Test Material",
                supplierName: "Manual Test Supplier",
                quantity: 5,
                category: "Manufacturing",
                unitPrice: 100.00,
                currency: "USD",
                unit: "pcs",
                description: "Manually created test material",
                location: "Warehouse A",
                deliveryPeriod: "7-10 days"
            };

            // Format 2: Function format (what our RFQ function creates)
            var functionFormat = {
                ID: "RFQ-FUNCTION-" + Date.now() + "-P1",
                name: "Function Test Material",
                supplierName: "Function Test Supplier",
                quantity: 3,
                category: "Manufacturing",
                unitPrice: 150,
                currency: "USD",
                unit: "pcs",
                description: "Function created test material",
                location: "Warehouse A",
                deliveryPeriod: "5-7 days"
            };

            console.log('üìã Manual Format:', JSON.stringify(manualFormat, null, 2));
            console.log('üìã Function Format:', JSON.stringify(functionFormat, null, 2));

            // Test both formats
            console.log('üß™ Testing manual format...');
            fetch('/odata/v4/procurement/addMaterial', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(manualFormat)
            })
            .then(response => response.json())
            .then(result => {
                console.log('‚úÖ Manual format result:', result);

                console.log('üß™ Testing function format...');
                return fetch('/odata/v4/procurement/addMaterial', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(functionFormat)
                });
            })
            .then(response => response.json())
            .then(result => {
                console.log('‚úÖ Function format result:', result);
            })
            .catch(error => {
                console.error('üí• Error testing formats:', error);
            });
        };

        function generateRFQDetails(oSupplier) {
            console.log('üîß generateRFQDetails called with supplier:', oSupplier);
            oCurrentRFQSupplier = oSupplier;
            sCurrentRFQNumber = "RFQ-" + Date.now();
            aSelectedProducts = []; // Reset selected products

            console.log('üìã Generated RFQ Number:', sCurrentRFQNumber);
            console.log('üè≠ Current RFQ Supplier:', oCurrentRFQSupplier);

            // Set RFQ Number
            var oRFQNumber = sap.ui.getCore().byId("rfqNumber");
            if (oRFQNumber) {
                oRFQNumber.setText(sCurrentRFQNumber);
            }

            // Populate supplier details
            populateSupplierDetailsInRFQ(oSupplier);

            // Load and populate products
            loadSupplierProductsForRFQ(oSupplier);
        }

        function populateSupplierDetailsInRFQ(oSupplier) {
            var oSupplierDetailsBox = sap.ui.getCore().byId("rfqSupplierDetails");
            if (oSupplierDetailsBox) {
                oSupplierDetailsBox.removeAllItems();

                // Create supplier details layout
                var oSupplierInfo = new sap.m.VBox({
                    items: [
                        new sap.m.HBox({
                            items: [
                                new sap.m.Label({text: "Contact:", class: "sapUiTinyMarginEnd"}),
                                new sap.m.Text({text: oSupplier.contact})
                            ],
                            class: "sapUiTinyMarginBottom"
                        }),
                        new sap.m.HBox({
                            items: [
                                new sap.m.Label({text: "Location:", class: "sapUiTinyMarginEnd"}),
                                new sap.m.Text({text: oSupplier.location})
                            ],
                            class: "sapUiTinyMarginBottom"
                        }),
                        new sap.m.HBox({
                            items: [
                                new sap.m.Label({text: "Category:", class: "sapUiTinyMarginEnd"}),
                                new sap.m.Text({text: oSupplier.category})
                            ],
                            class: "sapUiTinyMarginBottom"
                        }),
                        new sap.m.HBox({
                            items: [
                                new sap.m.Label({text: "Material:", class: "sapUiTinyMarginEnd"}),
                                new sap.m.Text({text: oSupplier.material})
                            ],
                            class: "sapUiTinyMarginBottom"
                        }),
                        new sap.m.HBox({
                            items: [
                                new sap.m.Label({text: "Lead Time:", class: "sapUiTinyMarginEnd"}),
                                new sap.m.Text({text: oSupplier.leadTime})
                            ],
                            class: "sapUiTinyMarginBottom"
                        })
                    ]
                });

                oSupplierDetailsBox.addItem(oSupplierInfo);
            }
        }

        function loadSupplierProductsForRFQ(oSupplier) {
            // Fetch supplier products from backend
            fetch(`/odata/v4/procurement/SupplierProducts?$filter=supplier_ID eq ${oSupplier.ID}`)
                .then(response => response.json())
                .then(data => {
                    var aProducts = data.value || [];
                    populateProductsTable(aProducts);
                })
                .catch(error => {
                    console.error("Error loading supplier products:", error);
                    // Create sample products if none found
                    var aSampleProducts = [
                        {ID: "P1", name: oSupplier.material + " - Standard", description: "Standard quality " + oSupplier.material, price: "100"},
                        {ID: "P2", name: oSupplier.material + " - Premium", description: "Premium quality " + oSupplier.material, price: "150"},
                        {ID: "P3", name: oSupplier.material + " - Economy", description: "Economy grade " + oSupplier.material, price: "75"}
                    ];
                    populateProductsTable(aSampleProducts);
                });
        }

        function populateProductsTable(aProducts) {
            var oTable = sap.ui.getCore().byId("rfqProductsTable");
            if (oTable) {
                oTable.removeAllItems();
                aSelectedProducts = []; // Reset selected products

                aProducts.forEach(function(oProduct, index) {
                    var oRow = new sap.m.ColumnListItem({
                        cells: [
                            new sap.m.CheckBox({
                                selected: false,
                                select: function(oEvent) {
                                    updateProductSelection(oProduct, oEvent.getParameter("selected"), index);
                                }
                            }),
                            new sap.m.VBox({
                                items: [
                                    new sap.m.Text({text: oProduct.name, class: "sapUiMediumMarginBottom"}),
                                    new sap.m.Text({text: oProduct.description, class: "sapUiTinyText"})
                                ]
                            }),
                            new sap.m.Input({
                                id: "productUnits_" + index,
                                type: "Number",
                                value: "1",
                                width: "80px",
                                enabled: false,
                                liveChange: function() {
                                    updatePricing();
                                }
                            }),
                            new sap.m.Text({
                                id: "productPrice_" + index,
                                text: "$" + oProduct.price
                            }),
                            new sap.m.Text({
                                id: "productTotal_" + index,
                                text: "$" + oProduct.price
                            })
                        ]
                    });
                    oTable.addItem(oRow);
                });
            }
        }

        function updateProductSelection(oProduct, bSelected, iIndex) {
            console.log('üì¶ Product selection changed:', oProduct.name, 'Selected:', bSelected, 'Index:', iIndex);
            var oUnitsInput = sap.ui.getCore().byId("productUnits_" + iIndex);

            if (bSelected) {
                // Add to selected products
                aSelectedProducts.push({
                    ...oProduct,
                    index: iIndex,
                    units: 1
                });
                console.log('‚úÖ Added product to selection. Total selected:', aSelectedProducts.length);
                if (oUnitsInput) {
                    oUnitsInput.setEnabled(true);
                }
            } else {
                // Remove from selected products
                aSelectedProducts = aSelectedProducts.filter(p => p.index !== iIndex);
                console.log('‚ùå Removed product from selection. Total selected:', aSelectedProducts.length);
                if (oUnitsInput) {
                    oUnitsInput.setEnabled(false);
                    oUnitsInput.setValue("1");
                }
            }

            console.log('üìã Current selected products:', aSelectedProducts);
            updatePricing();
        }

        function updatePricing() {
            var oPricingBox = sap.ui.getCore().byId("rfqPricing");
            if (!oPricingBox) return;

            oPricingBox.removeAllItems();

            var fSubtotal = 0;

            // Update selected products pricing
            aSelectedProducts.forEach(function(oProduct) {
                var oUnitsInput = sap.ui.getCore().byId("productUnits_" + oProduct.index);
                var iTotalInput = sap.ui.getCore().byId("productTotal_" + oProduct.index);

                if (oUnitsInput) {
                    var iUnits = parseInt(oUnitsInput.getValue()) || 1;
                    var fPrice = parseFloat(oProduct.price) || 0;
                    var fTotal = iUnits * fPrice;

                    // Update product total in table
                    if (iTotalInput) {
                        iTotalInput.setText("$" + fTotal.toFixed(2));
                    }

                    // Add to pricing breakdown
                    oPricingBox.addItem(new sap.m.Text({
                        text: oProduct.name + " (" + iUnits + " units): $" + fTotal.toFixed(2),
                        class: "sapUiTinyMarginBottom"
                    }));

                    fSubtotal += fTotal;
                }
            });

            if (aSelectedProducts.length > 0) {
                // Calculate tax (10%)
                var fTax = fSubtotal * 0.10;
                var fShipping = 40; // Default shipping cost
                var fTotal = fSubtotal + fTax + fShipping;

                // Add tax and shipping
                oPricingBox.addItem(new sap.m.Text({
                    text: "Tax (10%): $" + fTax.toFixed(2),
                    class: "sapUiTinyMarginBottom sapUiMediumMarginTop"
                }));
                oPricingBox.addItem(new sap.m.Text({
                    text: "Shipping: $" + fShipping.toFixed(2),
                    class: "sapUiTinyMarginBottom"
                }));
                oPricingBox.addItem(new sap.m.Text({
                    text: "Total Estimated: $" + fTotal.toFixed(2),
                    class: "sapUiMediumMarginTop"
                }).addStyleClass("sapThemeHighlight-asColor"));
            } else {
                oPricingBox.addItem(new sap.m.Text({
                    text: "Please select products to see pricing",
                    class: "sapUiTinyMarginBottom"
                }));
            }
        }

        function placeOrderFromRFQ() {
            console.log('üöÄ placeOrderFromRFQ called');
            console.log('üìã Current RFQ Number:', sCurrentRFQNumber);
            console.log('üè≠ Current RFQ Supplier:', oCurrentRFQSupplier);
            console.log('üì¶ Selected Products:', aSelectedProducts);

            // Validate that products are selected
            if (aSelectedProducts.length === 0) {
                console.log('‚ùå No products selected');
                sap.m.MessageToast.show("Please select at least one product");
                return;
            }

            console.log('‚úÖ Validation passed, proceeding with order...');

            // Calculate total for confirmation
            var fTotal = 0;
            var sItemsSummary = "";

            aSelectedProducts.forEach(function(oProduct) {
                var oUnitsInput = sap.ui.getCore().byId("productUnits_" + oProduct.index);
                var iUnits = parseInt(oUnitsInput.getValue()) || 1;
                var fPrice = parseFloat(oProduct.price) || 0;
                var fItemTotal = iUnits * fPrice;
                fTotal += fItemTotal;
                sItemsSummary += oProduct.name + " (" + iUnits + " units)\n";
            });

            var fTax = fTotal * 0.10;
            var fShipping = 40;
            var fGrandTotal = fTotal + fTax + fShipping;

            // Confirm order placement using native confirm dialog
            var confirmMessage = "Are you sure you want to place this order?\n\n" +
                "Supplier: " + oCurrentRFQSupplier.name + "\n" +
                "Items:\n" + sItemsSummary +
                "Total Amount: $" + fGrandTotal.toFixed(2);

            console.log('üîî Showing confirmation dialog...');

            if (confirm(confirmMessage)) {
                console.log('‚úÖ User confirmed order placement');
                processOrderPlacement();
            } else {
                console.log('‚ùå User cancelled order placement');
                sap.m.MessageToast.show("Order cancelled");
            }
        }

        function processOrderPlacement() {
            // Process each selected product as a separate material entry
            var aPromises = [];

            aSelectedProducts.forEach(function(oProduct) {
                var oUnitsInput = sap.ui.getCore().byId("productUnits_" + oProduct.index);
                var iUnits = parseInt(oUnitsInput.getValue()) || 1;
                var fPrice = parseFloat(oProduct.price) || 0;

                // Create material entry for inventory
                var oMaterialData = {
                    ID: sCurrentRFQNumber + "-" + oProduct.ID, // Use RFQ number as material ID prefix
                    name: oProduct.name,
                    supplierName: oCurrentRFQSupplier.name, // Use supplierName field
                    quantity: iUnits,
                    category: oCurrentRFQSupplier.category,
                    unitPrice: fPrice,
                    currency: "USD",
                    unit: "pcs",
                    description: oProduct.description,
                    location: "Warehouse A",
                    deliveryPeriod: oCurrentRFQSupplier.leadTime // Add delivery period from supplier lead time
                };

                // Call backend to add material
                console.log('üì§ Adding material to backend:', oMaterialData);
                console.log('üì§ Material data as JSON:', JSON.stringify(oMaterialData, null, 2));

                var promise = fetch('/odata/v4/procurement/addMaterial', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(oMaterialData)
                })
                .then(response => {
                    console.log('Response status:', response.status);
                    return response.json();
                })
                .then(result => {
                    console.log('Backend response:', result);
                    return result;
                });

                aPromises.push(promise);
            });

            // Wait for all materials to be added
            Promise.all(aPromises)
                .then(results => {
                    var iSuccessCount = results.filter(r => r.success).length;
                    var iTotalCount = results.length;

                    if (iSuccessCount === iTotalCount) {
                        // Show simple toast message as requested
                        sap.m.MessageToast.show("Order Placed Successfully!");

                        // Close dialogs
                        oRFQDialog.close();
                        if (oSupplierDetailsDialog) {
                            oSupplierDetailsDialog.close();
                        }

                        // Refresh materials data
                        loadMaterials();

                        // Also show detailed success message
                        setTimeout(function() {
                            var successMessage = "Order placed successfully!\n\n" +
                                "RFQ Number: " + sCurrentRFQNumber + "\n" +
                                "Supplier: " + oCurrentRFQSupplier.name + "\n" +
                                "Items Added: " + iTotalCount + "\n" +
                                "Status: Processing\n" +
                                "Delivery Period: " + oCurrentRFQSupplier.leadTime;

                            alert(successMessage);
                        }, 500);
                    } else {
                        var warningMessage = "Order partially completed!\n\n" +
                            "Successfully added: " + iSuccessCount + " of " + iTotalCount + " items\n" +
                            "Please check inventory for details.";

                        sap.m.MessageToast.show("Partial success: " + iSuccessCount + " of " + iTotalCount + " items added");
                        alert(warningMessage);
                    }
                })
                .catch(error => {
                    console.error("Error placing order:", error);
                    sap.m.MessageToast.show("Error placing order. Please try again.");
                    alert("Error placing order: " + error.message + "\n\nPlease check the console for details and try again.");
                });
        }

        function placeDirectOrder(oSupplier) {
            sap.m.MessageBox.confirm(
                "Are you sure you want to place a direct order with " + oSupplier.name + "?",
                {
                    title: "Confirm Order",
                    actions: [sap.m.MessageBox.Action.YES, sap.m.MessageBox.Action.NO],
                    emphasizedAction: sap.m.MessageBox.Action.YES,
                    onClose: function(sAction) {
                        if (sAction === sap.m.MessageBox.Action.YES) {
                            // Add to inventory (simulate)
                            var oNewMaterial = {
                                ID: Date.now(),
                                name: "Order from " + oSupplier.name,
                                category: oSupplier.category,
                                quantity: 1,
                                price: "‚Çπ50,000",
                                supplier: oSupplier.name,
                                status: "Ordered"
                            };

                            // Add to materials model
                            var oModel = sap.ui.getCore().getModel();
                            var aMaterials = oModel.getProperty("/materials") || [];
                            aMaterials.push(oNewMaterial);
                            oModel.setProperty("/materials", aMaterials);
                            oModel.setProperty("/materialsCount", aMaterials.length);

                            sap.m.MessageBox.success(
                                "Order placed successfully!\n\n" +
                                "Order ID: ORD-" + oNewMaterial.ID + "\n" +
                                "Supplier: " + oSupplier.name + "\n" +
                                "Status: Processing\n" +
                                "Expected Delivery: 7-10 business days",
                                {
                                    title: "Order Confirmed",
                                    onClose: function() {
                                        oSupplierDetailsDialog.close();
                                        oOrderManuallyDialog.close();

                                        // Refresh materials count on tile
                                        updateMaterialsTileCount();
                                    }
                                }
                            );
                        }
                    }
                }
            );
        }

        function updateMaterialsTileCount() {
            var oModel = sap.ui.getCore().getModel();
            var iCount = oModel.getProperty("/materialsCount") || 0;

            // Update the materials tile if it exists
            setTimeout(() => {
                var oMaterialsTile = sap.ui.getCore().byId("materialsTile");
                if (oMaterialsTile) {
                    var oTileContent = oMaterialsTile.getTileContent()[0];
                    if (oTileContent && oTileContent.getContent()) {
                        oTileContent.getContent().setValue(iCount.toString());
                    }
                }
            }, 100);
        }



        function extractChatHistory() {
            var oChatContainer = sap.ui.getCore().byId("aiChatContainer");
            if (!oChatContainer || oChatContainer.getItems().length === 0) {
                sap.m.MessageToast.show("No chat history to extract");
                return;
            }

            var sChatContent = "# AI Procurement Chat History\n\n";
            sChatContent += "**Date:** " + new Date().toLocaleString() + "\n\n";

            oChatContainer.getItems().forEach(function(oItem) {
                if (oItem.hasStyleClass && oItem.hasStyleClass("userMessage")) {
                    sChatContent += "**User:** ";
                    var oText = oItem.getItems()[0];
                    if (oText && oText.getHtmlText) {
                        sChatContent += oText.getHtmlText().replace(/<[^>]*>/g, '') + "\n\n";
                    }
                } else if (oItem.hasStyleClass && oItem.hasStyleClass("assistantMessage")) {
                    sChatContent += "**AI Assistant:** ";
                    var oText = oItem.getItems()[1];
                    if (oText && oText.getHtmlText) {
                        sChatContent += oText.getHtmlText().replace(/<[^>]*>/g, '') + "\n\n";
                    }
                }
            });

            // Create download
            var element = document.createElement('a');
            element.setAttribute('href', 'data:text/markdown;charset=utf-8,' + encodeURIComponent(sChatContent));
            element.setAttribute('download', 'chat_history_' + new Date().toISOString().slice(0,10) + '.md');
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);

            sap.m.MessageToast.show("Chat history downloaded as .md file");
        }

        function sendAIChatMessage() {
            var oInput = sap.ui.getCore().byId("aiChatInput");
            if (oInput) {
                var sMessage = oInput.getValue().trim();

                if (!sMessage) {
                    sap.m.MessageToast.show("üí¨ Please enter a message");
                    return;
                }

                addAIChatMessage(sMessage, "user");
                oInput.setValue("");

                // Send to Gemini AI
                sendToGemini(sMessage);
            }
        }



        function addAIChatMessage(sMessage, sType) {
            var oChatContainer = sap.ui.getCore().byId("aiChatContainer");

            if (sType === "user") {
                // User message - right aligned with label and tail
                var oUserBubble = new sap.ui.core.HTML({
                    content: `
                        <div class="messageRow user">
                            <div class="messageLabel">You</div>
                            <div class="messageBubble user">
                                <div style="margin-bottom: 4px;">${sMessage}</div>
                                <div class="messageTime">${new Date().toLocaleTimeString()}</div>
                            </div>
                        </div>
                    `
                });
                oChatContainer.addItem(oUserBubble);

            } else if (sType === "assistant") {
                // Assistant message - left aligned with label and tail
                var oAssistantBubble = new sap.ui.core.HTML({
                    content: `
                        <div class="messageRow assistant">
                            <div class="messageLabel">AI Assistant</div>
                            <div class="messageBubble assistant">
                                <div style="margin-bottom: 4px;">${sMessage}</div>
                                <div class="messageTime">${new Date().toLocaleTimeString()}</div>
                            </div>
                        </div>
                    `
                });
                oChatContainer.addItem(oAssistantBubble);

            } else if (sType === "typing") {
                // Typing indicator with label
                var oTypingBubble = new sap.ui.core.HTML({
                    content: `
                        <div class="messageRow assistant">
                            <div class="messageLabel">AI Assistant</div>
                            <div class="typingIndicator">
                                <div style="display: flex; align-items: center;">
                                    <span style="margin-right: 8px;">ü§ñ</span>
                                    <span>AI is thinking...</span>
                                </div>
                            </div>
                        </div>
                    `
                });
                oChatContainer.addItem(oTypingBubble);
                return oTypingBubble;
            }

            // Auto-scroll to bottom
            setTimeout(() => {
                scrollChatToBottom();
            }, 100);
        }

        function scrollChatToBottom() {
            var oChatContainer = sap.ui.getCore().byId("aiChatContainer");
            if (oChatContainer) {
                var oScrollContainer = oChatContainer.getParent();
                if (oScrollContainer && oScrollContainer.scrollTo) {
                    oScrollContainer.scrollTo(0, oScrollContainer.getScrollHeight());
                }
            }
        }

        function clearChatHistory() {
            var oChatContainer = sap.ui.getCore().byId("aiChatContainer");
            if (oChatContainer) {
                oChatContainer.removeAllItems();
                sap.m.MessageToast.show("üóëÔ∏è Chat history cleared");
            }
        }

        function initializeAIChat() {
            // Initialize chat session with Gemini
            initializeChatSession();
        }

        // Initialize chat session
        window.chatSessionId = null;
        window.geminiConnected = false;

        function initializeChatSession() {
            console.log("Initializing chat session...");

            fetch('/odata/v4/procurement/initChatSession', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                console.log("Chat session initialized:", data);
                window.chatSessionId = data.sessionId;
                window.geminiConnected = true;
                updateGeminiStatus(true);

                // Add welcome message
                if (data.welcomeMessage) {
                    addAIChatMessage(data.welcomeMessage, "assistant");
                }
            })
            .catch(error => {
                console.error("Error initializing chat session:", error);
                window.geminiConnected = false;
                updateGeminiStatus(false);
                addAIChatMessage("Welcome! I'm your AI procurement assistant. How can I help you today?", "assistant");
            });
        }

        function updateGeminiStatus(isConnected) {
            var oStatusCard = sap.ui.getCore().byId("statusCard");
            if (oStatusCard) {
                var aItems = oStatusCard.getContent()[0].getItems();
                if (aItems && aItems.length > 0) {
                    var oGeminiStatus = aItems[0];
                    if (isConnected) {
                        oGeminiStatus.setText("Gemini 1.5 Flash Connected");
                        oGeminiStatus.setState("Success");
                        oGeminiStatus.setIcon("sap-icon://connected");
                    } else {
                        oGeminiStatus.setText("Gemini 1.5 Flash Not Connected");
                        oGeminiStatus.setState("Error");
                        oGeminiStatus.setIcon("sap-icon://disconnected");
                    }
                }
            }
        }

        function checkGeminiConnection() {
            fetch('/odata/v4/procurement/initChatSession', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    window.geminiConnected = true;
                    updateGeminiStatus(true);
                } else {
                    window.geminiConnected = false;
                    updateGeminiStatus(false);
                }
            })
            .catch(error => {
                window.geminiConnected = false;
                updateGeminiStatus(false);
            });
        }

        function sendToGemini(sUserMessage) {
            // Show typing indicator
            var oTypingMessage = addAIChatMessage("", "typing");

            // Send message to Gemini AI
            if (!window.chatSessionId) {
                console.warn("No chat session, initializing...");
                initializeChatSession();
                setTimeout(() => sendMessageToAI(sUserMessage, oTypingMessage), 1000);
            } else {
                sendMessageToAI(sUserMessage, oTypingMessage);
            }
        }

        function sendMessageToAI(message, typingMessage) {
            fetch('/odata/v4/procurement/sendChatMessage', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    sessionId: window.chatSessionId,
                    message: message
                })
            })
            .then(response => {
                if (response.ok) {
                    window.geminiConnected = true;
                    updateGeminiStatus(true);
                    return response.json();
                } else {
                    window.geminiConnected = false;
                    updateGeminiStatus(false);
                    throw new Error('Network response was not ok');
                }
            })
            .then(data => {
                console.log("AI response received:", data);

                // Remove typing indicator
                if (typingMessage) {
                    var oChatContainer = sap.ui.getCore().byId("aiChatContainer");
                    oChatContainer.removeItem(typingMessage);
                }

                if (data.success && data.response) {
                    addAIChatMessage(data.response, "assistant");
                } else if (data.fallbackResponse) {
                    addAIChatMessage(data.fallbackResponse, "assistant");
                } else {
                    addAIChatMessage("I apologize, but I'm having trouble right now. Please try again.", "assistant");
                }
            })
            .catch(error => {
                console.error("Error sending message to AI:", error);
                window.geminiConnected = false;
                updateGeminiStatus(false);

                // Remove typing indicator
                if (typingMessage) {
                    var oChatContainer = sap.ui.getCore().byId("aiChatContainer");
                    oChatContainer.removeItem(typingMessage);
                }

                // Fallback to smart response
                var response = generateLocalResponse(message);
                addAIChatMessage(response, "assistant");
            });
        }

        async function getProcurementContext() {
            try {
                // Get current materials count
                const materialsResponse = await fetch('/odata/v4/procurement/Materials?$top=5');
                const materialsData = await materialsResponse.json();

                // Get current suppliers count
                const suppliersResponse = await fetch('/odata/v4/procurement/Suppliers?$top=5');
                const suppliersData = await suppliersResponse.json();

                return {
                    materialsCount: oModel.getProperty("/materialsCount") || 0,
                    suppliersCount: oModel.getProperty("/suppliersCount") || 0,
                    recentMaterials: materialsData.value || [],
                    topSuppliers: suppliersData.value || []
                };
            } catch (error) {
                console.error('Error getting context:', error);
                return {
                    materialsCount: 0,
                    suppliersCount: 0,
                    recentMaterials: [],
                    topSuppliers: []
                };
            }
        }

        function generateLocalResponse(sUserMessage) {
            var sMessage = sUserMessage.toLowerCase();

            if (sMessage.includes("laptop") || sMessage.includes("computer")) {
                return "<strong>Laptop Suppliers Found:</strong><br/><br/><strong>TechCorp India</strong><br/>‚Ä¢ Price: ‚Çπ42,000/unit<br/>‚Ä¢ Delivery: 7 days<br/>‚Ä¢ Rating: 4.8/5<br/><br/><strong>Digital Solutions</strong><br/>‚Ä¢ Price: ‚Çπ48,500/unit<br/>‚Ä¢ Delivery: 5 days<br/>‚Ä¢ Rating: 4.6/5<br/><br/><strong>CompuWorld</strong><br/>‚Ä¢ Price: ‚Çπ45,200/unit<br/>‚Ä¢ Delivery: 10 days<br/>‚Ä¢ Rating: 4.5/5<br/><br/>Would you like me to create a PO or send an RFQ?";
            } else if (sMessage.includes("supplier")) {
                return "<strong>Top-Rated Suppliers:</strong><br/><br/><strong>TechCorp India</strong> (4.8/5)<br/>Electronics & Technology<br/><br/><strong>Furniture Plus</strong> (4.6/5)<br/>Office Furniture & Equipment<br/><br/><strong>Stationery World</strong> (4.7/5)<br/>Office Supplies & Materials<br/><br/>Which category interests you? I can provide detailed supplier information.";
            } else if (sMessage.includes("price") || sMessage.includes("cost")) {
                return "<strong>Market Price Analysis:</strong><br/><br/><strong>Current Trends:</strong><br/>‚Ä¢ Electronics: +5% this quarter<br/>‚Ä¢ Construction: Stable pricing<br/>‚Ä¢ Office supplies: -2% decrease<br/>‚Ä¢ Manufacturing: +3% increase<br/><br/><strong>Recommendations:</strong><br/>‚Ä¢ Best time to buy office supplies<br/>‚Ä¢ Electronics prices expected to stabilize<br/>‚Ä¢ Consider bulk orders for construction materials<br/><br/>Which specific materials need pricing analysis?";
            } else if (sMessage.includes("inventory") || sMessage.includes("stock")) {
                return "<strong>Current Inventory Status:</strong><br/><br/><strong>Overview:</strong><br/>‚Ä¢ Total materials: 15 items<br/>‚Ä¢ Active suppliers: 3000+<br/>‚Ä¢ Categories covered: 4<br/><br/><strong>Alerts:</strong><br/>‚Ä¢ 3 items with low stock<br/>‚Ä¢ 2 items need reordering<br/>‚Ä¢ 12 items well-stocked<br/><br/>Would you like details on specific categories or materials? I can help you manage your inventory efficiently.";
            } else {
                return `<strong>I understand you're asking about:</strong> "${sUserMessage}"<br/><br/><strong>I can help you with:</strong><br/>‚Ä¢ Finding suppliers and pricing<br/>‚Ä¢ Creating purchase orders<br/>‚Ä¢ Sending RFQs<br/>‚Ä¢ Checking inventory<br/>‚Ä¢ Compliance verification<br/>‚Ä¢ Market analysis<br/>‚Ä¢ Cost optimization<br/><br/>Try using the quick action buttons above or ask me something specific about procurement!`;
            }
        }

        function showError(sMessage) {
            document.getElementById("content").innerHTML =
                "<div style='padding: 20px; text-align: center;'>" +
                "<h2>Error Loading Application</h2>" +
                "<p>" + sMessage + "</p>" +
                "<button onclick='location.reload()'>Reload Page</button>" +
                "</div>";
        }
        
        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
        });
    </script>
</body>
</html>
